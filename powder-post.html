<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Powder Post</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/gif.js/0.2.0/gif.js"></script>
<style>
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:'Inter',sans-serif;background:linear-gradient(160deg,#0a1628,#0f2040 50%,#0a1628);color:#d8eaf8;min-height:100vh;display:flex;flex-direction:column;align-items:center;padding:28px 16px 40px}
h1{font-family:'Playfair Display',serif;font-size:2.4rem;color:#f0f8ff;letter-spacing:-.5px;margin-bottom:4px}
.subtitle{color:#6a90b0;font-size:.88rem;margin-bottom:22px}
.panel{width:100%;max-width:820px;background:rgba(15,30,55,.7);border:1px solid rgba(80,140,200,.18);border-radius:14px;padding:16px 18px;display:flex;flex-direction:column;gap:12px;margin-bottom:14px}
.row{display:flex;flex-wrap:wrap;gap:12px;align-items:flex-end}
.fg{display:flex;flex-direction:column;gap:5px}
.fg.grow{flex:1;min-width:180px}
label{font-size:.7rem;font-weight:600;text-transform:uppercase;letter-spacing:.08em;color:#5a8ab0}
select,input[type=text]{background:#0d2038;border:1px solid #1e4060;color:#d8eaf8;padding:9px 12px;border-radius:8px;font-family:'Inter',sans-serif;font-size:.88rem;outline:none;transition:border-color .2s;width:100%}
select:focus,input[type=text]:focus{border-color:#3a8cd0}
.btns{display:flex;gap:8px;flex-wrap:wrap}
button{padding:10px 22px;border:none;border-radius:8px;font-family:'Inter',sans-serif;font-weight:600;font-size:.9rem;cursor:pointer;transition:all .2s;white-space:nowrap}
.btn-go{background:#1a6ec0;color:#fff}.btn-go:hover{background:#2280dc}.btn-go:disabled{background:#12304a;color:#2a5070;cursor:default}
.btn-export{background:#0d3020;color:#4dcc80;border:1px solid #1a6035}.btn-export:hover{background:#155030}.btn-export:disabled{opacity:.35;cursor:default}
.canvas-wrap{position:relative;border-radius:12px;overflow:hidden;width:100%;max-width:820px;box-shadow:0 24px 64px rgba(0,0,0,.6),0 0 0 1px rgba(80,140,200,.15)}
canvas{display:block;width:100%;height:auto}
.weather-badge{position:absolute;top:10px;right:10px;background:rgba(0,0,0,.45);backdrop-filter:blur(8px);border-radius:20px;padding:4px 13px;font-size:.78rem;color:#fff;display:none;border:1px solid rgba(255,255,255,.12)}
.progress-wrap{width:100%;max-width:820px;height:3px;background:#0d2038;border-radius:2px;margin-top:10px;overflow:hidden}
.progress-fill{height:100%;background:#2a8cd0;border-radius:2px;width:0%;transition:width .12s}
.status{font-size:.78rem;color:#4a7090;margin-top:7px;min-height:18px;text-align:center}
.home-btn{position:fixed;top:14px;left:16px;display:flex;align-items:center;gap:6px;padding:7px 13px;background:rgba(15,30,55,.75);border:1px solid rgba(80,140,200,.2);border-radius:20px;color:#6a90b0;font-family:'Inter',sans-serif;font-size:.78rem;font-weight:500;text-decoration:none;transition:all .2s;backdrop-filter:blur(8px);z-index:100}
.home-btn:hover{color:#a8caec;border-color:rgba(80,140,200,.45);background:rgba(20,40,70,.85)}
.home-btn svg{opacity:.7}
.swatches{display:flex;gap:7px;flex-wrap:wrap;align-items:center}
.swatch{width:22px;height:22px;border-radius:50%;border:2px solid transparent;cursor:pointer;transition:transform .15s,border-color .15s;flex-shrink:0}
.swatch:hover{transform:scale(1.15)}
.swatch.active{border-color:#fff;box-shadow:0 0 0 1px rgba(255,255,255,.3);transform:scale(1.15)}
@keyframes powderPulse{0%,100%{opacity:.88}50%{opacity:1}}
.powder-alert{position:absolute;top:10px;left:10px;background:rgba(10,40,110,.84);backdrop-filter:blur(8px);border:1px solid rgba(120,180,255,.4);border-radius:20px;padding:4px 14px;font-size:.78rem;color:#b8ddff;font-family:'Inter',sans-serif;font-weight:600;letter-spacing:.04em;display:none;animation:powderPulse 2.2s ease-in-out infinite}
</style>
</head>
<body>
<a href="https://justinadong.com" class="home-btn">
  <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
  justinadong.com
</a>
<h1>â›· Powder Post</h1>
<p class="subtitle">Pick a resort Â· fetch the weather Â· carve your message into the snow</p>

<div class="panel">
  <div class="row">
    <div class="fg" style="min-width:210px">
      <label>Resort</label>
      <select id="resort">
        <optgroup label="Alps">
          <option value="46.0956,7.2272">Verbier</option><option value="46.0207,7.7491">Zermatt</option>
          <option value="45.9237,6.8694">Chamonix</option><option value="46.4985,9.8355">St. Moritz</option>
          <option value="45.4148,6.6340">Courchevel</option><option value="45.4036,6.5619">MÃ©ribel</option>
          <option value="45.4483,6.9794">Val d'IsÃ¨re</option><option value="45.5688,6.8152">Les Arcs</option>
          <option value="45.5048,6.6779">La Plagne</option><option value="45.4693,6.9020">Tignes</option>
          <option value="45.8570,6.6160">MegÃ¨ve</option><option value="46.0009,6.6822">Flaine</option>
          <option value="46.1783,6.7097">Morzine</option><option value="46.1925,6.7759">Avoriaz</option>
          <option value="46.1575,6.6683">Les Gets</option><option value="46.1091,7.9285">Saas-Fee</option>
          <option value="46.6244,8.0411">Grindelwald</option><option value="46.6081,7.9218">Wengen</option>
          <option value="46.8028,9.8374">Davos</option><option value="46.8735,9.8787">Klosters</option>
          <option value="46.5404,12.1357">Cortina d'Ampezzo</option><option value="45.7996,6.9691">Courmayeur</option>
          <option value="45.9389,7.7316">Cervinia</option><option value="46.2305,10.8279">Madonna di Campiglio</option>
          <option value="47.4464,12.3927">KitzbÃ¼hel</option><option value="47.1281,10.2689">St. Anton</option>
          <option value="47.2082,10.1416">Lech</option><option value="46.9994,10.2891">Ischgl</option>
          <option value="46.9610,10.9394">SÃ¶lden</option><option value="47.1666,11.8672">Mayrhofen</option>
          <option value="47.1080,13.1346">Bad Gastein</option><option value="47.3878,12.6379">Saalbach</option>
          <option value="47.3924,13.6893">Schladming</option><option value="46.5378,10.1366">Livigno</option>
          <option value="42.5463,1.7101">Andorra Grandvalira</option>
        </optgroup>
        <optgroup label="Northeast USA">
          <option value="44.5290,-72.7823">Stowe</option><option value="43.6775,-72.7812">Killington</option>
          <option value="44.1372,-72.8951">Sugarbush</option><option value="44.1892,-72.8615">Mad River Glen</option>
          <option value="43.4036,-72.5237">Okemo</option><option value="43.1125,-72.9076">Stratton</option>
          <option value="42.9593,-72.9223">Mount Snow</option><option value="43.2094,-72.9618">Bromley</option>
          <option value="44.4133,-72.8704">Bolton Valley</option><option value="44.5617,-72.7901">Smugglers' Notch</option>
          <option value="44.4711,-70.8556">Sunday River</option><option value="45.0317,-70.3131">Sugarloaf</option>
          <option value="44.8887,-70.5167">Saddleback</option><option value="44.0356,-71.6246">Loon</option>
          <option value="44.1578,-71.6999">Cannon</option><option value="43.9738,-71.5148">Waterville Valley</option>
          <option value="44.2619,-71.4428">Bretton Woods</option><option value="44.2597,-71.2388">Wildcat</option>
          <option value="42.2020,-74.2285">Hunter</option><option value="42.2994,-74.2566">Windham</option>
          <option value="42.1556,-74.5079">Belleayre</option><option value="44.3658,-73.9027">Whiteface</option>
          <option value="43.6778,-74.0009">Gore</option><option value="42.5095,-73.3165">Jiminy Peak</option>
          <option value="42.4986,-71.8881">Wachusett</option><option value="42.0959,-73.3685">Ski Butternut</option>
        </optgroup>
        <optgroup label="North America (West)">
          <option value="50.1163,-122.9574">Whistler</option><option value="39.1911,-106.8175">Aspen</option>
          <option value="43.5875,-110.8278">Jackson Hole</option><option value="40.6514,-111.5080">Park City</option>
          <option value="37.6308,-119.0326">Mammoth</option><option value="39.6433,-106.3781">Vail</option>
          <option value="51.1784,-115.5708">Banff</option><option value="51.0160,-118.1960">Revelstoke</option>
        </optgroup>
        <optgroup label="Japan">
          <option value="42.8042,140.6872">Niseko</option><option value="36.6986,137.8614">Hakuba</option>
        </optgroup>
        <optgroup label="Southern Hemisphere">
          <option value="-45.0312,168.6626">Queenstown</option>
        </optgroup>
      </select>
    </div>
    <div class="fg grow">
      <label>Message (max 20 chars)</label>
      <input type="text" id="message" value="SEND POWDER!" maxlength="20" placeholder="Your message...">
    </div>
    <div class="btns">
      <button class="btn-go" id="btnGo">Go â–¶</button>
      <button class="btn-export" id="btnExport" disabled>Export GIF â†“</button>
    </div>
  </div>
  <div class="row" style="align-items:center">
    <div class="fg">
      <label>Outfit color</label>
      <div class="swatches" id="swatches">
        <div class="swatch active" data-color="#cc2020" style="background:#cc2020" title="Red"></div>
        <div class="swatch" data-color="#d06010" style="background:#d06010" title="Orange"></div>
        <div class="swatch" data-color="#1848c0" style="background:#1848c0" title="Blue"></div>
        <div class="swatch" data-color="#0f6e30" style="background:#0f6e30" title="Green"></div>
        <div class="swatch" data-color="#b82868" style="background:#b82868" title="Pink"></div>
        <div class="swatch" data-color="#601ac0" style="background:#601ac0" title="Purple"></div>
        <div class="swatch" data-color="#1a1a3a" style="background:#1a1a3a;border:1px solid rgba(255,255,255,.15)" title="Navy"></div>
        <div class="swatch" data-color="#d8d8d8" style="background:#d8d8d8" title="White"></div>
      </div>
    </div>
  </div>
</div>

<div class="canvas-wrap">
  <canvas id="canvas" width="800" height="450"></canvas>
  <div class="weather-badge" id="weatherBadge"></div>
  <div class="powder-alert" id="powderAlert">POWDER ALERT â„ï¸</div>
</div>
<div class="progress-wrap"><div class="progress-fill" id="progressFill"></div></div>
<p class="status" id="status">Pick a resort, type your message, and hit Go.</p>

<script>
// â”€â”€â”€ roundRect polyfill â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if(!CanvasRenderingContext2D.prototype.roundRect){
  CanvasRenderingContext2D.prototype.roundRect=function(x,y,w,h,r){
    r=Math.min(r,w/2,h/2);this.beginPath();this.moveTo(x+r,y);
    this.arcTo(x+w,y,x+w,y+h,r);this.arcTo(x+w,y+h,x,y+h,r);
    this.arcTo(x,y+h,x,y,r);this.arcTo(x,y,x+w,y,r);this.closePath();
  };
}

// â”€â”€â”€ canvas / constants â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const canvas=document.getElementById('canvas');
const ctx=canvas.getContext('2d');
const W=800,H=450;
const OWM_KEY='9551a6d3ee093363bf75dcafc0d3de77';

// Sun is from upper-right â†’ shadows point lower-left
const SHADOW_DX=-0.55, SHADOW_DY=0.85;

// â”€â”€â”€ seeded RNG â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function mkRng(seed){
  let s=seed|0;
  return function(){s^=s<<13;s^=s>>17;s^=s<<5;return(s>>>0)/0x100000000;};
}

// â”€â”€â”€ snow palette â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const SNOW_PAL={
  sunny:  {base:'#f2ede2',hi:'#faf7f0',sh:'#bec8e0'},
  snowing:{base:'#e8eaf2',hi:'#f0f0f8',sh:'#a8b2cc'},
  overcast:{base:'#dcdee6',hi:'#e5e6ec',sh:'#9098b2'},
  storm:  {base:'#c5c8d2',hi:'#ced1d8',sh:'#70789a'},
};

// â”€â”€â”€ offscreen background canvas â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let bgCanvas=null,bgCond=null;
function getBg(cond){
  if(bgCanvas&&bgCond===cond) return bgCanvas;
  bgCanvas=document.createElement('canvas');
  bgCanvas.width=W;bgCanvas.height=H;
  bgCond=cond;
  paintBg(bgCanvas.getContext('2d'),cond);
  return bgCanvas;
}

// â”€â”€â”€ flat top-down snow background â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function paintBg(bx,cond){
  const pal=SNOW_PAL[cond]||SNOW_PAL.sunny;
  const rng=mkRng(0xdeadbeef);

  // 1. base fill
  bx.fillStyle=pal.base; bx.fillRect(0,0,W,H);

  // 2. gentle light gradient â€” sun from upper-right
  const lg=bx.createLinearGradient(W,0,0,H);
  lg.addColorStop(0,'rgba(255,252,245,.07)');
  lg.addColorStop(1,'rgba(90,100,140,.06)');
  bx.fillStyle=lg; bx.fillRect(0,0,W,H);

  // 3. subtle wind-blown surface texture (horizontal micro-streaks)
  for(let i=0;i<220;i++){
    const x=rng()*W, y=rng()*H;
    const len=10+rng()*48, ht=0.8+rng()*1.8;
    const col=rng()<.55?pal.hi:pal.sh;
    bx.save(); bx.globalAlpha=.04+rng()*.06;
    bx.fillStyle=col;
    bx.fillRect(x,y,len,ht);
    bx.restore();
  }

  // 4. faint previous ski tracks (diagonal, like a real used slope)
  //    only show in clear conditions (fresh snow covers old tracks)
  if(cond!=='snowing'&&cond!=='storm'){
    const rng2=mkRng(0xbeef1234);
    bx.save();
    bx.lineCap='round'; bx.strokeStyle=pal.sh; bx.lineWidth=.9;
    for(let i=0;i<13;i++){
      const sx=rng2()*W*1.3-W*.15;
      const sy=-40+rng2()*80;
      const ang=Math.PI*.48+(rng2()-.5)*.35; // mostly downward with variation
      const len=160+rng2()*340;
      const sep=3.5+rng2()*3;
      for(const side of[-1,1]){
        const ox=Math.cos(ang-Math.PI/2)*sep*side;
        const oy=Math.sin(ang-Math.PI/2)*sep*side;
        const mx=sx+Math.cos(ang)*len*.5+(rng2()-.5)*35+ox;
        const my=sy+Math.sin(ang)*len*.5+(rng2()-.5)*15+oy;
        bx.save(); bx.globalAlpha=.12+rng2()*.16;
        bx.beginPath();
        bx.moveTo(sx+ox,sy+oy);
        bx.quadraticCurveTo(mx,my,sx+Math.cos(ang)*len+ox,sy+Math.sin(ang)*len+oy);
        bx.stroke(); bx.restore();
      }
    }
    bx.restore();
  }

  // 5. static scene elements
  paintGondola(bx,cond);
  paintTopDownTrees(bx,cond);
}

// â”€â”€â”€ gondola (top-down: thin cable + suspended cars w/ ground shadows) â”€â”€â”€â”€â”€â”€â”€â”€
function paintGondola(bx,cond){
  const cableY=H*.19;
  const cc=cond==='storm'?'#383838':'#1e1e1e';

  // two haul cables
  for(const dy of[0,2.5]){
    bx.save(); bx.globalAlpha=.55;
    bx.strokeStyle=cc; bx.lineWidth=dy===0?1.5:.7;
    bx.beginPath(); bx.moveTo(0,cableY+dy); bx.lineTo(W,cableY+dy); bx.stroke();
    bx.restore();
  }

  // support towers (seen from above: small T shapes)
  for(const tx of[W*.26,W*.74]){
    bx.save(); bx.globalAlpha=.7;
    bx.fillStyle=cc;
    bx.fillRect(tx-1.5,cableY-16,3,18); // mast
    bx.fillRect(tx-10,cableY-18,20,3);  // cross arm
    bx.restore();
  }

}

// â”€â”€â”€ animated gondola cars (live render, loop leftâ†’right) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const GONDOLA_SPD=0.018; // px/ms â€” one crossing ~44 s
const N_CARS=4;
const GONDOLA_LOOP=W+52;
function drawLiftCars(t){
  const cableY=H*.19,cw=12,ch=8;
  for(let i=0;i<N_CARS;i++){
    const cx=((t*GONDOLA_SPD+i*GONDOLA_LOOP/N_CARS)%GONDOLA_LOOP+GONDOLA_LOOP)%GONDOLA_LOOP-26;
    if(cx<-cw-2||cx>W+cw+2) continue;
    // shadow on snow
    ctx.save();ctx.globalAlpha=.10;ctx.fillStyle='#4050a0';
    ctx.beginPath();ctx.ellipse(cx+SHADOW_DX*18,cableY+SHADOW_DY*18,cw*.75,ch*.6,0,0,Math.PI*2);
    ctx.fill();ctx.restore();
    // hanger wire
    ctx.save();ctx.globalAlpha=.45;ctx.strokeStyle='#1a1a26';ctx.lineWidth=.8;
    ctx.beginPath();ctx.moveTo(cx,cableY);ctx.lineTo(cx,cableY+3);ctx.stroke();ctx.restore();
    // car body
    ctx.fillStyle='#181824';ctx.fillRect(cx-cw/2,cableY+3,cw,ch);
    // window strip
    ctx.fillStyle='rgba(170,205,230,.35)';ctx.fillRect(cx-cw/2+1.5,cableY+5,cw-3,ch-4);
  }
}

// â”€â”€â”€ top-down tree canopies â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// placed in corners, away from text area (center of canvas)
const TREE_DEFS=[
  {x:52,y:52,r:36},{x:736,y:68,r:42},
  {x:36,y:395,r:32},{x:754,y:400,r:38},
  {x:22,y:210,r:24},
];
function paintTopDownTrees(bx,cond){
  const rng=mkRng(0xf00dcafe);
  const storm=cond==='storm', snow=cond==='snowing';
  const snowCol=storm?'rgba(185,200,210,.6)':snow?'rgba(225,235,245,.7)':'rgba(238,248,252,.72)';
  const greens=storm?['#0c1810','#121e14','#162018']:['#132016','#1c2e1e','#243424','#1a2818'];

  for(const t of TREE_DEFS){
    const r=t.r;

    // cast shadow on snow (elongated, lower-left of tree)
    bx.save(); bx.globalAlpha=storm?.12:.2;
    bx.fillStyle='#4a5898';
    bx.beginPath();
    bx.ellipse(t.x+SHADOW_DX*r*.9,t.y+SHADOW_DY*r*.9,r*.55,r*1.05,-0.2,0,Math.PI*2);
    bx.fill(); bx.restore();

    // outer canopy ring (darkest â€” deep shadow within canopy)
    bx.fillStyle=greens[0];
    bx.beginPath(); bx.arc(t.x,t.y,r,0,Math.PI*2); bx.fill();

    // mid canopy
    bx.fillStyle=greens[1];
    bx.beginPath(); bx.arc(t.x,t.y,r*.72,0,Math.PI*2); bx.fill();

    // inner lit area (upper-right catches light)
    bx.fillStyle=greens[2]||greens[1];
    bx.beginPath(); bx.arc(t.x,t.y,r*.46,0,Math.PI*2); bx.fill();

    // radial branch lines
    bx.save(); bx.strokeStyle=greens[0]; bx.lineWidth=1.4; bx.globalAlpha=.7;
    for(let i=0;i<9;i++){
      const a=(i/9)*Math.PI*2;
      bx.beginPath();
      bx.moveTo(t.x+Math.cos(a)*r*.12,t.y+Math.sin(a)*r*.12);
      bx.lineTo(t.x+Math.cos(a)*r*.88,t.y+Math.sin(a)*r*.88);
      bx.stroke();
    }
    bx.restore();

    // snow patches on lit (upper-right) side of canopy
    bx.save(); bx.fillStyle=snowCol;
    for(const[sdx,sdy,sr,sa] of[[.28,-.32,.2,.68],[.08,-.42,.15,.62],[.42,-.12,.13,.6],[-.02,-.3,.11,.55]]){
      bx.globalAlpha=sa+rng()*.15;
      bx.beginPath(); bx.ellipse(t.x+sdx*r,t.y+sdy*r,sr*r,sr*r*.6,0,0,Math.PI*2); bx.fill();
    }
    bx.restore();
  }
}

// â”€â”€â”€ animated background skiers (slide topâ†’bottom continuously) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const SKIER_COLORS=['#cc2020','#c8980e','#1848c0','#c05010','#159838','#b82868','#601ac0'];
const LIVE_BG_SKIERS=(function(){
  const rng=mkRng(0xabcdef12);
  return Array.from({length:5},()=>({
    startX: 70+rng()*(W-140),
    startY: rng()*(H+160),   // staggered entry so they're not all at the top at once
    speed:  0.055+rng()*.04, // px/ms downhill
    amp:    18+rng()*38,     // left-right carving amplitude
    freq:   0.013+rng()*.009,// carving frequency
    phase:  rng()*Math.PI*2,
    col:    SKIER_COLORS[Math.floor(rng()*SKIER_COLORS.length)],
    sz:     0.40+rng()*.18,  // smaller than the main skier
    op:     0.42+rng()*.2,   // semi-transparent so they don't distract
  }));
})();

const WRAP_H=H+170; // total loop distance (canvas + off-screen margins)

function bgSkierY(sk,t){
  return((sk.startY+sk.speed*t)%WRAP_H+WRAP_H)%WRAP_H-85;
}
function bgSkierX(sk,y){
  return sk.startX+sk.amp*Math.sin(y*sk.freq+sk.phase);
}

function drawLiveBgSkiers(t){
  for(const sk of LIVE_BG_SKIERS){
    const cy=bgSkierY(sk,t);
    const cx=bgSkierX(sk,cy);
    if(cy<-85||cy>H+60) continue;
    ctx.save();

    // â”€â”€ ski tracks: reconstruct last ~1.5 s of path â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const trackPts=[];
    for(let dt=1500;dt>=0;dt-=40){
      const py=bgSkierY(sk,t-dt);
      // skip any point from a previous lap (its y would wrap above current cy)
      if(py<=cy&&py>-85) trackPts.push({x:bgSkierX(sk,py),y:py});
    }
    trackPts.push({x:cx,y:cy});
    if(trackPts.length>1){
      ctx.save();
      ctx.lineCap='round';ctx.lineJoin='round';ctx.lineWidth=1.0;
      for(const off of[-2.5,2.5]){
        ctx.beginPath();
        ctx.moveTo(trackPts[0].x+off,trackPts[0].y);
        for(const p of trackPts) ctx.lineTo(p.x+off,p.y);
        ctx.globalAlpha=sk.op*.32;
        ctx.strokeStyle='rgba(90,130,195,.9)';
        ctx.stroke();
      }
      ctx.restore();
    }

    // â”€â”€ skier figure â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // compute travel direction from a point 80 ms ago
    const py2=bgSkierY(sk,t-80);
    const px2=bgSkierX(sk,py2);
    const rot=py2<cy?Math.atan2(cy-py2,cx-px2):Math.PI/2;

    ctx.translate(cx,cy);
    ctx.rotate(rot);
    ctx.globalAlpha=sk.op;
    const s=sk.sz;

    // cast shadow (sun from upper-right)
    ctx.save();ctx.globalAlpha=sk.op*.22;ctx.fillStyle='#3a5090';
    ctx.beginPath();
    ctx.ellipse(SHADOW_DX*s*10,SHADOW_DY*s*10,s*2,s*7,
      Math.atan2(SHADOW_DY,SHADOW_DX),0,Math.PI*2);
    ctx.fill();ctx.restore();

    // skis (two bars along travel direction)
    ctx.fillStyle='#180e04';
    ctx.fillRect(-s*11,-s*1.4,s*22,s*1.1);
    ctx.fillRect(-s*11,s*.4,s*22,s*1.1);

    // jacket
    ctx.fillStyle=sk.col;
    ctx.beginPath();ctx.ellipse(0,0,s*3,s*4.5,0,0,Math.PI*2);ctx.fill();

    // head (at forward end = +x after rotation)
    ctx.fillStyle='#edb898';
    ctx.beginPath();ctx.arc(s*3,0,s*2,0,Math.PI*2);ctx.fill();
    ctx.fillStyle=sk.col;
    ctx.beginPath();ctx.arc(s*3,0,s*2,Math.PI*.5,Math.PI*1.5);ctx.fill();

    ctx.restore();
  }
}

// â”€â”€â”€ vector math â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const vSub=(a,b)=>({x:a.x-b.x,y:a.y-b.y});
const vLen=(a)=>Math.sqrt(a.x*a.x+a.y*a.y);
const vNorm=(a)=>{const l=vLen(a)||1;return{x:a.x/l,y:a.y/l};};
const vPerp=(a)=>({x:-a.y,y:a.x});
function dnoise(x,s){return Math.sin(x*13.456+s*7.89)*Math.cos(x*4.321+s*11.1);}

// â”€â”€â”€ catmull-rom spline â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function spline(pts,steps=9){
  if(pts.length===1) return[pts[0]];
  if(pts.length===2){
    const out=[];
    for(let t=0;t<=steps;t++){const u=t/steps;out.push({x:pts[0].x+(pts[1].x-pts[0].x)*u,y:pts[0].y+(pts[1].y-pts[0].y)*u});}
    return out;
  }
  const p=[pts[0],...pts,pts[pts.length-1]],out=[];
  for(let i=1;i<p.length-2;i++){
    for(let t=0;t<steps;t++){
      const u=t/steps,u2=u*u,u3=u2*u;
      out.push({
        x:.5*((2*p[i].x)+(p[i+1].x-p[i-1].x)*u+(2*p[i-1].x-5*p[i].x+4*p[i+1].x-p[i+2].x)*u2+(-p[i-1].x+3*p[i].x-3*p[i+1].x+p[i+2].x)*u3),
        y:.5*((2*p[i].y)+(p[i+1].y-p[i-1].y)*u+(2*p[i-1].y-5*p[i].y+4*p[i+1].y-p[i+2].y)*u2+(-p[i-1].y+3*p[i].y-3*p[i+1].y+p[i+2].y)*u3),
      });
    }
  }
  out.push(pts[pts.length-1]);
  return out;
}
function tangentAt(pts,i){
  if(pts.length===1) return{x:1,y:0};
  if(i===0) return vNorm(vSub(pts[1],pts[0]));
  if(i===pts.length-1) return vNorm(vSub(pts[i],pts[i-1]));
  return vNorm(vSub(pts[i+1],pts[i-1]));
}

// â”€â”€â”€ parallel ski tracks â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function parallelTracks(pts,halfW,taperFrac,seed,wobble){
  const n=pts.length;
  const left=[],right=[];
  const closed=n>4&&vLen(vSub(pts[0],pts[n-1]))<halfW*3;
  for(let i=0;i<n;i++){
    const t=i/(n-1);
    const tf=closed?1:Math.min(1,t/taperFrac,(1-t)/taperFrac);
    const tang=tangentAt(pts,i),p=vPerp(tang);
    const wL=wobble*dnoise(i*.55,seed),wR=wobble*dnoise(i*.55,seed+19.3);
    const hw=halfW*tf;
    left.push({x:pts[i].x+p.x*(hw+wL),y:pts[i].y+p.y*(hw+wL)});
    right.push({x:pts[i].x-p.x*(hw+wR),y:pts[i].y-p.y*(hw+wR)});
  }
  return{left,right};
}

// â”€â”€â”€ draw track pair â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function drawTrackPair(lp,rp){
  if(lp.length<2) return;
  // subtle compressed-snow fill
  ctx.beginPath();
  ctx.moveTo(lp[0].x,lp[0].y);
  for(const p of lp) ctx.lineTo(p.x,p.y);
  for(let i=rp.length-1;i>=0;i--) ctx.lineTo(rp[i].x,rp[i].y);
  ctx.closePath();
  ctx.fillStyle='rgba(80,105,158,.09)'; ctx.fill();

  function sline(pts,col,lw,dx,dy){
    ctx.beginPath();ctx.moveTo(pts[0].x+dx,pts[0].y+dy);
    for(let i=1;i<pts.length;i++) ctx.lineTo(pts[i].x+dx,pts[i].y+dy);
    ctx.strokeStyle=col;ctx.lineWidth=lw;ctx.lineCap='round';ctx.lineJoin='round';ctx.stroke();
  }
  sline(lp,'#28507a',3.4,1.2,2.2); sline(rp,'#28507a',3.4,1.2,2.2); // groove shadow
  sline(lp,'#5280aa',2.2,0,0);     sline(rp,'#5280aa',2.2,0,0);     // main track
  sline(lp,'rgba(235,225,210,.7)',1,-.6,-.9); sline(rp,'rgba(235,225,210,.7)',1,-.6,-.9); // lit lip
}

// â”€â”€â”€ snow spray â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function drawSpray(lp,rp,seed){
  ctx.save(); ctx.lineCap='round';
  const stride=Math.max(2,Math.floor(lp.length/10));
  for(let i=stride;i<lp.length-stride;i+=stride){
    const tang=tangentAt(lp,i),n=vPerp(tang);
    for(const[pts,flip] of[[lp,1],[rp,-1]]){
      for(let k=0;k<3;k++){
        const ang=(k-1)*.5*flip;
        const nx=n.x*Math.cos(ang)-n.y*Math.sin(ang);
        const ny=n.x*Math.sin(ang)+n.y*Math.cos(ang);
        const len=2+Math.abs(dnoise(i*.4+k*6,seed))*3.5;
        ctx.globalAlpha=.1+Math.abs(dnoise(i*.3+k,seed+5))*.18;
        ctx.strokeStyle='rgba(225,215,200,.85)'; ctx.lineWidth=.85;
        ctx.beginPath(); ctx.moveTo(pts[i].x,pts[i].y);
        ctx.lineTo(pts[i].x+nx*len*flip,pts[i].y+ny*len*flip); ctx.stroke();
      }
    }
  }
  ctx.restore();
}

// â”€â”€â”€ glyph definitions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const G={
  ' ':[],
  'A':[ [[.5,.02],[.08,1]],[[.5,.02],[.92,1]],[[.22,.57],[.78,.57]] ],
  'B':[ [[.18,.02],[.18,.98]],[[.18,.02],[.6,.04],[.76,.18],[.7,.46],[.18,.5]],[[.18,.5],[.72,.54],[.82,.7],[.74,.9],[.18,.98]] ],
  'C':[ [[.88,.16],[.6,.03],[.24,.12],[.08,.34],[.08,.66],[.24,.88],[.6,.97],[.88,.84]] ],
  'D':[ [[.18,.02],[.18,.98]],[[.18,.02],[.56,.04],[.84,.2],[.9,.5],[.84,.8],[.56,.96],[.18,.98]] ],
  'E':[ [[.18,.02],[.18,.98]],[[.18,.02],[.84,.02]],[[.18,.5],[.7,.5]],[[.18,.98],[.84,.98]] ],
  'F':[ [[.18,.02],[.18,.98]],[[.18,.02],[.84,.02]],[[.18,.5],[.7,.5]] ],
  'G':[ [[.88,.16],[.6,.03],[.24,.12],[.08,.34],[.08,.66],[.24,.88],[.6,.97],[.88,.84],[.88,.52],[.5,.52]] ],
  'H':[ [[.15,.02],[.15,.98]],[[.85,.02],[.85,.98]],[[.15,.5],[.85,.5]] ],
  'I':[ [[.5,.02],[.5,.98]] ],
  'J':[ [[.64,.02],[.64,.76],[.52,.93],[.34,.98],[.2,.86]] ],
  'K':[ [[.15,.02],[.15,.98]],[[.84,.04],[.15,.52]],[[.3,.44],[.86,.98]] ],
  'L':[ [[.15,.02],[.15,.98]],[[.15,.98],[.86,.98]] ],
  'M':[ [[.08,.98],[.08,.04],[.5,.6],[.92,.04],[.92,.98]] ],
  'N':[ [[.12,.98],[.12,.04],[.88,.96],[.88,.04]] ],
  'O':[ [[.5,.02],[.14,.18],[.05,.5],[.14,.82],[.5,.98],[.86,.82],[.95,.5],[.86,.18],[.5,.02]] ],
  'P':[ [[.18,.02],[.18,.98]],[[.18,.02],[.64,.04],[.8,.18],[.76,.44],[.18,.5]] ],
  'Q':[ [[.5,.02],[.14,.18],[.05,.5],[.14,.82],[.5,.98],[.86,.82],[.95,.5],[.86,.18],[.5,.02]],[[.62,.76],[.92,1]] ],
  'R':[ [[.18,.02],[.18,.98]],[[.18,.02],[.64,.04],[.8,.18],[.76,.44],[.18,.5]],[[.42,.5],[.88,.98]] ],
  'S':[ [[.84,.16],[.62,.03],[.3,.07],[.14,.24],[.28,.44],[.66,.56],[.84,.74],[.72,.9],[.4,.97],[.18,.84]] ],
  'T':[ [[.08,.02],[.92,.02]],[[.5,.02],[.5,.98]] ],
  'U':[ [[.14,.02],[.14,.76],[.22,.93],[.5,.98],[.78,.93],[.86,.76],[.86,.02]] ],
  'V':[ [[.08,.02],[.5,.98],[.92,.02]] ],
  'W':[ [[.04,.04],[.24,.98],[.5,.52],[.76,.98],[.96,.04]] ],
  'X':[ [[.08,.04],[.92,.98]],[[.92,.04],[.08,.98]] ],
  'Y':[ [[.08,.04],[.5,.52]],[[.92,.04],[.5,.52]],[[.5,.52],[.5,.98]] ],
  'Z':[ [[.1,.04],[.9,.04],[.1,.96],[.9,.96]] ],
  '0':[ [[.5,.02],[.14,.18],[.05,.5],[.14,.82],[.5,.98],[.86,.82],[.95,.5],[.86,.18],[.5,.02]] ],
  '1':[ [[.3,.18],[.52,.04],[.52,.98]] ],
  '2':[ [[.18,.2],[.32,.06],[.68,.06],[.84,.22],[.84,.42],[.12,.9],[.88,.9]] ],
  '3':[ [[.16,.1],[.5,.02],[.86,.16],[.82,.44],[.5,.52]],[[.5,.52],[.84,.56],[.9,.8],[.74,.94],[.42,.98],[.18,.88]] ],
  '4':[ [[.72,.04],[.1,.66],[.9,.66]],[[.72,.04],[.72,.98]] ],
  '5':[ [[.84,.06],[.16,.06],[.16,.48],[.56,.42],[.82,.56],[.84,.76],[.7,.94],[.3,.98],[.14,.86]] ],
  '6':[ [[.8,.12],[.52,.02],[.22,.18],[.1,.48],[.14,.78],[.36,.96],[.66,.96],[.82,.76],[.76,.52],[.5,.5],[.22,.55]] ],
  '7':[ [[.1,.06],[.9,.06],[.38,.98]] ],
  '8':[ [[.5,.5],[.16,.36],[.16,.16],[.36,.02],[.64,.02],[.84,.16],[.84,.36],[.5,.5]],[[.5,.5],[.84,.64],[.84,.84],[.64,.98],[.36,.98],[.16,.84],[.16,.64],[.5,.5]] ],
  '9':[ [[.22,.88],[.5,.98],[.8,.82],[.9,.52],[.86,.22],[.64,.04],[.36,.06],[.18,.26],[.22,.52],[.5,.52],[.8,.46]] ],
  '!':[ [[.5,.04],[.5,.68]],[[.44,.84],[.56,.84]] ],
  '?':[ [[.24,.2],[.4,.05],[.64,.05],[.8,.22],[.8,.4],[.52,.62],[.5,.72]],[[.44,.84],[.56,.84]] ],
  '.':[ [[.38,.88],[.5,.96],[.62,.88]] ],
  ',':[ [[.48,.82],[.42,.98]] ],
  '-':[ [[.18,.5],[.82,.5]] ],
  "'":[ [[.5,.04],[.46,.2]] ],
  '/':[ [[.8,.04],[.2,.98]] ],
};

// â”€â”€â”€ letter layout (SQUISH=1 for orthographic top-down view) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const CELL_W=52,CELL_H=70,SQUISH=1.0,CELL_SP=8;
const BASE_HALF_W=3.2,TAPER=.2,SMPTH=9,WOBBLE=1.4;

// Skier travels at this y; text is centered on same line
const SKIER_LANE=H*.52;

let skiLetters=[];
function layoutSkiText(text){
  skiLetters=[];
  if(!text) return;
  const chars=[...text];
  const adv=(ch)=>(ch===' '?CELL_W*.52:CELL_W+CELL_SP);
  const totalW=chars.reduce((s,ch)=>s+adv(ch),0)-CELL_SP;
  const maxW=W-44;
  const sc=totalW>maxW?maxW/totalW:1;
  const cW=CELL_W*sc,cH=CELL_H*sc*SQUISH;
  const halfW=Math.max(1.4,BASE_HALF_W*sc);
  // center letters vertically on SKIER_LANE
  const baseY=SKIER_LANE+cH/2;
  let cx=(W-totalW*sc)/2;
  for(const ch of chars){
    const a=adv(ch)*sc;
    skiLetters.push({ch,x:cx,y:baseY-cH,w:cW,h:cH,cx:cx+a/2,seed:ch.charCodeAt(0)*1.73+cx*.07,halfW,prog:0});
    cx+=a;
  }
}

function drawSkiLetters(skierX){
  for(const L of skiLetters){
    if(skierX>=L.cx+12) L.prog=Math.min(1,L.prog+.055);
    if(L.prog<=0) continue;
    const glyph=G[L.ch]||[];
    ctx.save(); ctx.globalAlpha=L.prog;
    for(let si=0;si<glyph.length;si++){
      const raw=glyph[si];
      if(raw.length<2) continue;
      const pts=raw.map(([nx,ny])=>({x:L.x+nx*L.w,y:L.y+ny*L.h}));
      const smooth=spline(pts,SMPTH);
      const seed=L.seed+si*37.4;
      const{left,right}=parallelTracks(smooth,L.halfW,TAPER,seed,WOBBLE);
      drawTrackPair(left,right);
      drawSpray(left,right,seed+100);
    }
    ctx.restore();
  }
}

// â”€â”€â”€ state â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let condition='sunny',weatherInfo=null;
let particles=[],skiTracks=[];
let animFrame=null,animStart=null,animDur=6000,animDone=false;
let skierX=-80,skierY=SKIER_LANE;
let skierColor='#cc2020';
let windDx=0,isPowder=false;
let powderParticles=[];

// â”€â”€â”€ weather â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function fetchWeather(lat,lon){
  try{
    setStatus('Fetching live weatherâ€¦');
    const url=`https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lon}&appid=${OWM_KEY}&units=metric`;
    const r=await fetch(url);
    const d=await r.json();
    console.log('[PowderPost] weather:',d);
    if(!r.ok) throw new Error(`API ${r.status}: ${d.message||''}`);
    return{condition:mapCode(d.weather[0].id),temp:Math.round(d.main.temp),desc:d.weather[0].description,
      windDeg:d.wind?.deg??270,windSpeed:d.wind?.speed??0,weatherId:d.weather[0].id};
  }catch(e){
    console.error('[PowderPost] fetch failed:',e);
    setStatus('Weather fetch failed â€” using clear sky');
    return{condition:'sunny',temp:-8,desc:'Clear sky',windDeg:270,windSpeed:3,weatherId:800};
  }
}
function mapCode(id){
  if(id===800) return'sunny';
  if(id>=801&&id<=804) return'overcast';
  if(id>=600&&id<=622) return'snowing';
  if((id>=200&&id<=232)||id>=900) return'storm';
  return'overcast';
}

// â”€â”€â”€ particles â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function initParticles(cond){
  const n=cond==='storm'?280:cond==='snowing'?140:0;
  particles=Array.from({length:n},()=>makeP(cond,true));
}
function makeP(cond,randY){
  const storm=cond==='storm';
  return{x:Math.random()*W+(storm?-60:0),y:randY?Math.random()*H:-8,
    sz:Math.random()*(storm?2.5:2)+.5,spd:Math.random()*(storm?4.5:2)+.8,
    dr:(Math.random()-.5)*(storm?7:.8),op:Math.random()*.5+.3};
}
function updateParticles(cond){
  // use real wind data; ensure storms always have at least some drift
  const wd=(cond==='storm'&&Math.abs(windDx)<1.5)?2.5:windDx;
  for(const p of particles){
    p.y+=p.spd;p.x+=p.dr+wd;
    if(p.y>H+10||p.x<-30||p.x>W+30){
      p.y=-8;p.x=Math.random()*W+(cond==='storm'?-60:0);
      p.spd=Math.random()*(cond==='storm'?4.5:2)+.8;
      p.dr=(Math.random()-.5)*(cond==='storm'?7:.8);
    }
  }
}
const WIND_SEEDS=Array.from({length:22},()=>({
  xr:Math.random(),yo:Math.random()*H,len:30+Math.random()*80,
  spd:.2+Math.random()*.5,op:.03+Math.random()*.04
}));

// â”€â”€â”€ scene draw â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function drawParticles(cond){
  if(!particles.length) return;
  ctx.save();
  for(const p of particles){
    ctx.globalAlpha=p.op;ctx.fillStyle=cond==='storm'?'#b0c4d4':'#ffffff';
    ctx.beginPath();ctx.arc(p.x,p.y,p.sz,0,Math.PI*2);ctx.fill();
  }
  ctx.restore();
}
function drawWind(t){
  ctx.save();
  for(const s of WIND_SEEDS){
    const y=(s.yo+t*s.spd*.2)%H;
    ctx.globalAlpha=s.op;ctx.strokeStyle='#a0b8cc';ctx.lineWidth=1;
    ctx.beginPath();ctx.moveTo(s.xr*W,y);ctx.lineTo(s.xr*W+s.len,y+3);ctx.stroke();
  }
  ctx.restore();
}
// â”€â”€â”€ powder spray (main skier carving) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function emitPowder(x,y,sway){
  for(let i=0;i<5;i++){
    const a=Math.PI+(sway*.8)+(Math.random()-.5)*1.1; // backward fan
    const spd=1.2+Math.random()*2.2;
    const side=i<2?-4.5:4.5; // two ski edges, fifth is center burst
    const life=20+Math.floor(Math.random()*18);
    powderParticles.push({
      x:x-14+(Math.random()-.5)*5, y:y+side+(Math.random()-.5)*3,
      vx:Math.cos(a)*spd, vy:Math.sin(a)*spd+(Math.random()-.5)*.6,
      life, maxLife:life, sz:0.7+Math.random()*1.5,
    });
  }
}
function updatePowder(){
  for(let i=powderParticles.length-1;i>=0;i--){
    const p=powderParticles[i];
    p.x+=p.vx; p.y+=p.vy; p.vx*=.90; p.vy*=.90; p.life--;
    if(p.life<=0) powderParticles.splice(i,1);
  }
}
function drawPowder(){
  if(!powderParticles.length) return;
  ctx.save();
  for(const p of powderParticles){
    ctx.globalAlpha=(p.life/p.maxLife)*.75;
    ctx.fillStyle='rgba(240,248,255,.9)';
    ctx.beginPath();ctx.arc(p.x,p.y,p.sz,0,Math.PI*2);ctx.fill();
  }
  ctx.restore();
}

function drawSkiTracks(tracks){
  if(tracks.length<2) return;
  ctx.save();ctx.strokeStyle='rgba(140,170,210,.52)';ctx.lineWidth=1.5;ctx.lineCap='round';
  for(const off of[-4,4]){
    ctx.beginPath();ctx.moveTo(tracks[0].x,tracks[0].y+off);
    for(let i=1;i<tracks.length;i++) ctx.lineTo(tracks[i].x,tracks[i].y+off);
    ctx.stroke();
  }
  ctx.restore();
}
function drawVignette(){
  const g=ctx.createRadialGradient(W/2,H/2,H*.3,W/2,H/2,H*.82);
  g.addColorStop(0,'rgba(0,0,0,0)');g.addColorStop(1,'rgba(0,0,0,.22)');
  ctx.fillStyle=g;ctx.fillRect(0,0,W,H);
}
function drawLabel(){
  const sel=document.getElementById('resort');
  const name=sel.options[sel.selectedIndex]?.text||'';
  const date=new Date().toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'});
  ctx.save();ctx.font="11px 'Inter',sans-serif";
  ctx.fillStyle='rgba(0,0,0,.35)';ctx.textAlign='right';
  ctx.fillText(`${name}  Â·  ${date}`,W-14,H-12);ctx.restore();
}

// â”€â”€â”€ main skier (top-down view, moving leftâ†’right) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function drawSkier(x,y,t){
  ctx.save();ctx.translate(x,y);
  const sway=Math.sin(t*.008)*.06;
  ctx.rotate(sway);

  // soft shadow â€” always visible, strength varies by weather
  const shOp={sunny:.22,overcast:.13,snowing:.11,storm:.07}[condition]||.15;
  ctx.save();
  ctx.filter='blur(5px)';
  ctx.globalAlpha=shOp;ctx.fillStyle='#3850a0';
  ctx.beginPath();
  ctx.ellipse(SHADOW_DX*16,SHADOW_DY*16,13,28,Math.atan2(SHADOW_DY,SHADOW_DX),0,Math.PI*2);
  ctx.fill();
  ctx.filter='none';
  ctx.restore();

  // skis
  ctx.fillStyle='#180e04';
  ctx.fillRect(-22,-3.5,44,3);
  ctx.fillStyle='#2a1810';ctx.fillRect(-22,-3,44,1);
  ctx.fillStyle='#180e04';
  ctx.fillRect(-22,1.5,44,3);
  ctx.fillStyle='#1e1008';
  ctx.beginPath();ctx.ellipse(22,-2,3,1.5,0,0,Math.PI*2);ctx.fill();
  ctx.beginPath();ctx.ellipse(22,3,3,1.5,0,0,Math.PI*2);ctx.fill();

  // jacket
  ctx.fillStyle=skierColor;
  ctx.beginPath();ctx.ellipse(0,0,7,9.5,0,0,Math.PI*2);ctx.fill();
  ctx.fillStyle='#fff';ctx.fillRect(-7,-1,14,1.5);

  // arms
  ctx.fillStyle=skierColor;
  ctx.save();ctx.rotate(.25);ctx.fillRect(-15,-2,10,3);ctx.restore();
  ctx.save();ctx.rotate(-.25);ctx.fillRect(-15,-1,10,3);ctx.restore();

  // pole baskets
  ctx.fillStyle='rgba(80,80,80,.7)';
  ctx.beginPath();ctx.arc(-17,-4,2,0,Math.PI*2);ctx.fill();
  ctx.beginPath();ctx.arc(-17,4,2,0,Math.PI*2);ctx.fill();

  // helmet
  ctx.fillStyle=skierColor;
  ctx.beginPath();ctx.arc(8,0,5.5,0,Math.PI*2);ctx.fill();
  // goggles
  ctx.fillStyle='#e8c020';ctx.fillRect(5,-2.5,7,5);
  ctx.fillStyle='#1a3a5a';ctx.fillRect(5.5,-2,6,4);
  ctx.fillStyle='rgba(255,255,255,.3)';ctx.fillRect(6,-1.5,2,2);

  ctx.restore();
}

// â”€â”€â”€ skier position â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function skierPos(t){
  const raw=Math.min(t/animDur,1);
  const p=raw<.08?raw/.08*.04:raw>.92?1-((1-raw)/.08*.04):0.04+(raw-.08)*.96/.84;
  // skier travels along SKIER_LANE with gentle carving wobble
  return{x:-90+p*(W+180),y:SKIER_LANE+Math.sin(p*Math.PI*5)*6,raw};
}

// â”€â”€â”€ full scene â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function drawScene(t,cond,sx,sy){
  ctx.drawImage(getBg(cond),0,0);
  drawLiftCars(t);
  drawLiveBgSkiers(t);
  drawSkiTracks(skiTracks);
  drawSkiLetters(sx);
  if(sx<W+100) drawSkier(sx,sy,t);
  drawPowder();
  drawParticles(cond);
  if(cond==='storm') drawWind(t);
  drawVignette();
  drawLabel();
}

// â”€â”€â”€ animation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function animate(ts){
  if(!animStart) animStart=ts;
  const t=ts-animStart;
  if(condition==='snowing'||condition==='storm') updateParticles(condition);
  const pos=skierPos(t);
  skierX=pos.x;skierY=pos.y;
  if(skiTracks.length===0||skiTracks[skiTracks.length-1].x<skierX-6)
    skiTracks.push({x:skierX,y:skierY});
  if(skierX>0&&skierX<W){emitPowder(skierX,skierY,Math.sin(t*.008)*.06);}
  updatePowder();
  drawScene(t,condition,skierX,skierY);
  document.getElementById('progressFill').style.width=(pos.raw*100)+'%';
  if(pos.raw>=1){
    animDone=true;
    document.getElementById('btnExport').disabled=false;
    document.getElementById('btnGo').disabled=false;
    setStatus('Done! Hit Export GIF to download.');
    animFrame=requestAnimationFrame(idleTick);
    return;
  }
  animFrame=requestAnimationFrame(animate);
}
let idleStart=null;
function idleTick(ts){
  if(!idleStart) idleStart=ts;
  const t=ts-idleStart+animDur;
  if(condition==='snowing'||condition==='storm') updateParticles(condition);
  updatePowder();
  drawScene(t,condition,skierX,skierY);
  animFrame=requestAnimationFrame(idleTick);
}

// â”€â”€â”€ start â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function start(){
  const msg=document.getElementById('message').value.trim().toUpperCase();
  if(!msg){setStatus('Please enter a message!');return;}
  if(animFrame){cancelAnimationFrame(animFrame);animFrame=null;}
  document.getElementById('btnGo').disabled=true;
  document.getElementById('btnExport').disabled=true;
  document.getElementById('progressFill').style.width='0%';
  animStart=null;animDone=false;skiTracks=[];idleStart=null;powderParticles=[];

  const sel=document.getElementById('resort');
  const [lat,lon]=sel.value.split(',').map(Number);
  const resortName=sel.options[sel.selectedIndex].text;

  const w=await fetchWeather(lat,lon);
  condition=w.condition;weatherInfo=w;
  bgCanvas=null; // rebuild bg for new condition

  // wind: OWM deg is "from" direction â†’ particles drift the opposite way
  const windToRad=((w.windDeg??270)+180)*Math.PI/180;
  windDx=Math.sin(windToRad)*Math.min(w.windSpeed??0,20)*0.28;

  // powder alert: any snow condition + cold enough for dry powder
  isPowder=(w.weatherId>=600&&w.weatherId<=622&&w.temp<=-3);
  document.getElementById('powderAlert').style.display=isPowder?'block':'none';

  const badge=document.getElementById('weatherBadge');
  const emo={sunny:'â˜€ï¸',snowing:'â„ï¸',overcast:'â˜ï¸',storm:'ğŸŒ¨ï¸'};
  badge.textContent=`${emo[w.condition]} ${w.desc} Â· ${w.temp}Â°C`;
  badge.style.display='block';
  setStatus(`${resortName}: ${w.desc}, ${w.temp}Â°C`);

  initParticles(condition);
  layoutSkiText(msg);
  animDur=2800+msg.length*230;
  animFrame=requestAnimationFrame(animate);
}

// â”€â”€â”€ GIF export â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function exportGif(){
  setStatus('Preparing GIFâ€¦ fetching encoder workerâ€¦');
  document.getElementById('btnExport').disabled=true;
  try{
    const wres=await fetch('https://cdnjs.cloudflare.com/ajax/libs/gif.js/0.2.0/gif.worker.js');
    const wtxt=await wres.text();
    const wurl=URL.createObjectURL(new Blob([wtxt],{type:'application/javascript'}));
    const gif=new GIF({workers:2,quality:8,width:W,height:H,workerScript:wurl});
    const FPS=12,fDelay=Math.round(1000/FPS);
    const steps=Math.ceil(animDur/(1000/FPS));

    const savedProg=skiLetters.map(l=>l.prog);
    for(const l of skiLetters) l.prog=0;
    const savedTracks=[...skiTracks];
    const savedPowder=[...powderParticles];
    const exportTracks=[];
    powderParticles=[];
    initParticles(condition);
    setStatus('Rendering framesâ€¦');

    for(let i=0;i<=steps;i++){
      const t=(i/steps)*animDur;
      const pos=skierPos(t);
      if(condition==='snowing'||condition==='storm') updateParticles(condition);
      if(pos.x>0&&pos.x<W){emitPowder(pos.x,pos.y,Math.sin(t*.008)*.06);}
      updatePowder();
      if(exportTracks.length===0||exportTracks[exportTracks.length-1].x<pos.x-6)
        exportTracks.push({x:pos.x,y:pos.y});
      const sv=skiTracks;skiTracks=exportTracks;
      drawScene(t,condition,pos.x,pos.y);
      skiTracks=sv;
      gif.addFrame(canvas,{copy:true,delay:fDelay});
      if(i%10===0) setStatus(`Rendering frame ${i}/${steps}â€¦`);
    }
    for(let i=0;i<skiLetters.length;i++) skiLetters[i].prog=savedProg[i]||1;
    skiTracks=savedTracks;
    powderParticles=savedPowder;

    gif.on('progress',p=>setStatus(`Encoding GIF: ${Math.round(p*100)}%`));
    gif.on('finished',blob=>{
      URL.revokeObjectURL(wurl);
      const url=URL.createObjectURL(blob);
      const a=document.createElement('a');a.href=url;a.download='powder-post.gif';
      document.body.appendChild(a);a.click();document.body.removeChild(a);
      setTimeout(()=>URL.revokeObjectURL(url),60000);
      setStatus('GIF downloaded!');
      document.getElementById('btnExport').disabled=false;
    });
    gif.render();
  }catch(e){
    console.error(e);setStatus('Export failed: '+e.message);
    document.getElementById('btnExport').disabled=false;
  }
}

// â”€â”€â”€ helpers / events â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setStatus(msg){document.getElementById('status').textContent=msg;}
document.getElementById('btnGo').addEventListener('click',start);
document.getElementById('btnExport').addEventListener('click',exportGif);
document.getElementById('message').addEventListener('keydown',e=>{if(e.key==='Enter')start();});
document.getElementById('swatches').addEventListener('click',e=>{
  const sw=e.target.closest('.swatch');
  if(!sw) return;
  skierColor=sw.dataset.color;
  document.querySelectorAll('.swatch').forEach(s=>s.classList.toggle('active',s===sw));
});

// â”€â”€â”€ init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
(function init(){
  layoutSkiText('SEND POWDER!');
  drawScene(0,'sunny',-200,SKIER_LANE);
})();
</script>
</body>
</html>
