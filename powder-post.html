<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Powder Post</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/gif.js/0.2.0/gif.js"></script>
<style>
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:'Inter',sans-serif;background:linear-gradient(160deg,#0a1628,#0f2040 50%,#0a1628);color:#d8eaf8;min-height:100vh;display:flex;flex-direction:column;align-items:center;padding:28px 16px 40px}
h1{font-family:'Playfair Display',serif;font-size:2.4rem;color:#f0f8ff;letter-spacing:-.5px;margin-bottom:4px}
.subtitle{color:#6a90b0;font-size:.88rem;margin-bottom:22px}
.panel{width:100%;max-width:820px;background:rgba(15,30,55,.7);border:1px solid rgba(80,140,200,.18);border-radius:14px;padding:16px 18px;display:flex;flex-direction:column;gap:12px;margin-bottom:14px}
.row{display:flex;flex-wrap:wrap;gap:12px;align-items:flex-end}
.fg{display:flex;flex-direction:column;gap:5px}
.fg.grow{flex:1;min-width:180px}
label{font-size:.7rem;font-weight:600;text-transform:uppercase;letter-spacing:.08em;color:#5a8ab0}
select,input[type=text]{background:#0d2038;border:1px solid #1e4060;color:#d8eaf8;padding:9px 12px;border-radius:8px;font-family:'Inter',sans-serif;font-size:.88rem;outline:none;transition:border-color .2s;width:100%}
select:focus,input[type=text]:focus{border-color:#3a8cd0}
input[type=text].mono{font-family:monospace;font-size:.8rem;letter-spacing:.04em}
.btns{display:flex;gap:8px;flex-wrap:wrap}
button{padding:10px 22px;border:none;border-radius:8px;font-family:'Inter',sans-serif;font-weight:600;font-size:.9rem;cursor:pointer;transition:all .2s;white-space:nowrap}
.btn-go{background:#1a6ec0;color:#fff}.btn-go:hover{background:#2280dc}.btn-go:disabled{background:#12304a;color:#2a5070;cursor:default}
.btn-export{background:#0d3020;color:#4dcc80;border:1px solid #1a6035}.btn-export:hover{background:#155030}.btn-export:disabled{opacity:.35;cursor:default}
.hint{font-size:.72rem;color:#3a6080;align-self:center}
.canvas-wrap{position:relative;border-radius:12px;overflow:hidden;box-shadow:0 24px 64px rgba(0,0,0,.6),0 0 0 1px rgba(80,140,200,.15)}
canvas{display:block}
.weather-badge{position:absolute;top:10px;right:10px;background:rgba(0,0,0,.45);backdrop-filter:blur(8px);border-radius:20px;padding:4px 13px;font-size:.78rem;color:#fff;display:none;border:1px solid rgba(255,255,255,.12)}
.progress-wrap{width:100%;max-width:820px;height:3px;background:#0d2038;border-radius:2px;margin-top:10px;overflow:hidden}
.progress-fill{height:100%;background:#2a8cd0;border-radius:2px;width:0%;transition:width .12s}
.status{font-size:.78rem;color:#4a7090;margin-top:7px;min-height:18px;text-align:center}
</style>
</head>
<body>
<h1>â›· Powder Post</h1>
<p class="subtitle">Pick a resort Â· fetch the weather Â· carve your message into the snow</p>

<div class="panel">
  <div class="row">
    <div class="fg" style="min-width:210px">
      <label>Resort</label>
      <select id="resort">
        <optgroup label="Alps">
          <option value="46.0956,7.2272">Verbier</option><option value="46.0207,7.7491">Zermatt</option>
          <option value="45.9237,6.8694">Chamonix</option><option value="46.4985,9.8355">St. Moritz</option>
          <option value="45.4148,6.6340">Courchevel</option><option value="45.4036,6.5619">MÃ©ribel</option>
          <option value="45.4483,6.9794">Val d'IsÃ¨re</option><option value="45.5688,6.8152">Les Arcs</option>
          <option value="45.5048,6.6779">La Plagne</option><option value="45.4693,6.9020">Tignes</option>
          <option value="45.8570,6.6160">MegÃ¨ve</option><option value="46.0009,6.6822">Flaine</option>
          <option value="46.1783,6.7097">Morzine</option><option value="46.1925,6.7759">Avoriaz</option>
          <option value="46.1575,6.6683">Les Gets</option><option value="46.1091,7.9285">Saas-Fee</option>
          <option value="46.6244,8.0411">Grindelwald</option><option value="46.6081,7.9218">Wengen</option>
          <option value="46.8028,9.8374">Davos</option><option value="46.8735,9.8787">Klosters</option>
          <option value="46.5404,12.1357">Cortina d'Ampezzo</option><option value="45.7996,6.9691">Courmayeur</option>
          <option value="45.9389,7.7316">Cervinia</option><option value="46.2305,10.8279">Madonna di Campiglio</option>
          <option value="47.4464,12.3927">KitzbÃ¼hel</option><option value="47.1281,10.2689">St. Anton</option>
          <option value="47.2082,10.1416">Lech</option><option value="46.9994,10.2891">Ischgl</option>
          <option value="46.9610,10.9394">SÃ¶lden</option><option value="47.1666,11.8672">Mayrhofen</option>
          <option value="47.1080,13.1346">Bad Gastein</option><option value="47.3878,12.6379">Saalbach</option>
          <option value="47.3924,13.6893">Schladming</option><option value="46.5378,10.1366">Livigno</option>
          <option value="42.5463,1.7101">Andorra Grandvalira</option>
        </optgroup>
        <optgroup label="Northeast USA">
          <option value="44.5290,-72.7823">Stowe</option><option value="43.6775,-72.7812">Killington</option>
          <option value="44.1372,-72.8951">Sugarbush</option><option value="44.1892,-72.8615">Mad River Glen</option>
          <option value="43.4036,-72.5237">Okemo</option><option value="43.1125,-72.9076">Stratton</option>
          <option value="42.9593,-72.9223">Mount Snow</option><option value="43.2094,-72.9618">Bromley</option>
          <option value="44.4133,-72.8704">Bolton Valley</option><option value="44.5617,-72.7901">Smugglers' Notch</option>
          <option value="44.4711,-70.8556">Sunday River</option><option value="45.0317,-70.3131">Sugarloaf</option>
          <option value="44.8887,-70.5167">Saddleback</option><option value="44.0356,-71.6246">Loon</option>
          <option value="44.1578,-71.6999">Cannon</option><option value="43.9738,-71.5148">Waterville Valley</option>
          <option value="44.2619,-71.4428">Bretton Woods</option><option value="44.2597,-71.2388">Wildcat</option>
          <option value="42.2020,-74.2285">Hunter</option><option value="42.2994,-74.2566">Windham</option>
          <option value="42.1556,-74.5079">Belleayre</option><option value="44.3658,-73.9027">Whiteface</option>
          <option value="43.6778,-74.0009">Gore</option><option value="42.5095,-73.3165">Jiminy Peak</option>
          <option value="42.4986,-71.8881">Wachusett</option><option value="42.0959,-73.3685">Ski Butternut</option>
        </optgroup>
        <optgroup label="North America (West)">
          <option value="50.1163,-122.9574">Whistler</option><option value="39.1911,-106.8175">Aspen</option>
          <option value="43.5875,-110.8278">Jackson Hole</option><option value="40.6514,-111.5080">Park City</option>
          <option value="37.6308,-119.0326">Mammoth</option><option value="39.6433,-106.3781">Vail</option>
          <option value="51.1784,-115.5708">Banff</option><option value="51.0160,-118.1960">Revelstoke</option>
        </optgroup>
        <optgroup label="Japan">
          <option value="42.8042,140.6872">Niseko</option><option value="36.6986,137.8614">Hakuba</option>
        </optgroup>
        <optgroup label="Southern Hemisphere">
          <option value="-45.0312,168.6626">Queenstown</option>
        </optgroup>
      </select>
    </div>
    <div class="fg grow">
      <label>Message (max 20 chars)</label>
      <input type="text" id="message" value="SEND POWDER!" maxlength="20" placeholder="Your message...">
    </div>
    <div class="btns">
      <button class="btn-go" id="btnGo">Go â–¶</button>
      <button class="btn-export" id="btnExport" disabled>Export GIF â†“</button>
    </div>
  </div>
</div>

<div class="canvas-wrap">
  <canvas id="canvas" width="800" height="450"></canvas>
  <div class="weather-badge" id="weatherBadge"></div>
</div>
<div class="progress-wrap"><div class="progress-fill" id="progressFill"></div></div>
<p class="status" id="status">Pick a resort, type your message, and hit Go.</p>

<script>
// â”€â”€â”€ roundRect polyfill â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if(!CanvasRenderingContext2D.prototype.roundRect){
  CanvasRenderingContext2D.prototype.roundRect=function(x,y,w,h,r){
    r=Math.min(r,w/2,h/2);this.beginPath();this.moveTo(x+r,y);
    this.arcTo(x+w,y,x+w,y+h,r);this.arcTo(x+w,y+h,x,y+h,r);
    this.arcTo(x,y+h,x,y,r);this.arcTo(x,y,x+w,y,r);this.closePath();
  };
}

// â”€â”€â”€ canvas / constants â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const canvas=document.getElementById('canvas');
const ctx=canvas.getContext('2d');
const W=800,H=450;

// â”€â”€â”€ seeded RNG (xorshift) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function mkRng(seed){
  let s=seed|0;
  return function(){
    s^=s<<13;s^=s>>17;s^=s<<5;
    return(s>>>0)/0x100000000;
  };
}

// â”€â”€â”€ snow palette by condition â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const SNOW_PAL={
  sunny:{
    base:'#8898c0',
    lt:['#faf4e8','#f6f0e2','#f2ebe0','#ede5d0','#f8f2e8','#f0e8d8'],
    sh:['#b8c2de','#aabbd8','#9aaac8','#c4cce0','#b0c0da'],
    sky:['#d4e8f8','#b8d0ee'],
  },
  snowing:{
    base:'#788ab0',
    lt:['#eceef4','#e8eaf0','#e4e7ef','#e0e4ec'],
    sh:['#a8b2d0','#9ea8cc','#94a0c8','#b0bcd4'],
    sky:['#b8c5d5','#a8b5c5'],
  },
  overcast:{
    base:'#6a7288',
    lt:['#dfe0e5','#d8dadf','#d5d8de','#d0d3d8'],
    sh:['#9298b0','#8890aa','#8490a8','#9aa0b8'],
    sky:['#a0a8b2','#949caa'],
  },
  storm:{
    base:'#484e60',
    lt:['#c5c8d0','#c0c4cc','#bbbfc9','#b8bcc6'],
    sh:['#7a80a0','#707898','#686e92','#808898'],
    sky:['#505868','#404858'],
  },
};

// â”€â”€â”€ offscreen background canvas â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let bgCanvas=null, bgCond=null;

function getBg(cond){
  if(bgCanvas&&bgCond===cond) return bgCanvas;
  bgCanvas=document.createElement('canvas');
  bgCanvas.width=W; bgCanvas.height=H;
  bgCond=cond;
  paintBg(bgCanvas.getContext('2d'),cond);
  return bgCanvas;
}

function paintBg(bx,cond){
  const pal=SNOW_PAL[cond]||SNOW_PAL.sunny;
  const rng=mkRng(0xdeadbeef);

  // base fill (shadow recesses between strokes)
  bx.fillStyle=pal.base; bx.fillRect(0,0,W,H);

  // sky strip â€” top ~11%
  const skyH=H*.11;
  const sg=bx.createLinearGradient(0,0,0,skyH);
  sg.addColorStop(0,pal.sky[0]); sg.addColorStop(1,pal.sky[1]);
  bx.fillStyle=sg; bx.fillRect(0,0,W,skyH);

  // soft horizon where sky meets snow
  const hg=bx.createLinearGradient(0,skyH-6,0,skyH+10);
  hg.addColorStop(0,'rgba(255,255,255,0)');
  hg.addColorStop(.5,'rgba(255,255,255,.18)');
  hg.addColorStop(1,'rgba(255,255,255,0)');
  bx.fillStyle=hg; bx.fillRect(0,skyH-6,W,16);

  // â”€â”€ palette knife strokes, large layer â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  for(let i=0;i<520;i++){
    const x=rng()*W;
    const y=skyH+rng()*(H-skyH);
    const len=22+rng()*72;
    const wid=4+rng()*18;
    // strokes run mostly along slope contour (near-horizontal, slight tilt)
    const ang=(rng()-.5)*.5+.08*(y/H-.5);
    // warmer / lit toward lower-right; cooler / shadowed toward upper-left
    const shadow=(x/W<.32&&y/H<.52)&&rng()<.45;
    const col=shadow
      ? pal.sh[Math.floor(rng()*pal.sh.length)]
      : pal.lt[Math.floor(rng()*pal.lt.length)];
    const alpha=.5+rng()*.38;

    bx.save();
    bx.translate(x,y); bx.rotate(ang);
    bx.globalAlpha=alpha;
    bx.fillStyle=col;
    bx.fillRect(-len/2,-wid/2,len,wid);
    // raised-paint lip highlight on top edge
    bx.globalAlpha=alpha*.35;
    bx.fillStyle='#ffffff';
    bx.fillRect(-len/2,-wid/2,len,1.4);
    bx.restore();
  }

  // â”€â”€ fine texture layer â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  for(let i=0;i<320;i++){
    const x=rng()*W;
    const y=skyH+rng()*(H-skyH);
    const len=6+rng()*26;
    const wid=1.5+rng()*6;
    const ang=(rng()-.5)*.9;
    const col=rng()<.32
      ? pal.sh[Math.floor(rng()*pal.sh.length)]
      : pal.lt[Math.floor(rng()*pal.lt.length)];
    bx.save();
    bx.translate(x,y); bx.rotate(ang);
    bx.globalAlpha=.35+rng()*.38;
    bx.fillStyle=col;
    bx.fillRect(-len/2,-wid/2,len,wid);
    bx.restore();
  }

  // â”€â”€ overall light gradient (sun from upper-right) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const lg=bx.createLinearGradient(0,skyH,W,H);
  lg.addColorStop(0,'rgba(80,95,145,.1)');
  lg.addColorStop(.65,'rgba(255,255,255,.04)');
  lg.addColorStop(1,'rgba(255,248,235,.07)');
  bx.fillStyle=lg; bx.fillRect(0,skyH,W,H-skyH);

  // now paint static scene elements onto the bg canvas
  paintGondola(bx,cond);
  paintTrees(bx,cond);
  paintBgSkiers(bx,cond);
}

// â”€â”€â”€ gondola / chairlift â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const CAB_Y1=H*.148, CAB_Y2=H*.228, CAB_SAG=6;

function cableY(t){
  return CAB_Y1+(CAB_Y2-CAB_Y1)*t+CAB_SAG*4*t*(1-t);
}

function paintGondola(bx,cond){
  const cc=cond==='storm'?'#383838':'#222222';

  // two parallel haul cables
  for(const dy of [0,3.5]){
    bx.beginPath();
    bx.moveTo(0,CAB_Y1+dy);
    bx.quadraticCurveTo(W*.5,CAB_Y1+dy+CAB_SAG,W,CAB_Y2+dy);
    bx.strokeStyle=cc; bx.lineWidth=dy===0?1.4:.7; bx.stroke();
  }

  // support towers
  for(const tx of [W*.27,W*.73]){
    const ty=cableY(tx/W);
    bx.fillStyle=cond==='storm'?'#484848':'#2a2a2a';
    bx.fillRect(tx-2,ty-24,4,24); // shaft
    bx.fillRect(tx-11,ty-26,22,4); // cross-arm
    for(const wx of [-7,7]){ // sheave wheels
      bx.beginPath(); bx.arc(tx+wx,ty-24,2.8,0,Math.PI*2);
      bx.fillStyle=cond==='storm'?'#555':'#333'; bx.fill();
    }
  }

  // gondola cars
  for(const t of [.1,.32,.54,.76,.9]){
    const cx=t*W, cy=cableY(t)+5;
    const cw=14,ch=10;
    // hanger wire
    bx.beginPath(); bx.moveTo(cx,cableY(t)); bx.lineTo(cx,cy);
    bx.strokeStyle=cc; bx.lineWidth=.9; bx.stroke();
    // body
    bx.fillStyle=cond==='storm'?'#2a2a38':'#18182a';
    bx.fillRect(cx-cw/2,cy,cw,ch);
    // window strip
    bx.fillStyle='rgba(175,205,228,.38)';
    bx.fillRect(cx-cw/2+2,cy+2,cw-4,ch-5);
    // bottom trim
    bx.fillStyle='#383844';
    bx.fillRect(cx-cw/2,cy+ch-2,cw,2);
  }
}

// â”€â”€â”€ impressionistic blob trees â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const TREE_DEFS=[{x:72,y:215,sz:40},{x:718,y:205,sz:44}];

function paintTrees(bx,cond){
  const rng=mkRng(0xf00dcafe);
  const snowCol=cond==='storm'?'#b0bec8':cond==='snowing'?'#d8eaf0':'#dff0f0';
  const greens=['#152618','#1e3020','#1a2c1c','#22341e','#182a18'];
  const blobs=[
    {dx:0,dy:0,rx:.48,ry:.62,a:0},
    {dx:-.22,dy:.12,rx:.38,ry:.46,a:-.2},
    {dx:.2,dy:.1,rx:.34,ry:.42,a:.22},
    {dx:-.1,dy:-.2,rx:.3,ry:.38,a:-.12},
    {dx:.1,dy:-.18,rx:.27,ry:.34,a:.18},
    {dx:-.18,dy:.02,rx:.22,ry:.3,a:-.3},
  ];

  for(const t of TREE_DEFS){
    // cast shadow
    bx.save(); bx.globalAlpha=.28; bx.fillStyle='#6070a8';
    bx.beginPath();
    bx.ellipse(t.x+t.sz*.35,t.y+t.sz*.55,t.sz*.58,t.sz*.22,.38,0,Math.PI*2);
    bx.fill(); bx.restore();

    // tree blobs
    for(let i=0;i<blobs.length;i++){
      const b=blobs[i];
      bx.save(); bx.globalAlpha=.78+rng()*.18;
      bx.fillStyle=greens[i%greens.length];
      bx.beginPath();
      bx.ellipse(t.x+b.dx*t.sz,t.y+b.dy*t.sz,b.rx*t.sz,b.ry*t.sz,b.a,0,Math.PI*2);
      bx.fill(); bx.restore();
    }

    // snow patches on branches
    bx.save(); bx.globalAlpha=.62; bx.fillStyle=snowCol;
    for(const [sdx,sdy,sr] of [[0,-.3,.17],[-.14,.06,.12],[.13,.04,.11]]){
      bx.beginPath();
      bx.ellipse(t.x+sdx*t.sz,t.y+sdy*t.sz,sr*t.sz,sr*t.sz*.52,0,0,Math.PI*2);
      bx.fill();
    }
    bx.restore();
  }
}

// â”€â”€â”€ tiny background skiers (blob / impasto style) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const SKIER_COLORS=['#d02020','#d8a018','#1a50c0','#d05818','#1a9440','#c03070','#6818b8'];

const BG_SKIERS=(function(){
  const rng=mkRng(0xabcdef12);
  return Array.from({length:18},()=>({
    x:90+rng()*(W-180),
    y:130+rng()*265,
    sz:.42+rng()*.48,
    col:SKIER_COLORS[Math.floor(rng()*SKIER_COLORS.length)],
    rot:(rng()-.5)*.28,
  }));
})();

function paintBgSkiers(bx,cond){
  for(const sk of BG_SKIERS){
    bx.save();
    bx.translate(sk.x,sk.y);
    bx.rotate(sk.rot);
    const s=sk.sz;

    // long blue-purple shadow (going downhill)
    bx.save(); bx.globalAlpha=.32; bx.fillStyle='#6878b0';
    bx.beginPath();
    bx.ellipse(-s*1.5,s*9,s*1.8,s*5.5,.15,0,Math.PI*2);
    bx.fill(); bx.restore();

    // skis
    bx.strokeStyle='#1e1005'; bx.lineWidth=s*.7; bx.lineCap='round';
    bx.beginPath();
    bx.moveTo(-s*6,s*4); bx.lineTo(s*6,s*3.5);
    bx.moveTo(-s*5,s*5.8); bx.lineTo(s*7,s*5.2);
    bx.stroke();

    // jacket blob
    bx.fillStyle=sk.col;
    bx.beginPath(); bx.ellipse(0,0,s*3.4,s*4.4,0,0,Math.PI*2); bx.fill();

    // head
    bx.fillStyle='#efbca0';
    bx.beginPath(); bx.arc(s*.5,-s*4.8,s*2.1,0,Math.PI*2); bx.fill();

    // helmet
    bx.fillStyle=sk.col;
    bx.beginPath(); bx.arc(s*.5,-s*5.2,s*2.1,Math.PI,0); bx.fill();

    // poles
    bx.strokeStyle='rgba(60,60,60,.65)'; bx.lineWidth=s*.55;
    bx.beginPath();
    bx.moveTo(-s*4,-s*.8); bx.lineTo(-s*5,s*6);
    bx.moveTo(s*4,-s*.4); bx.lineTo(s*5,s*5.5);
    bx.stroke();

    bx.restore();
  }
}

// â”€â”€â”€ vector math â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const vSub=(a,b)=>({x:a.x-b.x,y:a.y-b.y});
const vLen=(a)=>Math.sqrt(a.x*a.x+a.y*a.y);
const vNorm=(a)=>{const l=vLen(a)||1;return{x:a.x/l,y:a.y/l};};
const vPerp=(a)=>({x:-a.y,y:a.x}); // 90Â° CCW

// deterministic wobble noise
function dnoise(x,s){return Math.sin(x*13.456+s*7.89)*Math.cos(x*4.321+s*11.1);}

// â”€â”€â”€ catmull-rom spline â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function spline(pts,steps=8){
  if(pts.length===1) return[pts[0]];
  if(pts.length===2){
    const out=[];
    for(let t=0;t<=steps;t++){const u=t/steps;out.push({x:pts[0].x+(pts[1].x-pts[0].x)*u,y:pts[0].y+(pts[1].y-pts[0].y)*u});}
    return out;
  }
  const p=[pts[0],...pts,pts[pts.length-1]];
  const out=[];
  for(let i=1;i<p.length-2;i++){
    for(let t=0;t<steps;t++){
      const u=t/steps,u2=u*u,u3=u2*u;
      out.push({
        x:.5*((2*p[i].x)+(p[i+1].x-p[i-1].x)*u+(2*p[i-1].x-5*p[i].x+4*p[i+1].x-p[i+2].x)*u2+(-p[i-1].x+3*p[i].x-3*p[i+1].x+p[i+2].x)*u3),
        y:.5*((2*p[i].y)+(p[i+1].y-p[i-1].y)*u+(2*p[i-1].y-5*p[i].y+4*p[i+1].y-p[i+2].y)*u2+(-p[i-1].y+3*p[i].y-3*p[i+1].y+p[i+2].y)*u3),
      });
    }
  }
  out.push(pts[pts.length-1]);
  return out;
}

function tangentAt(pts,i){
  if(pts.length===1) return{x:1,y:0};
  if(i===0) return vNorm(vSub(pts[1],pts[0]));
  if(i===pts.length-1) return vNorm(vSub(pts[i],pts[i-1]));
  return vNorm(vSub(pts[i+1],pts[i-1]));
}

// â”€â”€â”€ parallel ski tracks with taper + wobble â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function parallelTracks(pts,halfW,taperFrac,seed,wobble){
  const n=pts.length;
  const left=[],right=[];
  // detect closed path (loop like O, 0, 8)
  const closed=n>4&&vLen(vSub(pts[0],pts[n-1]))<halfW*3;

  for(let i=0;i<n;i++){
    const t=i/(n-1);
    const tf=closed?1:Math.min(1,t/taperFrac,(1-t)/taperFrac);
    const tang=tangentAt(pts,i);
    const p=vPerp(tang);
    const wL=wobble*dnoise(i*.55,seed);
    const wR=wobble*dnoise(i*.55,seed+19.3);
    const hw=halfW*tf;
    left.push({x:pts[i].x+p.x*(hw+wL),y:pts[i].y+p.y*(hw+wL)});
    right.push({x:pts[i].x-p.x*(hw+wR),y:pts[i].y-p.y*(hw+wR)});
  }
  return{left,right};
}

// â”€â”€â”€ draw one ski track pair â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function drawTrackPair(lp,rp){
  if(lp.length<2) return;

  // very subtle compressed-snow fill between the two tracks
  ctx.beginPath();
  ctx.moveTo(lp[0].x,lp[0].y);
  for(const p of lp) ctx.lineTo(p.x,p.y);
  for(let i=rp.length-1;i>=0;i--) ctx.lineTo(rp[i].x,rp[i].y);
  ctx.closePath();
  ctx.fillStyle='rgba(85,108,158,.1)'; ctx.fill();

  function sline(pts,col,lw,dx,dy){
    ctx.beginPath();
    ctx.moveTo(pts[0].x+dx,pts[0].y+dy);
    for(let i=1;i<pts.length;i++) ctx.lineTo(pts[i].x+dx,pts[i].y+dy);
    ctx.strokeStyle=col; ctx.lineWidth=lw;
    ctx.lineCap='round'; ctx.lineJoin='round'; ctx.stroke();
  }

  // deep groove shadow
  sline(lp,'#2e5070',3.2,1.2,2.2);
  sline(rp,'#2e5070',3.2,1.2,2.2);
  // main track line
  sline(lp,'#5882a8',2.2,0,0);
  sline(rp,'#5882a8',2.2,0,0);
  // bright lip highlight (upper-left edge)
  sline(lp,'rgba(230,220,205,.72)',1,-.7,-.9);
  sline(rp,'rgba(230,220,205,.72)',1,-.7,-.9);
}

// â”€â”€â”€ snow spray at track edges â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function drawSpray(lp,rp,seed){
  ctx.save();
  ctx.lineCap='round';
  const stride=Math.max(2,Math.floor(lp.length/10));

  for(let i=stride;i<lp.length-stride;i+=stride){
    const tang=tangentAt(lp,i);
    const n=vPerp(tang);

    // spray outward from left track
    for(let k=0;k<3;k++){
      const ang=(k-1)*.48;
      const nx=n.x*Math.cos(ang)-n.y*Math.sin(ang);
      const ny=n.x*Math.sin(ang)+n.y*Math.cos(ang);
      const len=2+Math.abs(dnoise(i*.4+k*6,seed))*3.5;
      ctx.globalAlpha=.12+Math.abs(dnoise(i*.3+k,seed+5))*.18;
      ctx.strokeStyle='rgba(220,210,195,.8)'; ctx.lineWidth=.9;
      ctx.beginPath(); ctx.moveTo(lp[i].x,lp[i].y);
      ctx.lineTo(lp[i].x+nx*len,lp[i].y+ny*len); ctx.stroke();
    }

    // spray outward from right track
    const tang2=tangentAt(rp,i);
    const n2=vPerp(tang2);
    for(let k=0;k<3;k++){
      const ang=(k-1)*.48+Math.PI;
      const nx=n2.x*Math.cos(ang)-n2.y*Math.sin(ang);
      const ny=n2.x*Math.sin(ang)+n2.y*Math.cos(ang);
      const len=2+Math.abs(dnoise(i*.4+k*8,seed+3))*3.5;
      ctx.globalAlpha=.12+Math.abs(dnoise(i*.3+k+2,seed+8))*.18;
      ctx.strokeStyle='rgba(220,210,195,.8)'; ctx.lineWidth=.9;
      ctx.beginPath(); ctx.moveTo(rp[i].x,rp[i].y);
      ctx.lineTo(rp[i].x+nx*len,rp[i].y+ny*len); ctx.stroke();
    }
  }
  ctx.restore();
}

// â”€â”€â”€ glyph definitions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Each letter: array of strokes. Each stroke: array of [x,y] points, 0-1 normalized.
// y=0 top, y=1 bottom of cell. Drawn with Catmull-Rom smoothing + parallel ski tracks.
const G={
  ' ':[],
  'A':[ [[.5,.02],[.08,1]],[[.5,.02],[.92,1]],[[.22,.57],[.78,.57]] ],
  'B':[ [[.18,.02],[.18,.98]],[[.18,.02],[.6,.04],[.76,.18],[.7,.46],[.18,.5]],[[.18,.5],[.72,.54],[.82,.7],[.74,.9],[.18,.98]] ],
  'C':[ [[.88,.16],[.6,.03],[.24,.12],[.08,.34],[.08,.66],[.24,.88],[.6,.97],[.88,.84]] ],
  'D':[ [[.18,.02],[.18,.98]],[[.18,.02],[.56,.04],[.84,.2],[.9,.5],[.84,.8],[.56,.96],[.18,.98]] ],
  'E':[ [[.18,.02],[.18,.98]],[[.18,.02],[.84,.02]],[[.18,.5],[.7,.5]],[[.18,.98],[.84,.98]] ],
  'F':[ [[.18,.02],[.18,.98]],[[.18,.02],[.84,.02]],[[.18,.5],[.7,.5]] ],
  'G':[ [[.88,.16],[.6,.03],[.24,.12],[.08,.34],[.08,.66],[.24,.88],[.6,.97],[.88,.84],[.88,.52],[.5,.52]] ],
  'H':[ [[.15,.02],[.15,.98]],[[.85,.02],[.85,.98]],[[.15,.5],[.85,.5]] ],
  'I':[ [[.5,.02],[.5,.98]] ],
  'J':[ [[.64,.02],[.64,.76],[.52,.93],[.34,.98],[.2,.86]] ],
  'K':[ [[.15,.02],[.15,.98]],[[.84,.04],[.15,.52]],[[.3,.44],[.86,.98]] ],
  'L':[ [[.15,.02],[.15,.98]],[[.15,.98],[.86,.98]] ],
  'M':[ [[.08,.98],[.08,.04],[.5,.6],[.92,.04],[.92,.98]] ],
  'N':[ [[.12,.98],[.12,.04],[.88,.96],[.88,.04]] ],
  'O':[ [[.5,.02],[.14,.18],[.05,.5],[.14,.82],[.5,.98],[.86,.82],[.95,.5],[.86,.18],[.5,.02]] ],
  'P':[ [[.18,.02],[.18,.98]],[[.18,.02],[.64,.04],[.8,.18],[.76,.44],[.18,.5]] ],
  'Q':[ [[.5,.02],[.14,.18],[.05,.5],[.14,.82],[.5,.98],[.86,.82],[.95,.5],[.86,.18],[.5,.02]],[[.62,.76],[.92,1]] ],
  'R':[ [[.18,.02],[.18,.98]],[[.18,.02],[.64,.04],[.8,.18],[.76,.44],[.18,.5]],[[.42,.5],[.88,.98]] ],
  'S':[ [[.84,.16],[.62,.03],[.3,.07],[.14,.24],[.28,.44],[.66,.56],[.84,.74],[.72,.9],[.4,.97],[.18,.84]] ],
  'T':[ [[.08,.02],[.92,.02]],[[.5,.02],[.5,.98]] ],
  'U':[ [[.14,.02],[.14,.76],[.22,.93],[.5,.98],[.78,.93],[.86,.76],[.86,.02]] ],
  'V':[ [[.08,.02],[.5,.98],[.92,.02]] ],
  'W':[ [[.04,.04],[.24,.98],[.5,.52],[.76,.98],[.96,.04]] ],
  'X':[ [[.08,.04],[.92,.98]],[[.92,.04],[.08,.98]] ],
  'Y':[ [[.08,.04],[.5,.52]],[[.92,.04],[.5,.52]],[[.5,.52],[.5,.98]] ],
  'Z':[ [[.1,.04],[.9,.04],[.1,.96],[.9,.96]] ],
  '0':[ [[.5,.02],[.14,.18],[.05,.5],[.14,.82],[.5,.98],[.86,.82],[.95,.5],[.86,.18],[.5,.02]] ],
  '1':[ [[.3,.18],[.52,.04],[.52,.98]] ],
  '2':[ [[.18,.2],[.32,.06],[.68,.06],[.84,.22],[.84,.42],[.12,.9],[.88,.9]] ],
  '3':[ [[.16,.1],[.5,.02],[.86,.16],[.82,.44],[.5,.52]],[[.5,.52],[.84,.56],[.9,.8],[.74,.94],[.42,.98],[.18,.88]] ],
  '4':[ [[.72,.04],[.1,.66],[.9,.66]],[[.72,.04],[.72,.98]] ],
  '5':[ [[.84,.06],[.16,.06],[.16,.48],[.56,.42],[.82,.56],[.84,.76],[.7,.94],[.3,.98],[.14,.86]] ],
  '6':[ [[.8,.12],[.52,.02],[.22,.18],[.1,.48],[.14,.78],[.36,.96],[.66,.96],[.82,.76],[.76,.52],[.5,.5],[.22,.55]] ],
  '7':[ [[.1,.06],[.9,.06],[.38,.98]] ],
  '8':[ [[.5,.5],[.16,.36],[.16,.16],[.36,.02],[.64,.02],[.84,.16],[.84,.36],[.5,.5]],[[.5,.5],[.84,.64],[.84,.84],[.64,.98],[.36,.98],[.16,.84],[.16,.64],[.5,.5]] ],
  '9':[ [[.22,.88],[.5,.98],[.8,.82],[.9,.52],[.86,.22],[.64,.04],[.36,.06],[.18,.26],[.22,.52],[.5,.52],[.8,.46]] ],
  '!':[ [[.5,.04],[.5,.68]],[[.44,.84],[.56,.84]] ],
  '?':[ [[.24,.2],[.4,.05],[.64,.05],[.8,.22],[.8,.4],[.52,.62],[.5,.72]],[[.44,.84],[.56,.84]] ],
  '.':[ [[.38,.88],[.5,.96],[.62,.88]] ],
  ',':[ [[.48,.82],[.42,.98]] ],
  '-':[ [[.18,.5],[.82,.5]] ],
  "'":[ [[.5,.04],[.46,.2]] ],
  '/':[ [[.8,.04],[.2,.98]] ],
};

// â”€â”€â”€ letter layout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const CELL_W=52, CELL_H=72;
const SQUISH=.68;       // vertical squish â†’ looks like letters lie flat on slope
const CELL_SP=8;        // spacing between letters
const HALF_W=3.2;       // half-width of ski track (px, before scale)
const TAPER=.2;         // fraction of stroke for taper in/out
const SMPTH=9;          // catmull-rom steps
const WOBBLE=1.4;       // wobble amplitude

let skiLetters=[];

function layoutSkiText(text){
  skiLetters=[];
  if(!text) return;
  const chars=[...text];
  const adv=(ch)=>(ch===' '?CELL_W*.52:CELL_W+CELL_SP);
  const totalW=chars.reduce((s,ch)=>s+adv(ch),0)-CELL_SP;
  const maxW=W-44;
  const sc=totalW>maxW?maxW/totalW:1;
  const cW=CELL_W*sc, cH=CELL_H*sc*SQUISH, sp=CELL_SP*sc;
  const halfW=Math.max(1.5,HALF_W*sc);

  let cx=(W-totalW*sc)/2;
  const baseY=H*.80;

  for(const ch of chars){
    const a=adv(ch)*sc;
    skiLetters.push({
      ch,x:cx,y:baseY-cH,w:cW,h:cH,
      cx:cx+a/2,
      seed:ch.charCodeAt(0)*1.73+cx*.07,
      halfW,prog:0,
    });
    cx+=a;
  }
}

function drawSkiLetters(skierX){
  for(const L of skiLetters){
    if(skierX>=L.cx+14) L.prog=Math.min(1,L.prog+.055);
    if(L.prog<=0) continue;
    const glyph=G[L.ch]||[];
    ctx.save();
    ctx.globalAlpha=L.prog;

    for(let si=0;si<glyph.length;si++){
      const raw=glyph[si];
      if(raw.length<2) continue;
      const pts=raw.map(([nx,ny])=>({x:L.x+nx*L.w,y:L.y+ny*L.h}));
      const smooth=spline(pts,SMPTH);
      const seed=L.seed+si*37.4;
      const{left,right}=parallelTracks(smooth,L.halfW,TAPER,seed,WOBBLE);
      drawTrackPair(left,right);
      drawSpray(left,right,seed+100);
    }
    ctx.restore();
  }
}

// â”€â”€â”€ state â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let condition='sunny', weatherInfo=null;
let particles=[], skiTracks=[];
let animFrame=null, animStart=null, animDur=6000, animDone=false;
let skierX=-80, skierY=H*.63;

// â”€â”€â”€ api key (hardcoded) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const OWM_KEY='9551a6d3ee093363bf75dcafd0d3de77';

// â”€â”€â”€ weather â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function fetchWeather(lat,lon){
  try{
    setStatus('Fetching live weatherâ€¦');
    const url=`https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lon}&appid=${OWM_KEY}&units=metric`;
    const r=await fetch(url);
    const d=await r.json();
    console.log('[PowderPost] weather response:', d);
    if(!r.ok) throw new Error(`API ${r.status}: ${d.message||''}`);
    return{condition:mapCode(d.weather[0].id),temp:Math.round(d.main.temp),desc:d.weather[0].description};
  }catch(e){
    console.error('[PowderPost] weather fetch failed:',e);
    setStatus('Weather fetch failed â€” using clear sky');
    return{condition:'sunny',temp:'-8',desc:'Clear sky'};
  }
}
function mapCode(id){
  if(id===800) return'sunny';
  if(id>=801&&id<=804) return'overcast';
  if(id>=600&&id<=622) return'snowing';
  if((id>=200&&id<=232)||id>=900) return'storm';
  return'overcast';
}

// â”€â”€â”€ particles â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function initParticles(cond){
  const n=cond==='storm'?280:cond==='snowing'?140:0;
  particles=Array.from({length:n},()=>makeP(cond,true));
}
function makeP(cond,randY){
  const storm=cond==='storm';
  return{x:Math.random()*W+(storm?-60:0),y:randY?Math.random()*H:-8,
    sz:Math.random()*(storm?2.5:2)+.5,spd:Math.random()*(storm?4.5:2)+.8,
    dr:(Math.random()-.5)*(storm?7:.8),op:Math.random()*.5+.3};
}
function updateParticles(cond){
  const wd=cond==='storm'?3.5:0;
  for(const p of particles){
    p.y+=p.spd; p.x+=p.dr+wd;
    if(p.y>H+10||p.x<-30||p.x>W+30){
      p.y=-8; p.x=Math.random()*W+(cond==='storm'?-60:0);
      p.spd=Math.random()*(cond==='storm'?4.5:2)+.8;
      p.dr=(Math.random()-.5)*(cond==='storm'?7:.8);
    }
  }
}

// â”€â”€â”€ wind-line seeds â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const WIND_SEEDS=Array.from({length:25},()=>({
  xr:Math.random(),yo:Math.random()*H,
  len:38+Math.random()*90,spd:.25+Math.random()*.6,
  op:.03+Math.random()*.05
}));

// â”€â”€â”€ scene drawing â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function drawParticles(cond){
  if(!particles.length) return;
  ctx.save();
  for(const p of particles){
    ctx.globalAlpha=p.op;
    ctx.fillStyle=cond==='storm'?'#b0c4d4':'#ffffff';
    ctx.beginPath(); ctx.arc(p.x,p.y,p.sz,0,Math.PI*2); ctx.fill();
  }
  ctx.restore();
}

function drawWind(t){
  ctx.save();
  for(const s of WIND_SEEDS){
    const y=(s.yo+t*s.spd*.2)%H;
    ctx.globalAlpha=s.op; ctx.strokeStyle='#a0b8cc'; ctx.lineWidth=1.1;
    ctx.beginPath(); ctx.moveTo(s.xr*W,y); ctx.lineTo(s.xr*W+s.len,y+4); ctx.stroke();
  }
  ctx.restore();
}

function drawSkiTracks(tracks){
  if(tracks.length<2) return;
  ctx.save();
  ctx.strokeStyle='rgba(148,175,210,.5)'; ctx.lineWidth=1.5; ctx.lineCap='round';
  for(const off of[-4,4]){
    ctx.beginPath();
    ctx.moveTo(tracks[0].x,tracks[0].y+off);
    for(let i=1;i<tracks.length;i++) ctx.lineTo(tracks[i].x,tracks[i].y+off);
    ctx.stroke();
  }
  ctx.restore();
}

function drawVignette(){
  const g=ctx.createRadialGradient(W/2,H/2,H*.25,W/2,H/2,H*.85);
  g.addColorStop(0,'rgba(0,0,0,0)'); g.addColorStop(1,'rgba(0,0,0,.28)');
  ctx.fillStyle=g; ctx.fillRect(0,0,W,H);
}

function drawLabel(){
  const sel=document.getElementById('resort');
  const name=sel.options[sel.selectedIndex]?.text||'';
  const date=new Date().toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'});
  ctx.save();
  ctx.font="11px 'Inter',sans-serif";
  ctx.fillStyle='rgba(255,255,255,.52)';
  ctx.textAlign='right';
  ctx.fillText(`${name}  Â·  ${date}`,W-14,H-12);
  ctx.restore();
}

// â”€â”€â”€ main skier â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function drawSkier(x,y,t){
  ctx.save(); ctx.translate(x,y);
  ctx.translate(0,Math.sin(t*.009)*2.2);

  if(condition==='sunny'){
    ctx.save(); ctx.globalAlpha=.14; ctx.fillStyle='#1a3a5a';
    ctx.scale(1.6,.35); ctx.translate(-4,46);
    ctx.beginPath(); ctx.ellipse(0,0,22,7,0,0,Math.PI*2); ctx.fill();
    ctx.restore();
  }

  ctx.save(); ctx.rotate(-.06);
  ctx.fillStyle='#180800';
  ctx.roundRect(-23,9,44,3.5,1.5); ctx.fill();
  ctx.fillStyle='#3a1808'; ctx.fillRect(-22,9.5,42,1);
  ctx.fillStyle='#180800';
  ctx.roundRect(-19,14,44,3.5,1.5); ctx.fill();
  ctx.restore();

  ctx.fillStyle='#10102a';
  ctx.roundRect(-9,4,9,7,2); ctx.fill();
  ctx.roundRect(-4,9,9,7,2); ctx.fill();

  ctx.fillStyle='#1a3870';
  ctx.roundRect(-9,-5,9,11,2); ctx.fill();
  ctx.roundRect(-3,-1,9,12,2); ctx.fill();

  ctx.fillStyle='#cc2020';
  ctx.roundRect(-11,-21,20,18,3); ctx.fill();
  ctx.fillStyle='#fff'; ctx.fillRect(-11,-13,20,2);

  ctx.save(); ctx.rotate(-.28);
  ctx.fillStyle='#cc2020'; ctx.roundRect(-18,-18,10,5,2); ctx.fill(); ctx.restore();
  ctx.save(); ctx.rotate(.22);
  ctx.fillStyle='#cc2020'; ctx.roundRect(8,-18,10,5,2); ctx.fill(); ctx.restore();

  ctx.strokeStyle='#999'; ctx.lineWidth=1.5;
  ctx.beginPath(); ctx.moveTo(-18,-14); ctx.lineTo(-23,10); ctx.stroke();
  ctx.beginPath(); ctx.arc(-23,10,2.5,0,Math.PI*2); ctx.strokeStyle='#777'; ctx.lineWidth=1; ctx.stroke();
  ctx.strokeStyle='#999'; ctx.lineWidth=1.5;
  ctx.beginPath(); ctx.moveTo(17,-14); ctx.lineTo(22,10); ctx.stroke();
  ctx.beginPath(); ctx.arc(22,10,2.5,0,Math.PI*2); ctx.strokeStyle='#777'; ctx.lineWidth=1; ctx.stroke();

  ctx.fillStyle='#f5c0a8'; ctx.fillRect(-3,-27,6,8);
  ctx.fillStyle='#f5c0a8'; ctx.beginPath(); ctx.arc(0,-32,9,0,Math.PI*2); ctx.fill();
  ctx.fillStyle='#cc2020'; ctx.beginPath(); ctx.arc(0,-34,9,Math.PI,0); ctx.fill();
  ctx.fillRect(-9,-34,18,5);
  ctx.fillStyle='#e8c020'; ctx.roundRect(-8,-34,16,8,2.5); ctx.fill();
  ctx.fillStyle='#1a3a5a'; ctx.roundRect(-7,-33,6,6,2); ctx.fill(); ctx.roundRect(1,-33,6,6,2); ctx.fill();
  ctx.fillStyle='rgba(255,255,255,.3)'; ctx.roundRect(-6,-32,2,2,1); ctx.fill(); ctx.roundRect(2,-32,2,2,1); ctx.fill();

  ctx.restore();
}

// â”€â”€â”€ skier position â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function skierPos(t){
  const raw=Math.min(t/animDur,1);
  const p=raw<.08?raw/.08*.04:raw>.92?1-((1-raw)/.08*.04):0.04+(raw-.08)*.96/.84;
  return{x:-90+p*(W+180),y:H*.628+Math.sin(p*Math.PI*5)*7,raw};
}

// â”€â”€â”€ full scene â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function drawScene(t,cond,sx,sy){
  ctx.drawImage(getBg(cond),0,0);
  drawSkiTracks(skiTracks);
  drawSkiLetters(sx);
  if(sx<W+100) drawSkier(sx,sy,t);
  drawParticles(cond);
  if(cond==='storm') drawWind(t);
  drawVignette();
  drawLabel();
}

// â”€â”€â”€ animation loop â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function animate(ts){
  if(!animStart) animStart=ts;
  const t=ts-animStart;
  if(condition==='snowing'||condition==='storm') updateParticles(condition);
  const pos=skierPos(t);
  skierX=pos.x; skierY=pos.y;
  if(skiTracks.length===0||skiTracks[skiTracks.length-1].x<skierX-6)
    skiTracks.push({x:skierX,y:skierY+10});
  drawScene(t,condition,skierX,skierY);
  document.getElementById('progressFill').style.width=(pos.raw*100)+'%';
  if(pos.raw>=1){
    animDone=true;
    document.getElementById('btnExport').disabled=false;
    document.getElementById('btnGo').disabled=false;
    setStatus('Done! Hit Export GIF to download.');
    animFrame=requestAnimationFrame(idleTick);
    return;
  }
  animFrame=requestAnimationFrame(animate);
}

let idleStart=null;
function idleTick(ts){
  if(!idleStart) idleStart=ts;
  const t=ts-idleStart+animDur;
  if(condition==='snowing'||condition==='storm') updateParticles(condition);
  drawScene(t,condition,skierX,skierY);
  animFrame=requestAnimationFrame(idleTick);
}

// â”€â”€â”€ start â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function start(){
  const msg=document.getElementById('message').value.trim().toUpperCase();
  if(!msg){setStatus('Please enter a message!');return;}
  if(animFrame){cancelAnimationFrame(animFrame);animFrame=null;}
  document.getElementById('btnGo').disabled=true;
  document.getElementById('btnExport').disabled=true;
  document.getElementById('progressFill').style.width='0%';
  animStart=null; animDone=false; skiTracks=[]; idleStart=null;

  const sel=document.getElementById('resort');
  const [lat,lon]=sel.value.split(',').map(Number);
  const resortName=sel.options[sel.selectedIndex].text;

  const w=await fetchWeather(lat,lon);
  condition=w.condition; weatherInfo=w;
  bgCanvas=null; // invalidate bg cache so it rebuilds for new condition

  const badge=document.getElementById('weatherBadge');
  const emo={sunny:'â˜€ï¸',snowing:'â„ï¸',overcast:'â˜ï¸',storm:'ðŸŒ¨ï¸'};
  badge.textContent=`${emo[w.condition]} ${w.desc} Â· ${w.temp}Â°C`;
  badge.style.display='block';
  setStatus(`${resortName}: ${w.desc}, ${w.temp}Â°C`);

  initParticles(condition);
  layoutSkiText(msg);
  animDur=2800+msg.length*230;
  animFrame=requestAnimationFrame(animate);
}

// â”€â”€â”€ GIF export â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function exportGif(){
  setStatus('Preparing GIFâ€¦ fetching encoder workerâ€¦');
  document.getElementById('btnExport').disabled=true;
  try{
    const wres=await fetch('https://cdnjs.cloudflare.com/ajax/libs/gif.js/0.2.0/gif.worker.js');
    const wtxt=await wres.text();
    const wurl=URL.createObjectURL(new Blob([wtxt],{type:'application/javascript'}));
    const gif=new GIF({workers:2,quality:8,width:W,height:H,workerScript:wurl});

    const FPS=12, fDelay=Math.round(1000/FPS);
    const steps=Math.ceil(animDur/(1000/FPS));

    // save letter progress, reset for re-render
    const savedProg=skiLetters.map(l=>l.prog);
    for(const l of skiLetters) l.prog=0;
    const savedTracks=[...skiTracks];
    const exportTracks=[];

    initParticles(condition);
    setStatus('Rendering framesâ€¦');

    for(let i=0;i<=steps;i++){
      const t=(i/steps)*animDur;
      const pos=skierPos(t);
      if(condition==='snowing'||condition==='storm') updateParticles(condition);
      if(exportTracks.length===0||exportTracks[exportTracks.length-1].x<pos.x-6)
        exportTracks.push({x:pos.x,y:pos.y+10});
      const sv=skiTracks; skiTracks=exportTracks;
      drawScene(t,condition,pos.x,pos.y);
      skiTracks=sv;
      gif.addFrame(canvas,{copy:true,delay:fDelay});
      if(i%10===0) setStatus(`Rendering frame ${i}/${steps}â€¦`);
    }

    // restore
    for(let i=0;i<skiLetters.length;i++) skiLetters[i].prog=savedProg[i]||1;
    skiTracks=savedTracks;

    gif.on('progress',p=>setStatus(`Encoding GIF: ${Math.round(p*100)}%`));
    gif.on('finished',blob=>{
      URL.revokeObjectURL(wurl);
      const url=URL.createObjectURL(blob);
      const a=document.createElement('a');
      a.href=url; a.download='powder-post.gif';
      document.body.appendChild(a); a.click(); document.body.removeChild(a);
      setTimeout(()=>URL.revokeObjectURL(url),60000);
      setStatus('GIF downloaded!');
      document.getElementById('btnExport').disabled=false;
    });

    gif.render();
  }catch(e){
    console.error(e);
    setStatus('Export failed: '+e.message);
    document.getElementById('btnExport').disabled=false;
  }
}

// â”€â”€â”€ helpers / events â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setStatus(msg){document.getElementById('status').textContent=msg;}

document.getElementById('btnGo').addEventListener('click',start);
document.getElementById('btnExport').addEventListener('click',exportGif);
document.getElementById('message').addEventListener('keydown',e=>{if(e.key==='Enter')start();});

// â”€â”€â”€ initial render â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
(function init(){
  layoutSkiText('SEND POWDER!');
  drawScene(0,'sunny',-200,H*.628);
})();
</script>
</body>
</html>
