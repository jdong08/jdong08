<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Powder Post</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/gif.js/0.2.0/gif.js"></script>
<style>
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:'Inter',sans-serif;background:linear-gradient(160deg,#0a1628,#0f2040 50%,#0a1628);color:#d8eaf8;min-height:100vh;display:flex;flex-direction:column;align-items:center;padding:28px 16px 40px}
h1{font-family:'Playfair Display',serif;font-size:2.4rem;color:#f0f8ff;letter-spacing:-.5px;margin-bottom:4px}
.subtitle{color:#6a90b0;font-size:.88rem;margin-bottom:22px}
.panel{width:100%;max-width:820px;background:rgba(15,30,55,.7);border:1px solid rgba(80,140,200,.18);border-radius:14px;padding:16px 18px;display:flex;flex-direction:column;gap:12px;margin-bottom:14px}
.row{display:flex;flex-wrap:wrap;gap:12px;align-items:flex-end}
.fg{display:flex;flex-direction:column;gap:5px}
.fg.grow{flex:1;min-width:180px}
label{font-size:.7rem;font-weight:600;text-transform:uppercase;letter-spacing:.08em;color:#5a8ab0}
select,input[type=text]{background:#0d2038;border:1px solid #1e4060;color:#d8eaf8;padding:9px 12px;border-radius:8px;font-family:'Inter',sans-serif;font-size:.88rem;outline:none;transition:border-color .2s;width:100%}
select:focus,input[type=text]:focus{border-color:#3a8cd0}
.btns{display:flex;gap:8px;flex-wrap:wrap}
button{padding:10px 22px;border:none;border-radius:8px;font-family:'Inter',sans-serif;font-weight:600;font-size:.9rem;cursor:pointer;transition:all .2s;white-space:nowrap}
.btn-go{background:#1a6ec0;color:#fff}.btn-go:hover{background:#2280dc}.btn-go:disabled{background:#12304a;color:#2a5070;cursor:default}
.btn-export{background:#0d3020;color:#4dcc80;border:1px solid #1a6035}.btn-export:hover{background:#155030}.btn-export:disabled{opacity:.35;cursor:default}
.canvas-wrap{position:relative;border-radius:12px;overflow:hidden;width:100%;max-width:820px;box-shadow:0 24px 64px rgba(0,0,0,.6),0 0 0 1px rgba(80,140,200,.15)}
canvas{display:block;width:100%;height:auto}
.weather-badge{position:absolute;top:10px;right:10px;background:rgba(0,0,0,.45);backdrop-filter:blur(8px);border-radius:20px;padding:4px 13px;font-size:.78rem;color:#fff;display:none;border:1px solid rgba(255,255,255,.12)}
.progress-wrap{width:100%;max-width:820px;height:3px;background:#0d2038;border-radius:2px;margin-top:10px;overflow:hidden}
.progress-fill{height:100%;background:#2a8cd0;border-radius:2px;width:0%;transition:width .12s}
.status{font-size:.78rem;color:#4a7090;margin-top:7px;min-height:18px;text-align:center}
.home-btn{position:fixed;top:14px;left:16px;display:flex;align-items:center;gap:6px;padding:7px 13px;background:rgba(15,30,55,.75);border:1px solid rgba(80,140,200,.2);border-radius:20px;color:#6a90b0;font-family:'Inter',sans-serif;font-size:.78rem;font-weight:500;text-decoration:none;transition:all .2s;backdrop-filter:blur(8px);z-index:100}
.home-btn:hover{color:#a8caec;border-color:rgba(80,140,200,.45);background:rgba(20,40,70,.85)}
.home-btn svg{opacity:.7}
.swatches{display:flex;gap:7px;flex-wrap:wrap;align-items:center}
.swatch{width:22px;height:22px;border-radius:50%;border:2px solid transparent;cursor:pointer;transition:transform .15s,border-color .15s;flex-shrink:0}
.swatch:hover{transform:scale(1.15)}
.swatch.active{border-color:#fff;box-shadow:0 0 0 1px rgba(255,255,255,.3);transform:scale(1.15)}
@keyframes powderPulse{0%,100%{opacity:.88}50%{opacity:1}}
.powder-alert{position:absolute;top:10px;left:10px;background:rgba(10,40,110,.84);backdrop-filter:blur(8px);border:1px solid rgba(120,180,255,.4);border-radius:20px;padding:4px 14px;font-size:.78rem;color:#b8ddff;font-family:'Inter',sans-serif;font-weight:600;letter-spacing:.04em;display:none;animation:powderPulse 2.2s ease-in-out infinite}
</style>
</head>
<body>
<a href="https://justinadong.com" class="home-btn">
  <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
  justinadong.com
</a>
<h1>â›· Powder Post</h1>
<p class="subtitle">Pick a resort Â· fetch the weather Â· carve your message into the snow</p>

<div class="panel">
  <div class="row">
    <div class="fg" style="min-width:210px">
      <label>Resort</label>
      <select id="resort">
        <optgroup label="Alps">
          <option value="46.0956,7.2272">Verbier</option><option value="46.0207,7.7491">Zermatt</option>
          <option value="45.9237,6.8694">Chamonix</option><option value="46.4985,9.8355">St. Moritz</option>
          <option value="45.4148,6.6340">Courchevel</option><option value="45.4036,6.5619">MÃ©ribel</option>
          <option value="45.4483,6.9794">Val d'IsÃ¨re</option><option value="45.5688,6.8152">Les Arcs</option>
          <option value="45.5048,6.6779">La Plagne</option><option value="45.4693,6.9020">Tignes</option>
          <option value="45.8570,6.6160">MegÃ¨ve</option><option value="46.0009,6.6822">Flaine</option>
          <option value="46.1783,6.7097">Morzine</option><option value="46.1925,6.7759">Avoriaz</option>
          <option value="46.1575,6.6683">Les Gets</option><option value="46.1091,7.9285">Saas-Fee</option>
          <option value="46.6244,8.0411">Grindelwald</option><option value="46.6081,7.9218">Wengen</option>
          <option value="46.8028,9.8374">Davos</option><option value="46.8735,9.8787">Klosters</option>
          <option value="46.5404,12.1357">Cortina d'Ampezzo</option><option value="45.7996,6.9691">Courmayeur</option>
          <option value="45.9389,7.7316">Cervinia</option><option value="46.2305,10.8279">Madonna di Campiglio</option>
          <option value="47.4464,12.3927">KitzbÃ¼hel</option><option value="47.1281,10.2689">St. Anton</option>
          <option value="47.2082,10.1416">Lech</option><option value="46.9994,10.2891">Ischgl</option>
          <option value="46.9610,10.9394">SÃ¶lden</option><option value="47.1666,11.8672">Mayrhofen</option>
          <option value="47.1080,13.1346">Bad Gastein</option><option value="47.3878,12.6379">Saalbach</option>
          <option value="47.3924,13.6893">Schladming</option><option value="46.5378,10.1366">Livigno</option>
          <option value="42.5463,1.7101">Andorra Grandvalira</option>
        </optgroup>
        <optgroup label="Northeast USA">
          <option value="44.5290,-72.7823">Stowe</option><option value="43.6775,-72.7812">Killington</option>
          <option value="44.1372,-72.8951">Sugarbush</option><option value="44.1892,-72.8615">Mad River Glen</option>
          <option value="43.4036,-72.5237">Okemo</option><option value="43.1125,-72.9076">Stratton</option>
          <option value="42.9593,-72.9223">Mount Snow</option><option value="43.2094,-72.9618">Bromley</option>
          <option value="44.4133,-72.8704">Bolton Valley</option><option value="44.5617,-72.7901">Smugglers' Notch</option>
          <option value="44.4711,-70.8556">Sunday River</option><option value="45.0317,-70.3131">Sugarloaf</option>
          <option value="44.8887,-70.5167">Saddleback</option><option value="44.0356,-71.6246">Loon</option>
          <option value="44.1578,-71.6999">Cannon</option><option value="43.9738,-71.5148">Waterville Valley</option>
          <option value="44.2619,-71.4428">Bretton Woods</option><option value="44.2597,-71.2388">Wildcat</option>
          <option value="42.2020,-74.2285">Hunter</option><option value="42.2994,-74.2566">Windham</option>
          <option value="42.1556,-74.5079">Belleayre</option><option value="44.3658,-73.9027">Whiteface</option>
          <option value="43.6778,-74.0009">Gore</option><option value="42.5095,-73.3165">Jiminy Peak</option>
          <option value="42.4986,-71.8881">Wachusett</option><option value="42.0959,-73.3685">Ski Butternut</option>
        </optgroup>
        <optgroup label="North America (West)">
          <option value="50.1163,-122.9574">Whistler</option><option value="39.1911,-106.8175">Aspen</option>
          <option value="43.5875,-110.8278">Jackson Hole</option><option value="40.6514,-111.5080">Park City</option>
          <option value="37.6308,-119.0326">Mammoth</option><option value="39.6433,-106.3781">Vail</option>
          <option value="51.1784,-115.5708">Banff</option><option value="51.0160,-118.1960">Revelstoke</option>
        </optgroup>
        <optgroup label="Japan">
          <option value="42.8042,140.6872">Niseko</option><option value="36.6986,137.8614">Hakuba</option>
        </optgroup>
        <optgroup label="Southern Hemisphere">
          <option value="-45.0312,168.6626">Queenstown</option>
        </optgroup>
      </select>
    </div>
    <div class="fg grow">
      <label>Message (max 20 chars)</label>
      <input type="text" id="message" value="SEND POWDER!" maxlength="20" placeholder="Your message...">
    </div>
    <div class="btns">
      <button class="btn-go" id="btnGo">Go â–¶</button>
      <button class="btn-export" id="btnExport" disabled>Export GIF â†“</button>
    </div>
  </div>
  <div class="row" style="align-items:center">
    <div class="fg">
      <label>Outfit color</label>
      <div class="swatches" id="swatches">
        <div class="swatch active" data-color="#cc2020" style="background:#cc2020" title="Red"></div>
        <div class="swatch" data-color="#d06010" style="background:#d06010" title="Orange"></div>
        <div class="swatch" data-color="#1848c0" style="background:#1848c0" title="Blue"></div>
        <div class="swatch" data-color="#0f6e30" style="background:#0f6e30" title="Green"></div>
        <div class="swatch" data-color="#b82868" style="background:#b82868" title="Pink"></div>
        <div class="swatch" data-color="#601ac0" style="background:#601ac0" title="Purple"></div>
        <div class="swatch" data-color="#1a1a3a" style="background:#1a1a3a;border:1px solid rgba(255,255,255,.15)" title="Navy"></div>
        <div class="swatch" data-color="#d8d8d8" style="background:#d8d8d8" title="White"></div>
      </div>
    </div>
  </div>
</div>

<div class="canvas-wrap">
  <canvas id="canvas" width="800" height="450"></canvas>
  <div class="weather-badge" id="weatherBadge"></div>
  <div class="powder-alert" id="powderAlert">POWDER ALERT â„ï¸</div>
</div>
<div class="progress-wrap"><div class="progress-fill" id="progressFill"></div></div>
<p class="status" id="status">Pick a resort, type your message, and hit Go.</p>

<script>
// â”€â”€â”€ roundRect polyfill â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if(!CanvasRenderingContext2D.prototype.roundRect){
  CanvasRenderingContext2D.prototype.roundRect=function(x,y,w,h,r){
    r=Math.min(r,w/2,h/2);this.beginPath();this.moveTo(x+r,y);
    this.arcTo(x+w,y,x+w,y+h,r);this.arcTo(x+w,y+h,x,y+h,r);
    this.arcTo(x,y+h,x,y,r);this.arcTo(x,y,x+w,y,r);this.closePath();
  };
}

// â”€â”€â”€ canvas / constants â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const canvas=document.getElementById('canvas');
const ctx=canvas.getContext('2d');
const W=800,H=450;
const HORIZON=Math.round(H*.32); // ~144px â€” sky/slope split
const OWM_KEY='9551a6d3ee093363bf75dcafc0d3de77';

// Sun is from upper-right â†’ shadows point lower-left
const SHADOW_DX=-0.55, SHADOW_DY=0.85;

// â”€â”€â”€ seeded RNG â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function mkRng(seed){
  let s=seed|0;
  return function(){s^=s<<13;s^=s>>17;s^=s<<5;return(s>>>0)/0x100000000;};
}

// â”€â”€â”€ snow palette â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const SNOW_PAL={
  sunny:  {base:'#f2ede2',hi:'#faf7f0',sh:'#bec8e0'},
  snowing:{base:'#e8eaf2',hi:'#f0f0f8',sh:'#a8b2cc'},
  overcast:{base:'#dcdee6',hi:'#e5e6ec',sh:'#9098b2'},
  storm:  {base:'#c5c8d2',hi:'#ced1d8',sh:'#70789a'},
};

// â”€â”€â”€ offscreen background canvas â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let bgCanvas=null,bgCond=null;
function getBg(cond){
  if(bgCanvas&&bgCond===cond) return bgCanvas;
  bgCanvas=document.createElement('canvas');
  bgCanvas.width=W;bgCanvas.height=H;
  bgCond=cond;
  paintBg(bgCanvas.getContext('2d'),cond);
  return bgCanvas;
}

// â”€â”€â”€ isometric ski slope background â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function paintBg(bx,cond){
  const rng=mkRng(0xdeadbeef);

  // â”€â”€ 1. Sky gradient â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const SKY={
    sunny:  ['#1a3a70','#2c5eaa','#78aacc','#bcd6f0'],
    snowing:['#28304a','#38486c','#5e6e9e','#8ea0c0'],
    overcast:['#222e3e','#304458','#546880','#7e96ae'],
    storm:  ['#141820','#1e2636','#2c3a4e','#445a6a'],
  };
  const sc=SKY[cond]||SKY.sunny;
  const skyG=bx.createLinearGradient(0,0,0,HORIZON);
  skyG.addColorStop(0,sc[0]);skyG.addColorStop(.42,sc[1]);
  skyG.addColorStop(.76,sc[2]);skyG.addColorStop(1,sc[3]);
  bx.fillStyle=skyG; bx.fillRect(0,0,W,HORIZON);

  // â”€â”€ 2. Wispy cloud streaks (clear/snowing only) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  if(cond!=='storm'){
    const crng=mkRng(0xc10ude);
    bx.save();
    for(let i=0;i<(cond==='snowing'?3:7);i++){
      const cy=10+crng()*(HORIZON*.52), cx=50+crng()*(W-100);
      const cr=20+crng()*44;
      bx.globalAlpha=(cond==='snowing'?.04:.08)+crng()*.06;
      bx.fillStyle='#d4ecff';
      for(let j=0;j<4;j++){
        bx.beginPath();
        bx.ellipse(cx+j*cr*.38,cy+crng()*7,cr*.6+crng()*cr*.28,cr*.22+crng()*6,-Math.PI*.04,0,Math.PI*2);
        bx.fill();
      }
    }
    bx.restore();
  }

  // â”€â”€ 3. Slope base gradient (cool/hazy horizon â†’ warm/bright foreground) â”€â”€â”€â”€â”€â”€â”€
  const SL={
    sunny:  ['#c4d0e2','#d8e4ea','#ecf3ee','#f6faf6'],
    snowing:['#888ea8','#a6acbe','#c6cedd','#d8dde8'],
    overcast:['#7e88a0','#9ea8bc','#bcc4d2','#d0d6e2'],
    storm:  ['#48505e','#5e6a78','#7a8890','#94a0a8'],
  };
  const sl=SL[cond]||SL.sunny;
  const slopeG=bx.createLinearGradient(0,HORIZON,0,H);
  slopeG.addColorStop(0,sl[0]);slopeG.addColorStop(.28,sl[1]);
  slopeG.addColorStop(.62,sl[2]);slopeG.addColorStop(1,sl[3]);
  bx.fillStyle=slopeG; bx.fillRect(0,HORIZON,W,H-HORIZON);

  // â”€â”€ 4. Groomed corduroy â€” convergent lines toward horizon VP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const vpX=W/2, slopeH=H-HORIZON;
  bx.save(); bx.strokeStyle=sl[0];
  for(let i=0;i<=20;i++){
    const t=i/20;
    const xBot=W*(t*1.06-.03);
    const xTop=vpX+(xBot-vpX)*.05;
    const yTop=HORIZON+slopeH*.05;
    bx.globalAlpha=.055+.04*Math.sin(t*Math.PI);
    bx.lineWidth=.7; bx.beginPath();
    bx.moveTo(xTop,yTop); bx.lineTo(xBot,H+2); bx.stroke();
  }
  // horizontal contour lines
  for(let yi=0;yi<13;yi++){
    const yf=yi/12;
    const y=HORIZON+slopeH*(.06+yf*.91);
    bx.globalAlpha=.04+yf*.05; bx.lineWidth=.5+yf*.45;
    bx.beginPath(); bx.moveTo(0,y); bx.lineTo(W,y); bx.stroke();
  }
  bx.restore();

  // â”€â”€ 5. Snow sparkle texture â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  bx.save();
  for(let i=0;i<200;i++){
    const x=rng()*W, y=HORIZON+rng()*(H-HORIZON);
    const yf=(y-HORIZON)/slopeH;
    bx.globalAlpha=(.028+rng()*.04)*(0.3+yf*.9);
    bx.fillStyle=rng()<.55?sl[3]:sl[0];
    bx.fillRect(x,y,8+rng()*28,.6+rng()*1.2);
  }
  bx.restore();

  // â”€â”€ 6. Atmospheric haze band at horizon â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const HAZE={
    sunny:'rgba(188,216,248,.56)',snowing:'rgba(136,160,202,.64)',
    overcast:'rgba(122,148,190,.60)',storm:'rgba(62,80,106,.70)',
  };
  const hazeG=bx.createLinearGradient(0,HORIZON-32,0,HORIZON+54);
  hazeG.addColorStop(0,'rgba(255,255,255,0)');
  hazeG.addColorStop(.40,HAZE[cond]||HAZE.sunny);
  hazeG.addColorStop(1,'rgba(255,255,255,0)');
  bx.fillStyle=hazeG; bx.fillRect(0,HORIZON-32,W,86);

  // â”€â”€ 7. Static scene elements â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  paintChairliftStatic(bx,cond);
  paintPineTrees(bx,cond);
}

// â”€â”€â”€ isometric chairlift: static cable + towers painted into bg â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const LIFT_T={x:Math.round(W*.65),y:HORIZON+16};
const LIFT_B={x:Math.round(W*.79),y:H-14};
function paintChairliftStatic(bx,cond){
  const cc=cond==='storm'?'#4e505e':'#1c1c2c';
  const dx=LIFT_B.x-LIFT_T.x, dy=LIFT_B.y-LIFT_T.y;
  const ang=Math.atan2(dy,dx);
  const px=-Math.sin(ang), py=Math.cos(ang); // perpendicular unit

  // Support towers at 30%, 60%, 85% along cable
  for(const f of[.30,.60,.85]){
    const tx=LIFT_T.x+dx*f, ty=LIFT_T.y+dy*f;
    bx.save(); bx.globalAlpha=.72; bx.fillStyle=cc;
    bx.fillRect(tx-1.6,ty,3.2,11);    // mast down to slope
    bx.fillRect(tx-8,ty-1.5,16,2.5);  // cross arm
    bx.restore();
    // tower shadow on slope
    bx.save(); bx.globalAlpha=.10; bx.fillStyle='#283860';
    bx.beginPath(); bx.ellipse(tx-5,ty+8,6,2.5,0,0,Math.PI*2); bx.fill();
    bx.restore();
  }

  // Cable strands (haul + return)
  for(const off of[0,2.8]){
    bx.save(); bx.strokeStyle=cc;
    bx.lineWidth=off===0?1.25:.6;
    bx.globalAlpha=off===0?.65:.30;
    bx.beginPath();
    bx.moveTo(LIFT_T.x+px*off,LIFT_T.y+py*off);
    bx.lineTo(LIFT_B.x+px*off,LIFT_B.y+py*off);
    bx.stroke(); bx.restore();
  }
}

// â”€â”€â”€ animated chairlift chairs (live render, slide topâ†’bottom) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const N_CHAIRS=5;
function drawChairs(t){
  const dx=LIFT_B.x-LIFT_T.x, dy=LIFT_B.y-LIFT_T.y;
  const spd=0.020; // fraction of cable per second
  for(let i=0;i<N_CHAIRS;i++){
    const frac=((t*spd/1000+i/N_CHAIRS)%1+1)%1;
    const cx=LIFT_T.x+dx*frac, cy=LIFT_T.y+dy*frac;
    if(cy<HORIZON-3) continue;
    // shadow on slope
    ctx.save(); ctx.globalAlpha=.08; ctx.fillStyle='#263860';
    ctx.beginPath(); ctx.ellipse(cx-5,cy+18,9,3.5,0,0,Math.PI*2);
    ctx.fill(); ctx.restore();
    // hanger wire
    ctx.save(); ctx.globalAlpha=.52; ctx.strokeStyle='#18182c'; ctx.lineWidth=.9;
    ctx.beginPath(); ctx.moveTo(cx,cy); ctx.lineTo(cx,cy+10); ctx.stroke();
    ctx.restore();
    // chair back
    ctx.fillStyle='#1e1e2e'; ctx.fillRect(cx-8,cy+10,16,5);
    // chair seat
    ctx.fillStyle='#28283c'; ctx.fillRect(cx-8,cy+15,16,3);
    // footrests
    ctx.save(); ctx.strokeStyle='#14142a'; ctx.lineWidth=1;
    ctx.beginPath();
    ctx.moveTo(cx-6,cy+18); ctx.lineTo(cx-6,cy+23);
    ctx.moveTo(cx+6,cy+18); ctx.lineTo(cx+6,cy+23);
    ctx.stroke(); ctx.restore();
  }
}

// â”€â”€â”€ isometric pine trees â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Each spec: xf=0-1 across canvas, yf=0-1 down slope, s=scale factor
const TREE_SPECS=[
  // left side column
  {xf:.060,yf:.09,s:.42},{xf:.115,yf:.21,s:.50},{xf:.040,yf:.37,s:.58},
  {xf:.100,yf:.55,s:.67},{xf:.065,yf:.74,s:.77},{xf:.130,yf:.91,s:.88},
  // right side column (stay left of chairlift)
  {xf:.940,yf:.08,s:.40},{xf:.880,yf:.20,s:.48},{xf:.960,yf:.35,s:.56},
  {xf:.900,yf:.53,s:.65},{xf:.855,yf:.71,s:.75},{xf:.920,yf:.89,s:.85},
];
function getTreePos(sp){
  return{x:sp.xf*W, y:HORIZON+sp.yf*(H-HORIZON), h:90*sp.s, r:28*sp.s};
}
function paintPineTree(bx,x,y,h,r,cond){
  const storm=cond==='storm';
  // Shadow on slope (sun upper-right â†’ shadow lower-left)
  bx.save(); bx.globalAlpha=storm?.06:.15; bx.fillStyle='#2a3c68';
  bx.beginPath(); bx.ellipse(x-r*.72,y+r*.42,r*1.72,r*.36,Math.PI*.12,0,Math.PI*2);
  bx.fill(); bx.restore();
  // Trunk
  bx.fillStyle='#3a2418';
  bx.fillRect(x-r*.08,y-h*.15,r*.16,h*.16);
  // Three tiers bottomâ†’top
  const G=storm?['#0c1610','#141e14','#1a2818']:['#0e1c0e','#1a3018','#253a22'];
  const snowA=storm?.20:.58;
  const snowC=storm?'rgba(182,198,208,.7)':'rgba(233,246,255,.85)';
  for(const[yf,rf] of[[.62,1.00],[.38,.68],[.18,.42]]){
    const ty=y-h*yf, tr=r*rf;
    // Full triangle (darker right/shadow side)
    bx.fillStyle=G[0];
    bx.beginPath(); bx.moveTo(x,ty-tr*.85); bx.lineTo(x+tr,ty+tr*.30); bx.lineTo(x-tr,ty+tr*.30); bx.closePath(); bx.fill();
    // Left lit face
    bx.fillStyle=G[2];
    bx.beginPath(); bx.moveTo(x,ty-tr*.85); bx.lineTo(x,ty+tr*.30); bx.lineTo(x-tr,ty+tr*.30); bx.closePath(); bx.fill();
    // Snow on upper-left portion
    bx.save(); bx.globalAlpha=snowA; bx.fillStyle=snowC;
    bx.beginPath(); bx.moveTo(x,ty-tr*.85); bx.lineTo(x-tr*.04,ty+tr*.30); bx.lineTo(x-tr*.60,ty+tr*.30); bx.closePath(); bx.fill();
    bx.restore();
  }
}
function paintPineTrees(bx,cond){
  // Painter's order: back (small yf) first, front (large yf) last
  const sorted=[...TREE_SPECS].sort((a,b)=>a.yf-b.yf);
  for(const sp of sorted){
    const{x,y,h,r}=getTreePos(sp);
    paintPineTree(bx,x,y,h,r,cond);
  }
}

// â”€â”€â”€ animated bg skiers â€” isometric slope (slide horizonâ†’foreground) â”€â”€â”€â”€â”€â”€â”€â”€â”€
const SKIER_COLORS=['#cc2020','#c8980e','#1848c0','#c05010','#159838','#b82868','#601ac0'];
const LIVE_BG_SKIERS=(function(){
  const rng=mkRng(0xabcdef12);
  return Array.from({length:5},()=>({
    startX: 55+rng()*(W*.52),        // left half of slope, away from chairlift
    startY: rng()*(H-HORIZON+155),   // staggered so not all at horizon at once
    speed:  0.050+rng()*.04,         // px/ms downhill
    amp:    14+rng()*28,             // carving amplitude
    freq:   0.013+rng()*.009,
    phase:  rng()*Math.PI*2,
    col:    SKIER_COLORS[Math.floor(rng()*SKIER_COLORS.length)],
    sz:     0.40+rng()*.18,
    op:     0.40+rng()*.20,
  }));
})();

const WRAP_H=H-HORIZON+185; // slope height + off-screen margins

function bgSkierY(sk,t){
  // Y on canvas; starts just above horizon, wraps back to horizon
  return HORIZON-58+((sk.startY+sk.speed*t)%WRAP_H+WRAP_H)%WRAP_H;
}
function bgSkierX(sk,y){
  return sk.startX+sk.amp*Math.sin(y*sk.freq+sk.phase);
}

function drawLiveBgSkiers(t){
  for(const sk of LIVE_BG_SKIERS){
    const cy=bgSkierY(sk,t);
    const cx=bgSkierX(sk,cy);
    if(cy<HORIZON-52||cy>H+60) continue;

    // Perspective scale: 0.38 near horizon â†’ 1.0 at bottom
    const pf=cy<HORIZON?0.38:0.38+0.62*((cy-HORIZON)/(H-HORIZON));
    const s=sk.sz*pf;

    ctx.save();

    // â”€â”€ ski tracks: reconstruct last ~1.5 s of path â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const trackPts=[];
    for(let dt=1500;dt>=0;dt-=40){
      const py=bgSkierY(sk,t-dt);
      if(py<=cy&&py>HORIZON-52) trackPts.push({x:bgSkierX(sk,py),y:py});
    }
    trackPts.push({x:cx,y:cy});
    if(trackPts.length>1){
      ctx.save();
      ctx.lineCap='round';ctx.lineJoin='round';ctx.lineWidth=1.0;
      for(const off of[-2.5,2.5]){
        ctx.beginPath();
        ctx.moveTo(trackPts[0].x+off,trackPts[0].y);
        for(const p of trackPts) ctx.lineTo(p.x+off,p.y);
        ctx.globalAlpha=sk.op*.28;
        ctx.strokeStyle='rgba(88,128,194,.9)';
        ctx.stroke();
      }
      ctx.restore();
    }

    // â”€â”€ skier figure â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const py2=bgSkierY(sk,t-80);
    const px2=bgSkierX(sk,py2);
    const rot=py2<cy?Math.atan2(cy-py2,cx-px2):Math.PI/2;

    ctx.translate(cx,cy);
    ctx.rotate(rot);
    ctx.globalAlpha=sk.op;

    // shadow
    ctx.save(); ctx.globalAlpha=sk.op*.20; ctx.fillStyle='#3a5090';
    ctx.beginPath();
    ctx.ellipse(SHADOW_DX*s*10,SHADOW_DY*s*10,s*2,s*7,
      Math.atan2(SHADOW_DY,SHADOW_DX),0,Math.PI*2);
    ctx.fill(); ctx.restore();

    // skis
    ctx.fillStyle='#160c04';
    ctx.fillRect(-s*12,-s*1.4,s*24,s*1.1);
    ctx.fillRect(-s*12,s*.4,s*24,s*1.1);

    // jacket + head
    ctx.fillStyle=sk.col;
    ctx.beginPath(); ctx.ellipse(0,0,s*3.2,s*4.8,0,0,Math.PI*2); ctx.fill();
    ctx.fillStyle='#edba96';
    ctx.beginPath(); ctx.arc(s*3.5,0,s*2.1,0,Math.PI*2); ctx.fill();
    ctx.fillStyle=sk.col;
    ctx.beginPath(); ctx.arc(s*3.5,0,s*2.1,Math.PI*.5,Math.PI*1.5); ctx.fill();

    ctx.restore();
  }
}

// â”€â”€â”€ vector math â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const vSub=(a,b)=>({x:a.x-b.x,y:a.y-b.y});
const vLen=(a)=>Math.sqrt(a.x*a.x+a.y*a.y);
const vNorm=(a)=>{const l=vLen(a)||1;return{x:a.x/l,y:a.y/l};};
const vPerp=(a)=>({x:-a.y,y:a.x});
function dnoise(x,s){return Math.sin(x*13.456+s*7.89)*Math.cos(x*4.321+s*11.1);}

// â”€â”€â”€ catmull-rom spline â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function spline(pts,steps=9){
  if(pts.length===1) return[pts[0]];
  if(pts.length===2){
    const out=[];
    for(let t=0;t<=steps;t++){const u=t/steps;out.push({x:pts[0].x+(pts[1].x-pts[0].x)*u,y:pts[0].y+(pts[1].y-pts[0].y)*u});}
    return out;
  }
  const p=[pts[0],...pts,pts[pts.length-1]],out=[];
  for(let i=1;i<p.length-2;i++){
    for(let t=0;t<steps;t++){
      const u=t/steps,u2=u*u,u3=u2*u;
      out.push({
        x:.5*((2*p[i].x)+(p[i+1].x-p[i-1].x)*u+(2*p[i-1].x-5*p[i].x+4*p[i+1].x-p[i+2].x)*u2+(-p[i-1].x+3*p[i].x-3*p[i+1].x+p[i+2].x)*u3),
        y:.5*((2*p[i].y)+(p[i+1].y-p[i-1].y)*u+(2*p[i-1].y-5*p[i].y+4*p[i+1].y-p[i+2].y)*u2+(-p[i-1].y+3*p[i].y-3*p[i+1].y+p[i+2].y)*u3),
      });
    }
  }
  out.push(pts[pts.length-1]);
  return out;
}
function tangentAt(pts,i){
  if(pts.length===1) return{x:1,y:0};
  if(i===0) return vNorm(vSub(pts[1],pts[0]));
  if(i===pts.length-1) return vNorm(vSub(pts[i],pts[i-1]));
  return vNorm(vSub(pts[i+1],pts[i-1]));
}

// â”€â”€â”€ parallel ski tracks â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function parallelTracks(pts,halfW,taperFrac,seed,wobble){
  const n=pts.length;
  const left=[],right=[];
  const closed=n>4&&vLen(vSub(pts[0],pts[n-1]))<halfW*3;
  for(let i=0;i<n;i++){
    const t=i/(n-1);
    const tf=closed?1:Math.min(1,t/taperFrac,(1-t)/taperFrac);
    const tang=tangentAt(pts,i),p=vPerp(tang);
    const wL=wobble*dnoise(i*.55,seed),wR=wobble*dnoise(i*.55,seed+19.3);
    const hw=halfW*tf;
    left.push({x:pts[i].x+p.x*(hw+wL),y:pts[i].y+p.y*(hw+wL)});
    right.push({x:pts[i].x-p.x*(hw+wR),y:pts[i].y-p.y*(hw+wR)});
  }
  return{left,right};
}

// â”€â”€â”€ draw track pair â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function drawTrackPair(lp,rp){
  if(lp.length<2) return;
  // subtle compressed-snow fill
  ctx.beginPath();
  ctx.moveTo(lp[0].x,lp[0].y);
  for(const p of lp) ctx.lineTo(p.x,p.y);
  for(let i=rp.length-1;i>=0;i--) ctx.lineTo(rp[i].x,rp[i].y);
  ctx.closePath();
  ctx.fillStyle='rgba(80,105,158,.09)'; ctx.fill();

  function sline(pts,col,lw,dx,dy){
    ctx.beginPath();ctx.moveTo(pts[0].x+dx,pts[0].y+dy);
    for(let i=1;i<pts.length;i++) ctx.lineTo(pts[i].x+dx,pts[i].y+dy);
    ctx.strokeStyle=col;ctx.lineWidth=lw;ctx.lineCap='round';ctx.lineJoin='round';ctx.stroke();
  }
  sline(lp,'#28507a',3.4,1.2,2.2); sline(rp,'#28507a',3.4,1.2,2.2); // groove shadow
  sline(lp,'#5280aa',2.2,0,0);     sline(rp,'#5280aa',2.2,0,0);     // main track
  sline(lp,'rgba(235,225,210,.7)',1,-.6,-.9); sline(rp,'rgba(235,225,210,.7)',1,-.6,-.9); // lit lip
}

// â”€â”€â”€ snow spray â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function drawSpray(lp,rp,seed){
  ctx.save(); ctx.lineCap='round';
  const stride=Math.max(2,Math.floor(lp.length/10));
  for(let i=stride;i<lp.length-stride;i+=stride){
    const tang=tangentAt(lp,i),n=vPerp(tang);
    for(const[pts,flip] of[[lp,1],[rp,-1]]){
      for(let k=0;k<3;k++){
        const ang=(k-1)*.5*flip;
        const nx=n.x*Math.cos(ang)-n.y*Math.sin(ang);
        const ny=n.x*Math.sin(ang)+n.y*Math.cos(ang);
        const len=2+Math.abs(dnoise(i*.4+k*6,seed))*3.5;
        ctx.globalAlpha=.1+Math.abs(dnoise(i*.3+k,seed+5))*.18;
        ctx.strokeStyle='rgba(225,215,200,.85)'; ctx.lineWidth=.85;
        ctx.beginPath(); ctx.moveTo(pts[i].x,pts[i].y);
        ctx.lineTo(pts[i].x+nx*len*flip,pts[i].y+ny*len*flip); ctx.stroke();
      }
    }
  }
  ctx.restore();
}

// â”€â”€â”€ cursive glyph definitions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Each glyph: [[x,y],...] normalized; baseline y=0.72, x-height y=0.28, ascender y=0.04, descender y=0.96
// Entry â‰ˆ (0, 0.72)  Exit â‰ˆ (1, 0.60) â€” letters concatenate to form one continuous path
const CG={
  ' ':null,
  'a':[[0,.72],[.15,.40],[.40,.22],[.65,.26],[.76,.50],[.65,.70],[.38,.72],[.14,.66],[.65,.50],[.67,.70],[1,.60]],
  'b':[[.18,.04],[.17,.72],[.30,.50],[.56,.36],[.76,.48],[.76,.66],[.58,.76],[.32,.72],[.58,.68],[.70,.54],[1,.60]],
  'c':[[0,.70],[.10,.44],[.28,.22],[.58,.20],[.80,.36],[.82,.60],[.68,.76],[.40,.80],[.16,.70],[.40,.64],[.72,.56],[1,.60]],
  'd':[[0,.72],[.15,.40],[.40,.22],[.65,.26],[.76,.50],[.65,.70],[.38,.72],[.14,.66],[.65,.48],[.68,.04],[.70,.72],[1,.60]],
  'e':[[0,.64],[.36,.55],[.65,.52],[.80,.62],[.70,.78],[.42,.80],[.15,.64],[.18,.42],[.36,.24],[.64,.22],[.80,.40],[.80,.60],[.68,.72],[.42,.74],[.68,.64],[.78,.54],[1,.60]],
  'f':[[.50,.04],[.58,.70],[.56,.88],[.42,.94],[.26,.88],[.10,.50],[.36,.46],[.62,.44],[1,.44]],
  'g':[[0,.72],[.15,.40],[.40,.22],[.65,.26],[.76,.50],[.65,.70],[.38,.72],[.14,.66],[.65,.48],[.68,.72],[.66,.94],[.52,.98],[.30,.90]],
  'h':[[.15,.04],[.15,.72],[.28,.44],[.52,.32],[.70,.44],[.70,.72],[1,.60]],
  'i':[[0,.70],[.32,.32],[.34,.72],[1,.60]],
  'j':[[0,.70],[.46,.32],[.48,.72],[.46,.94],[.32,.98],[.18,.92]],
  'k':[[.15,.04],[.15,.72],[.15,.52],[.44,.36],[.28,.58],[.64,.72],[1,.60]],
  'l':[[.36,.04],[.38,.72],[1,.60]],
  'm':[[0,.70],[.08,.38],[.26,.28],[.44,.40],[.44,.72],[.56,.38],[.72,.28],[.88,.40],[.88,.72],[1,.60]],
  'n':[[0,.70],[.08,.38],[.28,.28],[.46,.40],[.46,.72],[.64,.38],[.80,.28],[.90,.40],[.90,.72],[1,.60]],
  'o':[[.82,.52],[.68,.26],[.42,.20],[.16,.36],[.10,.58],[.20,.76],[.46,.82],[.74,.72],[.82,.52],[1,.52]],
  'p':[[0,.68],[.14,.38],[.14,.72],[.13,.96],[.26,.98],[.26,.72],[.44,.50],[.66,.38],[.80,.48],[.80,.65],[.62,.76],[.32,.72],[.62,.68],[.74,.54],[1,.60]],
  'q':[[0,.72],[.15,.40],[.40,.22],[.65,.26],[.76,.50],[.65,.70],[.38,.72],[.14,.66],[.65,.48],[.68,.72],[.66,.94],[.78,.98],[.92,.90]],
  'r':[[0,.70],[.08,.36],[.28,.26],[.50,.36],[.56,.60],[.56,.72],[1,.60]],
  's':[[.82,.36],[.60,.24],[.30,.28],[.16,.44],[.28,.58],[.58,.62],[.76,.72],[.52,.80],[.24,.76],[.10,.62],[.26,.52],[.55,.54],[1,.60]],
  't':[[.44,.04],[.44,.72],[.44,.88],[.32,.92],[.22,.86],[.10,.50],[.36,.46],[.64,.44],[.80,.48],[1,.54]],
  'u':[[0,.70],[.10,.36],[.26,.72],[.46,.72],[.64,.36],[.80,.72],[1,.60]],
  'v':[[0,.30],[.38,.72],[.65,.72],[.96,.30],[1,.56]],
  'w':[[0,.30],[.24,.72],[.42,.44],[.58,.72],[.76,.44],[.96,.72],[1,.60]],
  'x':[[0,.28],[.56,.72],[.72,.72],[.30,.34],[.74,.34],[.16,.72],[1,.60]],
  'y':[[0,.70],[.10,.36],[.36,.72],[.55,.72],[.66,.36],[.72,.72],[.68,.94],[.54,.98],[.36,.90]],
  'z':[[0,.28],[.72,.28],[.08,.72],[.80,.72],[1,.60]],
  '0':[[.80,.52],[.62,.24],[.36,.20],[.14,.38],[.10,.58],[.20,.76],[.48,.82],[.76,.70],[.80,.52],[1,.52]],
  '1':[[.26,.32],[.48,.20],[.50,.78],[1,.60]],
  '2':[[.18,.32],[.38,.22],[.66,.26],[.78,.46],[.42,.66],[.10,.78],[.80,.78],[1,.62]],
  '3':[[.20,.28],[.50,.20],[.76,.32],[.70,.52],[.48,.56],[.72,.60],[.72,.72],[.52,.80],[.22,.74],[1,.56]],
  '4':[[.70,.22],[.12,.64],[.84,.64],[.70,.22],[.70,.80],[1,.60]],
  '5':[[.78,.26],[.18,.26],[.15,.52],[.52,.44],[.78,.58],[.78,.70],[.58,.80],[.30,.80],[.14,.72],[1,.52]],
  '6':[[.76,.28],[.52,.20],[.26,.36],[.12,.56],[.14,.72],[.36,.82],[.62,.80],[.78,.66],[.74,.50],[.50,.42],[.24,.48]],
  '7':[[.12,.28],[.82,.28],[.50,.80],[1,.60]],
  '8':[[.50,.52],[.78,.38],[.74,.24],[.50,.20],[.26,.28],[.28,.44],[.50,.52],[.28,.62],[.22,.72],[.38,.84],[.62,.84],[.78,.72],[.72,.58],[.50,.52],[1,.52]],
  '9':[[.78,.46],[.64,.26],[.40,.20],[.18,.36],[.18,.54],[.36,.64],[.62,.64],[.80,.46],[.80,.72],[.78,.90],[.62,.96]],
  '!':[[.46,.12],[.44,.70],[.44,.82],[.50,.88],[.56,.82]],
  '?':[[.22,.38],[.38,.24],[.62,.22],[.78,.38],[.72,.56],[.50,.68],[.50,.80],[.50,.88]],
  '.':[[.38,.80],[.50,.86],[.62,.80],[.50,.74],[.38,.80]],
  ',':[[.40,.76],[.36,.90],[.28,.96]],
  '-':[[.10,.56],[.90,.56]],
  "'":[[.46,.14],[.40,.28]],
};

// â”€â”€â”€ cursive text layout & render â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Letters concatenate into one continuous path per word â€” a single flowing ski track
const CW=50,CH=72,SQUISH=0.60,SPACE_W=26;
const BASE_HALF_W=3.0,TAPER=.10,SMPTH=8,WOBBLE=1.1;

// Skier travels at this y; text baseline sits on the same line
const SKIER_LANE=H*.64;

let cursiveData=null; // {segs:[{pts,x0,x1,revX,seed}], hw}

function layoutCursiveText(text){
  cursiveData=null;
  if(!text) return;
  const msg=text.toLowerCase();

  // total raw width for centering/scaling
  let rawW=0;
  for(const ch of msg) rawW+=(ch===' '?SPACE_W:CW);
  const maxW=W-44;
  const sc=rawW>maxW?maxW/rawW:1;
  const cW=CW*sc, cH=CH*sc*SQUISH, sW=SPACE_W*sc;
  const hw=Math.max(1.4,BASE_HALF_W*sc);
  // baseline sits exactly on SKIER_LANE (glyph baseline is at y=0.72 of cell)
  const cellTop=SKIER_LANE-0.72*cH;

  let cx=(W-rawW*sc)/2;
  const segs=[];
  let cur=[];

  for(const ch of msg){
    if(ch===' '){
      if(cur.length>1) segs.push(mkCursiveSeg(cur));
      cur=[]; cx+=sW; continue;
    }
    const g=CG[ch]||CG['?'];
    if(!g){cx+=cW;continue;}
    // scale normalized glyph points into world space
    const pts=g.map(([x,y])=>({x:cx+x*cW, y:cellTop+y*cH}));
    cur.push(...pts);
    cx+=cW;
  }
  if(cur.length>1) segs.push(mkCursiveSeg(cur));
  cursiveData={segs,hw};
}

function mkCursiveSeg(pts){
  const xs=pts.map(p=>p.x);
  const x0=Math.min(...xs), x1=Math.max(...xs);
  const n=pts.length;
  // each point gets a linear "reveal x" so the path draws leftâ†’right as skier advances
  const revX=pts.map((_,i)=>x0+(i/Math.max(1,n-1))*(x1-x0));
  const seed=pts[0].x*.13+pts[0].y*.07;
  return{pts,x0,x1,revX,seed};
}

function drawCursiveText(skierX){
  if(!cursiveData) return;
  for(const seg of cursiveData.segs){
    if(skierX<seg.x0-30) continue;
    // count how many points the skier has revealed
    let n=0;
    for(let i=0;i<seg.pts.length;i++){
      if(seg.revX[i]<=skierX+18) n=i+1;
    }
    if(n<2) continue;
    const alpha=Math.min(1,(skierX-seg.x0+40)/40);
    ctx.save(); ctx.globalAlpha=alpha;
    const smooth=spline(seg.pts.slice(0,n),SMPTH);
    const{left,right}=parallelTracks(smooth,cursiveData.hw,TAPER,seg.seed,WOBBLE);
    drawTrackPair(left,right);
    if(n>8) drawSpray(left,right,seg.seed+100);
    ctx.restore();
  }
}

// â”€â”€â”€ state â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let condition='sunny',weatherInfo=null;
let particles=[],skiTracks=[];
let animFrame=null,animStart=null,animDur=6000,animDone=false;
let skierX=-80,skierY=SKIER_LANE;
let skierColor='#cc2020';
let windDx=0,isPowder=false;
let powderParticles=[];

// â”€â”€â”€ weather â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function fetchWeather(lat,lon){
  try{
    setStatus('Fetching live weatherâ€¦');
    const url=`https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lon}&appid=${OWM_KEY}&units=metric`;
    const r=await fetch(url);
    const d=await r.json();
    console.log('[PowderPost] weather:',d);
    if(!r.ok) throw new Error(`API ${r.status}: ${d.message||''}`);
    return{condition:mapCode(d.weather[0].id),temp:Math.round(d.main.temp),desc:d.weather[0].description,
      windDeg:d.wind?.deg??270,windSpeed:d.wind?.speed??0,weatherId:d.weather[0].id};
  }catch(e){
    console.error('[PowderPost] fetch failed:',e);
    setStatus('Weather fetch failed â€” using clear sky');
    return{condition:'sunny',temp:-8,desc:'Clear sky',windDeg:270,windSpeed:3,weatherId:800};
  }
}
function mapCode(id){
  if(id===800) return'sunny';
  if(id>=801&&id<=804) return'overcast';
  if(id>=600&&id<=622) return'snowing';
  if((id>=200&&id<=232)||id>=900) return'storm';
  return'overcast';
}

// â”€â”€â”€ particles â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function initParticles(cond){
  const n=cond==='storm'?280:cond==='snowing'?140:0;
  particles=Array.from({length:n},()=>makeP(cond,true));
}
function makeP(cond,randY){
  const storm=cond==='storm';
  return{x:Math.random()*W+(storm?-60:0),y:randY?Math.random()*H:-8,
    sz:Math.random()*(storm?2.5:2)+.5,spd:Math.random()*(storm?4.5:2)+.8,
    dr:(Math.random()-.5)*(storm?7:.8),op:Math.random()*.5+.3};
}
function updateParticles(cond){
  // use real wind data; ensure storms always have at least some drift
  const wd=(cond==='storm'&&Math.abs(windDx)<1.5)?2.5:windDx;
  for(const p of particles){
    p.y+=p.spd;p.x+=p.dr+wd;
    if(p.y>H+10||p.x<-30||p.x>W+30){
      p.y=-8;p.x=Math.random()*W+(cond==='storm'?-60:0);
      p.spd=Math.random()*(cond==='storm'?4.5:2)+.8;
      p.dr=(Math.random()-.5)*(cond==='storm'?7:.8);
    }
  }
}
const WIND_SEEDS=Array.from({length:22},()=>({
  xr:Math.random(),yo:Math.random()*H,len:30+Math.random()*80,
  spd:.2+Math.random()*.5,op:.03+Math.random()*.04
}));

// â”€â”€â”€ scene draw â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function drawParticles(cond){
  if(!particles.length) return;
  ctx.save();
  for(const p of particles){
    ctx.globalAlpha=p.op;ctx.fillStyle=cond==='storm'?'#b0c4d4':'#ffffff';
    ctx.beginPath();ctx.arc(p.x,p.y,p.sz,0,Math.PI*2);ctx.fill();
  }
  ctx.restore();
}
function drawWind(t){
  ctx.save();
  for(const s of WIND_SEEDS){
    const y=(s.yo+t*s.spd*.2)%H;
    ctx.globalAlpha=s.op;ctx.strokeStyle='#a0b8cc';ctx.lineWidth=1;
    ctx.beginPath();ctx.moveTo(s.xr*W,y);ctx.lineTo(s.xr*W+s.len,y+3);ctx.stroke();
  }
  ctx.restore();
}
// â”€â”€â”€ powder spray (main skier carving) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function emitPowder(x,y,sway){
  for(let i=0;i<5;i++){
    const a=Math.PI+(sway*.8)+(Math.random()-.5)*1.1; // backward fan
    const spd=1.2+Math.random()*2.2;
    const side=i<2?-4.5:4.5; // two ski edges, fifth is center burst
    const life=20+Math.floor(Math.random()*18);
    powderParticles.push({
      x:x-14+(Math.random()-.5)*5, y:y+side+(Math.random()-.5)*3,
      vx:Math.cos(a)*spd, vy:Math.sin(a)*spd+(Math.random()-.5)*.6,
      life, maxLife:life, sz:0.7+Math.random()*1.5,
    });
  }
}
function updatePowder(){
  for(let i=powderParticles.length-1;i>=0;i--){
    const p=powderParticles[i];
    p.x+=p.vx; p.y+=p.vy; p.vx*=.90; p.vy*=.90; p.life--;
    if(p.life<=0) powderParticles.splice(i,1);
  }
}
function drawPowder(){
  if(!powderParticles.length) return;
  ctx.save();
  for(const p of powderParticles){
    ctx.globalAlpha=(p.life/p.maxLife)*.75;
    ctx.fillStyle='rgba(240,248,255,.9)';
    ctx.beginPath();ctx.arc(p.x,p.y,p.sz,0,Math.PI*2);ctx.fill();
  }
  ctx.restore();
}

function drawSkiTracks(tracks){
  if(tracks.length<2) return;
  ctx.save();ctx.strokeStyle='rgba(140,170,210,.52)';ctx.lineWidth=1.5;ctx.lineCap='round';
  for(const off of[-4,4]){
    ctx.beginPath();ctx.moveTo(tracks[0].x,tracks[0].y+off);
    for(let i=1;i<tracks.length;i++) ctx.lineTo(tracks[i].x,tracks[i].y+off);
    ctx.stroke();
  }
  ctx.restore();
}
function drawVignette(){
  const g=ctx.createRadialGradient(W/2,H/2,H*.3,W/2,H/2,H*.82);
  g.addColorStop(0,'rgba(0,0,0,0)');g.addColorStop(1,'rgba(0,0,0,.22)');
  ctx.fillStyle=g;ctx.fillRect(0,0,W,H);
}
function drawLabel(){
  const sel=document.getElementById('resort');
  const name=sel.options[sel.selectedIndex]?.text||'';
  const date=new Date().toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'});
  ctx.save();ctx.font="11px 'Inter',sans-serif";
  ctx.fillStyle='rgba(0,0,0,.35)';ctx.textAlign='right';
  ctx.fillText(`${name}  Â·  ${date}`,W-14,H-12);ctx.restore();
}

// â”€â”€â”€ main skier (isometric 45Â° view, moving leftâ†’right) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function drawSkier(x,y,t){
  ctx.save(); ctx.translate(x,y);
  const sway=Math.sin(t*.008)*.06;
  ctx.rotate(sway);

  // Soft blurred shadow â€” sun from upper-right â†’ shadow lower-left
  const shOp={sunny:.26,overcast:.16,snowing:.12,storm:.08}[condition]||.16;
  ctx.save();
  ctx.filter='blur(6px)';
  ctx.globalAlpha=shOp; ctx.fillStyle='#2c40a0';
  ctx.beginPath();
  ctx.ellipse(SHADOW_DX*20,SHADOW_DY*20,20,10,Math.atan2(SHADOW_DY,SHADOW_DX),0,Math.PI*2);
  ctx.fill();
  ctx.filter='none';
  ctx.restore();

  // Skis (pair extending left-right â€” forward direction is +x)
  ctx.fillStyle='#0e0804';
  ctx.fillRect(-30,-4,60,3);   // upper ski
  ctx.fillRect(-30, 2,60,3);   // lower ski
  // Ski tips (elliptical upturn)
  ctx.fillStyle='#1e1008';
  ctx.beginPath(); ctx.ellipse(30,-2.5,5.5,2,0,0,Math.PI*2); ctx.fill();
  ctx.beginPath(); ctx.ellipse(30, 3.5,5.5,2,0,0,Math.PI*2); ctx.fill();
  // Bindings (centre highlight)
  ctx.fillStyle='#d8d8d8';
  ctx.fillRect(-4,-4,8,3); ctx.fillRect(-4,2,8,3);

  // Pants / lower body
  ctx.fillStyle='#1a2248';
  ctx.beginPath(); ctx.ellipse(0,8,7,9,0,0,Math.PI*2); ctx.fill();

  // Jacket body
  ctx.fillStyle=skierColor;
  ctx.beginPath(); ctx.ellipse(0,-2,9,11,0,0,Math.PI*2); ctx.fill();
  // Jacket racing stripe
  ctx.fillStyle='rgba(255,255,255,.24)'; ctx.fillRect(-9,-3,18,2.5);

  // Arms (angled back, holding poles)
  ctx.fillStyle=skierColor;
  ctx.save(); ctx.rotate(.30); ctx.fillRect(-20,-2.5,13,3.5); ctx.restore();
  ctx.save(); ctx.rotate(-.30); ctx.fillRect(-20,-2.5,13,3.5); ctx.restore();

  // Pole shafts
  ctx.strokeStyle='rgba(55,55,55,.82)'; ctx.lineWidth=1.1; ctx.lineCap='round';
  ctx.beginPath();
  ctx.moveTo(-14,-5); ctx.lineTo(-25, 9);   // upper pole
  ctx.moveTo(-14, 5); ctx.lineTo(-25,18);   // lower pole
  ctx.stroke();
  // Pole baskets
  ctx.fillStyle='rgba(45,45,45,.78)';
  ctx.beginPath(); ctx.arc(-25, 9,2.8,0,Math.PI*2); ctx.fill();
  ctx.beginPath(); ctx.arc(-25,18,2.8,0,Math.PI*2); ctx.fill();

  // Helmet (sits forward of body, toward +x)
  ctx.fillStyle=skierColor;
  ctx.beginPath(); ctx.ellipse(4,-13,7.5,6,0,0,Math.PI*2); ctx.fill();
  // Helmet shell (dark underside)
  ctx.fillStyle='#18181e';
  ctx.beginPath(); ctx.ellipse(4,-11,7,4.5,0,0,Math.PI*2); ctx.fill();
  // Goggles
  ctx.fillStyle='#e8c020';
  ctx.beginPath(); ctx.ellipse(4,-11,5.5,3.5,0,0,Math.PI*2); ctx.fill();
  ctx.fillStyle='#0e2a48';
  ctx.beginPath(); ctx.ellipse(4,-11,4.5,3,0,0,Math.PI*2); ctx.fill();
  // Goggle lens glint
  ctx.fillStyle='rgba(255,255,255,.38)';
  ctx.beginPath(); ctx.ellipse(2,-12,2,1.3,-.3,0,Math.PI*2); ctx.fill();

  ctx.restore();
}

// â”€â”€â”€ skier position â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function skierPos(t){
  const raw=Math.min(t/animDur,1);
  const p=raw<.08?raw/.08*.04:raw>.92?1-((1-raw)/.08*.04):0.04+(raw-.08)*.96/.84;
  // skier travels along SKIER_LANE with gentle carving wobble
  return{x:-90+p*(W+180),y:SKIER_LANE+Math.sin(p*Math.PI*5)*6,raw};
}

// â”€â”€â”€ full scene â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function drawScene(t,cond,sx,sy){
  ctx.drawImage(getBg(cond),0,0);
  drawChairs(t);
  drawLiveBgSkiers(t);
  drawSkiTracks(skiTracks);
  drawCursiveText(sx);
  if(sx<W+100) drawSkier(sx,sy,t);
  drawPowder();
  drawParticles(cond);
  if(cond==='storm') drawWind(t);
  drawVignette();
  drawLabel();
}

// â”€â”€â”€ animation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function animate(ts){
  if(!animStart) animStart=ts;
  const t=ts-animStart;
  if(condition==='snowing'||condition==='storm') updateParticles(condition);
  const pos=skierPos(t);
  skierX=pos.x;skierY=pos.y;
  if(skiTracks.length===0||skiTracks[skiTracks.length-1].x<skierX-6)
    skiTracks.push({x:skierX,y:skierY});
  if(skierX>0&&skierX<W){emitPowder(skierX,skierY,Math.sin(t*.008)*.06);}
  updatePowder();
  drawScene(t,condition,skierX,skierY);
  document.getElementById('progressFill').style.width=(pos.raw*100)+'%';
  if(pos.raw>=1){
    animDone=true;
    document.getElementById('btnExport').disabled=false;
    document.getElementById('btnGo').disabled=false;
    setStatus('Done! Hit Export GIF to download.');
    animFrame=requestAnimationFrame(idleTick);
    return;
  }
  animFrame=requestAnimationFrame(animate);
}
let idleStart=null;
function idleTick(ts){
  if(!idleStart) idleStart=ts;
  const t=ts-idleStart+animDur;
  if(condition==='snowing'||condition==='storm') updateParticles(condition);
  updatePowder();
  drawScene(t,condition,skierX,skierY);
  animFrame=requestAnimationFrame(idleTick);
}

// â”€â”€â”€ start â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function start(){
  const msg=document.getElementById('message').value.trim();
  if(!msg){setStatus('Please enter a message!');return;}
  if(animFrame){cancelAnimationFrame(animFrame);animFrame=null;}
  document.getElementById('btnGo').disabled=true;
  document.getElementById('btnExport').disabled=true;
  document.getElementById('progressFill').style.width='0%';
  animStart=null;animDone=false;skiTracks=[];idleStart=null;powderParticles=[];

  const sel=document.getElementById('resort');
  const [lat,lon]=sel.value.split(',').map(Number);
  const resortName=sel.options[sel.selectedIndex].text;

  const w=await fetchWeather(lat,lon);
  condition=w.condition;weatherInfo=w;
  bgCanvas=null; // rebuild bg for new condition

  // wind: OWM deg is "from" direction â†’ particles drift the opposite way
  const windToRad=((w.windDeg??270)+180)*Math.PI/180;
  windDx=Math.sin(windToRad)*Math.min(w.windSpeed??0,20)*0.28;

  // powder alert: any snow condition + cold enough for dry powder
  isPowder=(w.weatherId>=600&&w.weatherId<=622&&w.temp<=-3);
  document.getElementById('powderAlert').style.display=isPowder?'block':'none';

  const badge=document.getElementById('weatherBadge');
  const emo={sunny:'â˜€ï¸',snowing:'â„ï¸',overcast:'â˜ï¸',storm:'ğŸŒ¨ï¸'};
  badge.textContent=`${emo[w.condition]} ${w.desc} Â· ${w.temp}Â°C`;
  badge.style.display='block';
  setStatus(`${resortName}: ${w.desc}, ${w.temp}Â°C`);

  initParticles(condition);
  layoutCursiveText(msg);
  animDur=2800+msg.length*230;
  animFrame=requestAnimationFrame(animate);
}

// â”€â”€â”€ GIF export â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function exportGif(){
  setStatus('Preparing GIFâ€¦ fetching encoder workerâ€¦');
  document.getElementById('btnExport').disabled=true;
  try{
    const wres=await fetch('https://cdnjs.cloudflare.com/ajax/libs/gif.js/0.2.0/gif.worker.js');
    const wtxt=await wres.text();
    const wurl=URL.createObjectURL(new Blob([wtxt],{type:'application/javascript'}));
    const gif=new GIF({workers:2,quality:8,width:W,height:H,workerScript:wurl});
    const FPS=12,fDelay=Math.round(1000/FPS);
    const steps=Math.ceil(animDur/(1000/FPS));

    const savedTracks=[...skiTracks];
    const savedPowder=[...powderParticles];
    const exportTracks=[];
    powderParticles=[];
    initParticles(condition);
    setStatus('Rendering framesâ€¦');

    for(let i=0;i<=steps;i++){
      const t=(i/steps)*animDur;
      const pos=skierPos(t);
      if(condition==='snowing'||condition==='storm') updateParticles(condition);
      if(pos.x>0&&pos.x<W){emitPowder(pos.x,pos.y,Math.sin(t*.008)*.06);}
      updatePowder();
      if(exportTracks.length===0||exportTracks[exportTracks.length-1].x<pos.x-6)
        exportTracks.push({x:pos.x,y:pos.y});
      const sv=skiTracks;skiTracks=exportTracks;
      drawScene(t,condition,pos.x,pos.y);
      skiTracks=sv;
      gif.addFrame(canvas,{copy:true,delay:fDelay});
      if(i%10===0) setStatus(`Rendering frame ${i}/${steps}â€¦`);
    }
    skiTracks=savedTracks;
    powderParticles=savedPowder;

    gif.on('progress',p=>setStatus(`Encoding GIF: ${Math.round(p*100)}%`));
    gif.on('finished',blob=>{
      URL.revokeObjectURL(wurl);
      const url=URL.createObjectURL(blob);
      const a=document.createElement('a');a.href=url;a.download='powder-post.gif';
      document.body.appendChild(a);a.click();document.body.removeChild(a);
      setTimeout(()=>URL.revokeObjectURL(url),60000);
      setStatus('GIF downloaded!');
      document.getElementById('btnExport').disabled=false;
    });
    gif.render();
  }catch(e){
    console.error(e);setStatus('Export failed: '+e.message);
    document.getElementById('btnExport').disabled=false;
  }
}

// â”€â”€â”€ helpers / events â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setStatus(msg){document.getElementById('status').textContent=msg;}
document.getElementById('btnGo').addEventListener('click',start);
document.getElementById('btnExport').addEventListener('click',exportGif);
document.getElementById('message').addEventListener('keydown',e=>{if(e.key==='Enter')start();});
document.getElementById('swatches').addEventListener('click',e=>{
  const sw=e.target.closest('.swatch');
  if(!sw) return;
  skierColor=sw.dataset.color;
  document.querySelectorAll('.swatch').forEach(s=>s.classList.toggle('active',s===sw));
});

// â”€â”€â”€ init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
(function init(){
  layoutCursiveText('send powder!');
  drawScene(0,'sunny',-200,SKIER_LANE);
})();
</script>
</body>
</html>
