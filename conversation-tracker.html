<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>People I Talk To</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #EDD9C0;
      min-height: 100vh;
      padding: 24px 16px 48px;
    }

    .container { max-width: 900px; margin: 0 auto; }

    /* â”€â”€ Two-column main grid â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .main-grid {
      display: grid;
      grid-template-columns: minmax(200px, 1fr) 1.5fr;
      gap: 20px;
      align-items: start;
    }

    .left-col  { display: flex; flex-direction: column; }
    .right-col { display: flex; flex-direction: column; }

    @media (max-width: 660px) {
      .main-grid { grid-template-columns: 1fr; }
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: flex-end;
      margin-bottom: 20px;
    }

    header h1 { font-size: 22px; font-weight: 700; color: #4A5228; }
    header .date { font-size: 13px; color: #7A8C3C; }

    /* â”€â”€ Crowd â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #crowd-section {
      background: linear-gradient(160deg, #f5ede0 0%, #e0ceaf 100%);
      border-radius: 20px;
      margin-bottom: 20px;
      box-shadow: 0 2px 10px rgba(74,82,40,0.10);
      overflow: hidden;
    }

    #crowd-canvas {
      position: relative;
      height: 260px;
      overflow: hidden;
    }

    .central-figure {
      position: absolute;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
      z-index: 2;
      pointer-events: none;
    }

    .central-label {
      position: absolute;
      left: 50%;
      bottom: 36px;
      transform: translateX(-50%);
      font-size: 9px;
      font-weight: 700;
      color: #a89880;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      pointer-events: none;
      user-select: none;
    }

    .crowd-avatar {
      position: absolute;
      transform: translate(-50%, -50%);
      z-index: 1;
      cursor: default;
    }

    .crowd-avatar:hover { z-index: 10; }

    .avatar-tip {
      position: absolute;
      bottom: calc(100% + 4px);
      left: 50%;
      transform: translateX(-50%);
      background: rgba(74,82,40,0.85);
      color: #EDD9C0;
      padding: 3px 9px;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 500;
      white-space: nowrap;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.15s;
    }

    .crowd-avatar:hover .avatar-tip { opacity: 1; }

    #crowd-stats {
      text-align: center;
      padding: 5px 16px 11px;
      font-size: 11px;
      font-weight: 600;
      color: #7A8C3C;
      text-transform: uppercase;
      letter-spacing: 0.07em;
    }

    /* â”€â”€ Color swatch â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .color-swatch {
      width: 14px;
      height: 14px;
      border-radius: 50%;
      display: inline-block;
      cursor: pointer;
      border: 2px solid rgba(255,255,255,0.7);
      box-shadow: 0 0 0 1px rgba(0,0,0,0.12);
      flex-shrink: 0;
      position: relative;
      transition: transform 0.12s;
    }

    .color-swatch:hover { transform: scale(1.15); }

    .color-input {
      position: absolute;
      inset: 0;
      opacity: 0;
      cursor: pointer;
      width: 100%;
      height: 100%;
      padding: 0;
      border: none;
    }

    /* â”€â”€ Crowd animation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    @keyframes crowdPulse {
      0%   { transform: translate(-50%, -50%) scale(1); }
      45%  { transform: translate(-50%, -50%) scale(1.38); }
      100% { transform: translate(-50%, -50%) scale(1); }
    }

    .crowd-avatar.pulse {
      animation: crowdPulse 0.35s cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    /* â”€â”€ Groups â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .groups-container { display: flex; flex-direction: column; gap: 14px; }

    .group-section {
      background: #FAF5EE;
      border-radius: 16px;
      box-shadow: 0 1px 4px rgba(74,82,40,0.08);
      overflow: hidden;
    }

    .group-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 13px 16px 11px;
      border-bottom: 1px solid #e5d8c4;
      gap: 8px;
    }

    .group-header-left {
      display: flex;
      align-items: center;
      gap: 8px;
      flex: 1;
      min-width: 0;
    }

    .group-name {
      font-size: 12px;
      font-weight: 700;
      color: #7A8C3C;
      text-transform: uppercase;
      letter-spacing: 0.07em;
      outline: none;
      border-radius: 4px;
      padding: 2px 5px;
      cursor: text;
      min-width: 40px;
      max-width: 220px;
    }

    .group-name:focus {
      background: #f0e8d8;
      color: #4A5228;
      text-transform: none;
      letter-spacing: normal;
      font-size: 14px;
    }

    .group-name:empty::before { content: 'Group nameâ€¦'; color: #c5b49a; }

    .group-header-right {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .group-total { font-size: 12px; color: #b0a090; }
    .group-total b { color: #D4882A; font-weight: 700; }

    .group-delete-btn {
      background: none;
      border: none;
      color: #c5b49a;
      font-size: 17px;
      cursor: pointer;
      padding: 2px 5px;
      border-radius: 4px;
      transition: color 0.12s;
      line-height: 1;
    }

    .group-delete-btn:hover { color: #A85C7A; }

    .group-body {
      padding: 6px 12px 2px;
      min-height: 54px;
      transition: background 0.12s;
      border-radius: 0 0 16px 16px;
    }

    .group-body.drag-over {
      background: #f5e8d0;
      outline: 2px dashed #D4882A;
      outline-offset: -4px;
      border-radius: 0 0 16px 16px;
    }

    /* â”€â”€ Person cards â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .person-card {
      display: flex;
      align-items: center;
      gap: 9px;
      padding: 9px 4px;
      border-bottom: 1px solid #ede0d0;
      border-radius: 8px;
      transition: background 0.1s;
    }

    .person-card:last-of-type { border-bottom: none; }
    .person-card:hover { background: #f5ede0; }
    .person-card.dragging { opacity: 0.3; }

    .drag-handle {
      color: #c5b49a;
      font-size: 15px;
      cursor: grab;
      padding: 0 2px;
      user-select: none;
      flex-shrink: 0;
      line-height: 1;
    }

    .drag-handle:hover { color: #7A8C3C; }
    .drag-handle:active { cursor: grabbing; }

    .person-name {
      flex: 1;
      font-size: 15px;
      font-weight: 500;
      color: #4A5228;
      display: flex;
      align-items: center;
      gap: 6px;
      flex-wrap: wrap;
      word-break: break-word;
    }

    .person-count {
      font-size: 20px;
      font-weight: 700;
      color: #D4882A;
      min-width: 28px;
      text-align: center;
    }

    .tap-btn {
      padding: 8px 13px;
      background: #f5e8d0;
      color: #D4882A;
      border: none;
      border-radius: 8px;
      font-size: 17px;
      cursor: pointer;
      transition: background 0.12s, transform 0.1s;
      line-height: 1;
      flex-shrink: 0;
    }

    .tap-btn:hover { background: #edd8b0; }
    .tap-btn:active { transform: scale(0.92); }

    .delete-btn {
      background: none;
      border: none;
      color: #c5b49a;
      font-size: 15px;
      cursor: pointer;
      padding: 4px 5px;
      border-radius: 6px;
      transition: color 0.12s;
      line-height: 1;
      flex-shrink: 0;
    }

    .delete-btn:hover { color: #A85C7A; }

    .streak-badge {
      font-size: 11px;
      background: #f0e0eb;
      color: #A85C7A;
      padding: 2px 6px;
      border-radius: 20px;
      font-weight: 600;
      white-space: nowrap;
    }

    /* â”€â”€ Add person row â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .add-person-row { padding: 6px 4px 10px; }

    .add-person-input {
      width: 100%;
      border: none;
      outline: none;
      font-size: 13px;
      color: #a89880;
      background: transparent;
      padding: 4px 0;
    }

    .add-person-input::placeholder { color: #c5b49a; }
    .add-person-input:focus { color: #4A5228; }

    /* â”€â”€ Add Group button â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .add-group-btn {
      display: block;
      width: 100%;
      margin-top: 12px;
      padding: 12px;
      background: transparent;
      border: 2px dashed #c5b49a;
      border-radius: 12px;
      font-size: 14px;
      font-weight: 600;
      color: #a89880;
      cursor: pointer;
      transition: border-color 0.15s, color 0.15s;
    }

    .add-group-btn:hover { border-color: #7A8C3C; color: #7A8C3C; }

    /* â”€â”€ Footer â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .footer {
      margin-top: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .total { font-size: 14px; color: #7A8C3C; }
    .total span { font-weight: 700; color: #4A5228; }

    .reset-btn {
      padding: 9px 16px;
      background: #FAF5EE;
      color: #A85C7A;
      border: 1.5px solid #A85C7A;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.15s, color 0.15s;
    }

    .reset-btn:hover { background: #A85C7A; color: #fff; }

    /* â”€â”€ History â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .history-section { margin-top: 36px; }

    .history-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
      cursor: pointer;
      user-select: none;
    }

    .history-header h2 {
      font-size: 12px;
      font-weight: 700;
      color: #7A8C3C;
      text-transform: uppercase;
      letter-spacing: 0.07em;
    }

    .history-toggle { font-size: 12px; color: #7A8C3C; transition: transform 0.2s; }
    .history-toggle.open { transform: rotate(180deg); }

    .history-list { display: flex; flex-direction: column; gap: 8px; }

    .history-day {
      background: #FAF5EE;
      border-radius: 12px;
      box-shadow: 0 1px 4px rgba(74,82,40,0.06);
      overflow: hidden;
    }

    .history-day-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 13px 16px;
      cursor: pointer;
      user-select: none;
    }

    .history-day-header:hover { background: #f5ede0; }
    .history-day-date { font-size: 14px; font-weight: 600; color: #4A5228; }
    .history-day-right { display: flex; align-items: center; gap: 12px; }
    .history-day-total { font-size: 13px; color: #a89880; }
    .history-day-total span { font-weight: 700; color: #D4882A; }
    .history-chevron { font-size: 11px; color: #a89880; transition: transform 0.2s; }
    .history-chevron.open { transform: rotate(180deg); }

    .history-day-detail {
      display: none;
      padding: 0 16px 12px;
      border-top: 1px solid #e5d8c4;
    }

    .history-day-detail.open { display: block; }

    .history-row {
      display: flex;
      justify-content: space-between;
      padding: 6px 0;
      font-size: 14px;
      border-bottom: 1px solid #ede0d0;
    }

    .history-row:last-child { border-bottom: none; }
    .history-row .h-name { color: #4A5228; }
    .history-row .h-count { font-weight: 600; color: #D4882A; }

    .history-empty { text-align: center; color: #c5b49a; font-size: 13px; padding: 16px 0; }

    .bump { animation: bump 0.2s ease; }

    @keyframes bump {
      0%   { transform: scale(1); }
      50%  { transform: scale(1.3); }
      100% { transform: scale(1); }
    }

    /* â”€â”€ Token / Candle â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .candle-widget {
      background: linear-gradient(160deg, #f5ede0 0%, #ead0a8 100%);
      border-radius: 20px;
      margin-bottom: 20px;
      box-shadow: 0 2px 10px rgba(74,82,40,0.10);
      padding: 14px 18px;
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .candle-svg-wrap {
      flex-shrink: 0;
      width: 48px;
      display: flex;
      align-items: flex-end;
      justify-content: center;
    }

    .candle-info { flex: 1; min-width: 0; }

    .candle-tokens {
      font-size: 26px;
      font-weight: 800;
      color: #4A5228;
      line-height: 1;
      margin-bottom: 3px;
    }

    .candle-tokens span { font-size: 13px; font-weight: 500; color: #a89880; }

    .candle-phase {
      font-size: 11px;
      color: #7A8C3C;
      font-weight: 600;
      margin-bottom: 8px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .token-bar-wrap {
      background: rgba(74,82,40,0.10);
      border-radius: 20px;
      height: 7px;
      overflow: hidden;
    }

    .token-bar-fill {
      height: 100%;
      border-radius: 20px;
      background: linear-gradient(90deg, #D4882A, #f7c14f);
      transition: width 0.5s cubic-bezier(0.34,1.56,0.64,1);
    }

    .candle-burnout {
      font-size: 12px;
      color: #A85C7A;
      font-weight: 600;
      margin-top: 6px;
      display: none;
    }

    @keyframes flicker {
      0%   { transform: scaleX(1)    scaleY(1)    rotate(-1deg);  }
      20%  { transform: scaleX(0.88) scaleY(1.06) rotate(1.5deg); }
      40%  { transform: scaleX(1.1)  scaleY(0.93) rotate(-2deg);  }
      60%  { transform: scaleX(0.94) scaleY(1.1)  rotate(1deg);   }
      80%  { transform: scaleX(1.06) scaleY(0.96) rotate(-1.5deg);}
      100% { transform: scaleX(1)    scaleY(1)    rotate(-1deg);  }
    }

    @keyframes flamePulseBurn {
      0%   { transform: scale(1); opacity: 1; }
      30%  { transform: scale(1.9) rotate(6deg); opacity: 0.65; }
      100% { transform: scale(1); opacity: 1; }
    }

    @keyframes flamePulseGrow {
      0%   { transform: scale(1); }
      50%  { transform: scale(1.6); }
      100% { transform: scale(1); }
    }

    @keyframes candleGlow {
      0%   { filter: drop-shadow(0 0 0px #D4882A); }
      40%  { filter: drop-shadow(0 0 10px #f7c14f); }
      100% { filter: drop-shadow(0 0 0px #D4882A); }
    }

    .flame-group {
      transform-origin: 24px 28px;
      animation: flicker 2.4s ease-in-out infinite;
    }

    .flame-group.pulse-burn { animation: flamePulseBurn 0.45s ease-out; }
    .flame-group.pulse-grow { animation: flamePulseGrow 0.45s cubic-bezier(0.34,1.56,0.64,1); }
    .candle-svg-wrap.glow    { animation: candleGlow 0.9s ease-out; }

    /* â”€â”€ Modals â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(74,82,40,0.35);
      backdrop-filter: blur(2px);
      z-index: 100;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .modal-overlay.hidden { display: none; }

    .modal-box {
      background: #FAF5EE;
      border-radius: 20px;
      padding: 28px 24px 22px;
      max-width: 360px;
      width: 100%;
      box-shadow: 0 8px 40px rgba(74,82,40,0.20);
    }

    .modal-box h2 { font-size: 18px; font-weight: 800; color: #4A5228; margin-bottom: 6px; }

    .modal-box p { font-size: 13px; color: #7A8C3C; margin-bottom: 18px; line-height: 1.55; }

    .modal-field { margin-bottom: 14px; }

    .modal-field label {
      display: block;
      font-size: 11px;
      font-weight: 700;
      color: #7A8C3C;
      text-transform: uppercase;
      letter-spacing: 0.07em;
      margin-bottom: 5px;
    }

    .modal-field input {
      width: 100%;
      padding: 9px 12px;
      border: 1.5px solid #e5d8c4;
      border-radius: 8px;
      font-size: 14px;
      color: #4A5228;
      background: #fff;
      outline: none;
      font-family: inherit;
    }

    .modal-field input:focus { border-color: #D4882A; }

    .modal-btn {
      display: block;
      width: 100%;
      padding: 12px;
      background: #D4882A;
      color: #fff;
      border: none;
      border-radius: 10px;
      font-size: 15px;
      font-weight: 700;
      cursor: pointer;
      margin-top: 10px;
      font-family: inherit;
      transition: background 0.15s;
      text-align: center;
    }

    .modal-btn:hover { background: #b87320; }

    .modal-btn.secondary {
      background: transparent;
      color: #a89880;
      font-size: 13px;
      font-weight: 500;
      margin-top: 4px;
      padding: 8px;
    }

    .modal-btn.secondary:hover { color: #7A8C3C; background: transparent; }

    .suggestion-moon { font-size: 36px; text-align: center; margin-bottom: 4px; }

    .suggestion-label {
      text-align: center;
      font-size: 13px;
      color: #7A8C3C;
      font-weight: 600;
      margin-bottom: 18px;
      line-height: 1.45;
    }

    .token-nudge {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 16px;
      margin-bottom: 18px;
    }

    .nudge-btn {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      border: 2px solid #e5d8c4;
      background: #FAF5EE;
      color: #4A5228;
      font-size: 22px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: border-color 0.12s, color 0.12s;
      font-family: inherit;
      line-height: 1;
    }

    .nudge-btn:hover { border-color: #D4882A; color: #D4882A; }

    .nudge-value { font-size: 38px; font-weight: 800; color: #4A5228; min-width: 64px; text-align: center; }

    /* â”€â”€ Group type badge â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .group-type-btn {
      background: none;
      border: none;
      font-size: 13px;
      cursor: pointer;
      padding: 2px 5px;
      border-radius: 4px;
      line-height: 1;
      transition: background 0.12s;
      flex-shrink: 0;
    }

    .group-type-btn:hover { background: #f0e8d8; }

    /* â”€â”€ Settings button â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .settings-btn {
      background: none;
      border: none;
      font-size: 15px;
      color: #7A8C3C;
      cursor: pointer;
      padding: 3px 5px;
      border-radius: 6px;
      line-height: 1;
      transition: color 0.12s, background 0.12s;
      flex-shrink: 0;
    }

    .settings-btn:hover { color: #4A5228; background: #f0e8d8; }

    /* â”€â”€ Token adjust â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .candle-tokens-row {
      display: flex;
      align-items: center;
      gap: 7px;
      margin-bottom: 3px;
    }

    .token-adj-btn {
      width: 22px;
      height: 22px;
      border-radius: 50%;
      border: 1.5px solid #c5b49a;
      background: rgba(255,255,255,0.5);
      color: #7A8C3C;
      font-size: 16px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      line-height: 1;
      transition: border-color 0.12s, color 0.12s;
      font-family: inherit;
      flex-shrink: 0;
      padding: 0;
    }

    .token-adj-btn:hover { border-color: #D4882A; color: #D4882A; }
    .token-adj-btn:active { transform: scale(0.9); }

    /* â”€â”€ Settings modal specifics â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .settings-forecast {
      background: #f0e8d8;
      border-radius: 10px;
      padding: 12px 14px;
      margin-bottom: 18px;
    }

    .forecast-row {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
      padding: 3px 0;
    }

    .forecast-row-label { flex: 1; color: #4A5228; font-weight: 500; }

    .forecast-mod {
      font-size: 12px;
      font-weight: 700;
      color: #D4882A;
      min-width: 32px;
      text-align: right;
    }

    .forecast-mod.negative { color: #A85C7A; }

    .forecast-divider {
      border-top: 1px solid #e0ceaf;
      margin: 8px 0;
    }

    .forecast-suggested {
      font-size: 13px;
      color: #7A8C3C;
      font-weight: 600;
      text-align: center;
    }

    .forecast-suggested strong { color: #4A5228; font-size: 16px; }

    /* â”€â”€ Horoscope card â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .horoscope-card {
      background: linear-gradient(135deg, #f5ede0 0%, #e8d4b8 100%);
      border-radius: 16px;
      padding: 12px 16px;
      margin-bottom: 14px;
      box-shadow: 0 1px 6px rgba(74,82,40,0.08);
    }

    .horoscope-sign {
      font-size: 11px;
      font-weight: 700;
      color: #A85C7A;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      margin-bottom: 5px;
    }

    .horoscope-text {
      font-size: 13px;
      color: #4A5228;
      line-height: 1.58;
      font-style: italic;
    }

    /* â”€â”€ Horoscope actions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .horoscope-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 6px;
    }

    .horoscope-refresh-btn {
      background: none;
      border: 1.5px solid #c5b49a;
      border-radius: 50%;
      width: 22px;
      height: 22px;
      font-size: 13px;
      color: #a89880;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      line-height: 1;
      transition: border-color 0.12s, color 0.12s, transform 0.3s;
      flex-shrink: 0;
      padding: 0;
    }

    .horoscope-refresh-btn:hover { border-color: #A85C7A; color: #A85C7A; }
    .horoscope-refresh-btn.spinning { transform: rotate(360deg); }

    .horoscope-ask-row {
      display: flex;
      gap: 6px;
      margin-top: 10px;
    }

    .horoscope-ask-input {
      flex: 1;
      border: 1.5px solid #ddd0be;
      border-radius: 8px;
      padding: 6px 10px;
      font-size: 12px;
      color: #4A5228;
      background: rgba(255,255,255,0.55);
      outline: none;
      font-family: inherit;
      min-width: 0;
    }

    .horoscope-ask-input::placeholder { color: #c5b49a; }
    .horoscope-ask-input:focus { border-color: #A85C7A; background: #fff; }

    .horoscope-ask-btn {
      padding: 6px 12px;
      background: #A85C7A;
      color: #fff;
      border: none;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.12s;
      flex-shrink: 0;
      font-family: inherit;
    }

    .horoscope-ask-btn:hover { background: #8a4860; }
    .horoscope-ask-btn:disabled { background: #c5b49a; cursor: default; }

    .horoscope-text.loading {
      color: #a89880;
      font-style: normal;
    }

    /* â”€â”€ Per-person cost input â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .cost-input {
      width: 36px;
      padding: 3px 4px;
      border: 1.5px solid #e5d8c4;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 700;
      text-align: center;
      background: rgba(255,255,255,0.5);
      outline: none;
      -moz-appearance: textfield;
      flex-shrink: 0;
      font-family: inherit;
      cursor: text;
    }
    .cost-input::-webkit-inner-spin-button,
    .cost-input::-webkit-outer-spin-button { -webkit-appearance: none; }
    .cost-input:focus { border-color: #D4882A; background: #fff; }
  </style>
</head>
<body>
<div class="container">

  <header>
    <h1>People I Talk To</h1>
    <div style="display:flex;align-items:center;gap:6px;">
      <div class="date" id="today-date"></div>
      <a href="/" class="settings-btn" title="Home" style="text-decoration:none;">âŒ‚</a>
      <button class="settings-btn" onclick="openSettings()" title="Energy settings">âš™</button>
    </div>
  </header>

  <div class="main-grid">
    <div class="left-col">

  <div class="candle-widget" id="candle-widget">
    <div class="candle-svg-wrap" id="candle-svg-wrap">
      <svg id="candle-svg" viewBox="0 0 48 150" xmlns="http://www.w3.org/2000/svg" width="48" height="150">
        <defs>
          <clipPath id="candle-clip">
            <rect x="10" y="40" width="28" height="106" rx="6"/>
          </clipPath>
          <!-- Burned/consumed wax (dark) â€” shown where tokens have been spent -->
          <linearGradient id="wax-grad" x1="10" y1="0" x2="38" y2="0" gradientUnits="userSpaceOnUse">
            <stop offset="0%"   stop-color="#2e1a06"/>
            <stop offset="22%"  stop-color="#5a3410"/>
            <stop offset="50%"  stop-color="#7a4e22"/>
            <stop offset="78%"  stop-color="#5a3410"/>
            <stop offset="100%" stop-color="#2e1a06"/>
          </linearGradient>
          <!-- Remaining wax (bright cream) â€” shown for current tokens left -->
          <linearGradient id="wax-fill-grad" x1="10" y1="0" x2="38" y2="0" gradientUnits="userSpaceOnUse">
            <stop offset="0%"   stop-color="#c09840"/>
            <stop offset="22%"  stop-color="#f0d898"/>
            <stop offset="50%"  stop-color="#faecc8"/>
            <stop offset="78%"  stop-color="#f0d898"/>
            <stop offset="100%" stop-color="#c09840"/>
          </linearGradient>
          <!-- Warm glow behind flame -->
          <radialGradient id="flame-glow-grad" cx="50%" cy="80%" r="60%">
            <stop offset="0%"   stop-color="#f7c14f" stop-opacity="0.50"/>
            <stop offset="100%" stop-color="#D4882A" stop-opacity="0"/>
          </radialGradient>
        </defs>

        <!-- Warm ambient glow around flame area -->
        <ellipse cx="24" cy="27" rx="16" ry="22" fill="url(#flame-glow-grad)"/>

        <!-- Candle body with cylindrical shading -->
        <rect x="10" y="40" width="28" height="106" rx="6" fill="url(#wax-grad)" stroke="#3a2008" stroke-width="0.8"/>

        <!-- Wax level fill (remaining wax) -->
        <rect id="candle-fill" x="10" y="40" width="28" height="106" fill="url(#wax-fill-grad)" clip-path="url(#candle-clip)"/>

        <!-- Wax drips -->
        <path d="M13 46 Q11 62 12 82" stroke="#c8a060" stroke-width="3.5" fill="none" stroke-linecap="round" opacity="0.38" clip-path="url(#candle-clip)"/>
        <path d="M36 48 Q38 61 37 72" stroke="#c8a060" stroke-width="2.5" fill="none" stroke-linecap="round" opacity="0.30" clip-path="url(#candle-clip)"/>

        <!-- Shine highlight (left side of cylinder) -->
        <rect id="candle-shine" x="14" y="43" width="5" height="36" rx="2.5" fill="rgba(255,255,255,0.22)" clip-path="url(#candle-clip)"/>

        <!-- Curved wick -->
        <path id="candle-wick" d="M24 29 Q23.2 34 24 40" stroke="#3d4018" stroke-width="1.8" fill="none" stroke-linecap="round"/>

        <!-- Organic flame -->
        <g id="candle-flame" class="flame-group">
          <!-- Outer glow layer -->
          <path d="M24 30 C15 25 13 17 15 10 C16 4 20 1 24 2 C28 1 32 4 33 10 C35 17 33 25 24 30Z" fill="#D4882A" opacity="0.78"/>
          <!-- Main flame body -->
          <path d="M24 29 C17 23 16 16 17 11 C18.5 5 21 3 24 4 C27 3 29.5 5 31 11 C32 16 31 23 24 29Z" fill="#e07818"/>
          <!-- Golden inner flame -->
          <path d="M24 27 C19 21 18.5 15 20 11 C21 7 22.5 5 24 6 C25.5 5 27 7 28 11 C29.5 15 29 21 24 27Z" fill="#f7c14f"/>
          <!-- Bright core -->
          <path d="M24 24 C21 18 21 13 22.5 9.5 C23 8 23.5 7 24 7 C24.5 7 25 8 25.5 9.5 C27 13 27 18 24 24Z" fill="#fffaee" opacity="0.90"/>
          <!-- Tip -->
          <ellipse cx="24" cy="9" rx="2" ry="3" fill="white" opacity="0.40"/>
        </g>

        <!-- Burned-out wax puddle -->
        <g id="candle-puddle" style="display:none">
          <ellipse cx="24" cy="146" rx="18" ry="4" fill="#c5a878" opacity="0.35"/>
        </g>
      </svg>
    </div>
    <div class="candle-info">
      <div class="candle-tokens-row">
        <button class="token-adj-btn" onclick="adjustTokens(-5)" title="âˆ’5 tokens">âˆ’</button>
        <div class="candle-tokens" id="candle-tokens">â€” <span>tokens</span></div>
        <button class="token-adj-btn" onclick="adjustTokens(+5)" title="+5 tokens">+</button>
      </div>
      <div class="candle-phase" id="candle-phase"></div>
      <div class="token-bar-wrap">
        <div class="token-bar-fill" id="token-bar-fill" style="width:0%"></div>
      </div>
      <div class="candle-burnout" id="candle-burnout">recharge tomorrow ğŸŒ™</div>
    </div>
  </div>

  <div class="horoscope-card" id="horoscope-card" style="display:none">
    <div class="horoscope-header">
      <div class="horoscope-sign" id="horoscope-sign"></div>
      <button class="horoscope-refresh-btn" id="horoscope-refresh-btn" onclick="refreshHoroscope()" title="Different reading">â†º</button>
    </div>
    <div class="horoscope-text" id="horoscope-text"></div>
    <div class="horoscope-ask-row">
      <input type="text" class="horoscope-ask-input" id="horoscope-ask-input"
        placeholder="Ask the stars about something specific..."
        maxlength="120"
        onkeydown="if(event.key==='Enter') askHoroscope()"/>
      <button class="horoscope-ask-btn" id="horoscope-ask-btn" onclick="askHoroscope()">Ask</button>
    </div>
  </div>

  <div id="crowd-section">
    <div id="crowd-canvas">
      <!-- Central figure + avatars injected by JS -->
    </div>
    <div id="crowd-stats">No conversations yet today</div>
  </div>

    </div><!-- /.left-col -->
    <div class="right-col">

  <div id="groups-container" class="groups-container"></div>

  <button class="add-group-btn" onclick="addGroup()">+ Add Group</button>

  <div class="footer">
    <div class="total">Total today: <span id="total-count">0</span></div>
    <button class="reset-btn" onclick="resetCounts()">Reset Today</button>
  </div>

    </div><!-- /.right-col -->
  </div><!-- /.main-grid -->

  <div class="history-section">
    <div class="history-header" onclick="toggleHistory()">
      <h2>Past Days</h2>
      <span class="history-toggle" id="history-toggle">â–¼</span>
    </div>
    <div class="history-list" id="history-list" style="display:none"></div>
  </div>

</div>

<!-- Settings modal -->
<div class="modal-overlay hidden" id="settings-modal">
  <div class="modal-box">
    <h2>Energy Settings âš™ï¸</h2>
    <div class="settings-forecast">
      <div class="forecast-row">
        <span id="settings-moon-emoji">ğŸŒ•</span>
        <span class="forecast-row-label" id="settings-moon-name">Moon phase</span>
        <span class="forecast-mod" id="settings-moon-mod">â€”</span>
      </div>
      <div class="forecast-row">
        <span>ğŸŒ¸</span>
        <span class="forecast-row-label" id="settings-cycle-name">Cycle phase</span>
        <span class="forecast-mod" id="settings-cycle-mod">â€”</span>
      </div>
      <div class="forecast-divider"></div>
      <div class="forecast-suggested">Suggested today: <strong id="settings-suggested">â€”</strong> tokens</div>
      <div class="forecast-divider" id="settings-horoscope-divider" style="display:none"></div>
      <div id="settings-zodiac-row" class="forecast-row" style="display:none">
        <span id="settings-zodiac-emoji"></span>
        <span class="forecast-row-label" id="settings-zodiac-name" style="font-style:italic;color:#A85C7A"></span>
      </div>
      <div id="settings-horoscope-text" style="font-size:12px;color:#5a3a18;font-style:italic;line-height:1.55;margin-top:4px;display:none"></div>
    </div>
    <div class="modal-field">
      <label>Birthday (for horoscope)</label>
      <input type="date" id="settings-birthday"/>
    </div>
    <div class="modal-field">
      <label>Last period start date</label>
      <input type="date" id="settings-period-date"/>
    </div>
    <div class="modal-field">
      <label>Average cycle length (days)</label>
      <input type="number" id="settings-cycle-length" min="21" max="45" value="28"/>
    </div>
    <div class="modal-field">
      <label>Claude API key <span style="color:#b0a090;font-weight:400;text-transform:none;letter-spacing:0;font-size:10px">(optional â€” powers "Ask the stars")</span></label>
      <input type="password" id="settings-api-key" placeholder="sk-ant-..."/>
    </div>
    <button class="modal-btn" onclick="saveSettings()">Save changes</button>
    <button class="modal-btn secondary" onclick="closeSettings()">Close</button>
  </div>
</div>

<!-- Setup modal -->
<div class="modal-overlay hidden" id="setup-modal">
  <div class="modal-box">
    <h2>Track your energy ğŸ•¯ï¸</h2>
    <p>The candle syncs with your cycle and the moon to suggest your starting energy each morning. Your data stays on this device.</p>
    <div class="modal-field">
      <label>Last period start date</label>
      <input type="date" id="setup-period-date"/>
    </div>
    <div class="modal-field">
      <label>Average cycle length (days)</label>
      <input type="number" id="setup-cycle-length" value="28" min="21" max="45"/>
    </div>
    <button class="modal-btn" onclick="saveSetupAndSuggest()">Continue â†’</button>
    <button class="modal-btn secondary" onclick="skipSetup()">Skip for now</button>
  </div>
</div>

<!-- Daily suggestion modal -->
<div class="modal-overlay hidden" id="suggest-modal">
  <div class="modal-box">
    <div class="suggestion-moon" id="suggest-moon">ğŸ•¯ï¸</div>
    <div class="suggestion-label" id="suggest-label">Calculating your energyâ€¦</div>
    <div class="token-nudge">
      <button class="nudge-btn" onclick="nudgeTokens(-5)">âˆ’</button>
      <div class="nudge-value" id="nudge-value">80</div>
      <button class="nudge-btn" onclick="nudgeTokens(+5)">+</button>
    </div>
    <button class="modal-btn" onclick="confirmTokens()">Start with these tokens</button>
    <button class="modal-btn secondary" onclick="dismissSuggest()">Not today</button>
  </div>
</div>

<script>
  const STORAGE_KEY = 'conv_tracker_v2';
  const GROUP_COLORS = ['#D4882A','#7A8C3C','#A85C7A','#4A5228','#8B5E3C','#B87333','#5A7A4A','#C4734A'];

  let dragState = null;
  let _pendingSuggestedTokens = 80;
  let _horoscopeOffset = 0;

  const GROUP_TYPES      = { work: 'ğŸ’¼', friend: 'ğŸŒ¸', family: 'ğŸ¡', neutral: 'â—' };
  const GROUP_TYPE_ORDER = ['work', 'friend', 'family', 'neutral'];

  // â”€â”€ Zodiac â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const ZODIAC = [
    { key:'capricorn',   emoji:'â™‘', name:'Capricorn',   ranges:[[12,22],[1,19]]  },
    { key:'aquarius',    emoji:'â™’', name:'Aquarius',    ranges:[[1,20],[2,18]]   },
    { key:'pisces',      emoji:'â™“', name:'Pisces',      ranges:[[2,19],[3,20]]   },
    { key:'aries',       emoji:'â™ˆ', name:'Aries',       ranges:[[3,21],[4,19]]   },
    { key:'taurus',      emoji:'â™‰', name:'Taurus',      ranges:[[4,20],[5,20]]   },
    { key:'gemini',      emoji:'â™Š', name:'Gemini',      ranges:[[5,21],[6,20]]   },
    { key:'cancer',      emoji:'â™‹', name:'Cancer',      ranges:[[6,21],[7,22]]   },
    { key:'leo',         emoji:'â™Œ', name:'Leo',         ranges:[[7,23],[8,22]]   },
    { key:'virgo',       emoji:'â™', name:'Virgo',       ranges:[[8,23],[9,22]]   },
    { key:'libra',       emoji:'â™', name:'Libra',       ranges:[[9,23],[10,22]]  },
    { key:'scorpio',     emoji:'â™', name:'Scorpio',     ranges:[[10,23],[11,21]] },
    { key:'sagittarius', emoji:'â™', name:'Sagittarius', ranges:[[11,22],[12,21]] },
  ];

  const HOROSCOPES = {
    aries: [
      "Bold energy surrounds you â€” your directness opens doors today. Trust your instincts when connecting with others.",
      "A restless spark pushes you toward new conversations. Channel that fire into meaningful exchanges.",
      "Your leadership energy is strong; someone needs your honest perspective â€” offer it with warmth.",
      "The stars favor initiative. Reach out first; the connection you've been waiting on won't arrive on its own.",
      "Your natural charisma is amplified. Social situations that once felt draining may surprise you with ease.",
      "Mars lends extra stamina for emotional labor today. You can hold space for others without depleting yourself.",
      "A blunt truth lands softer than you'd expect â€” speak your mind with care and you'll be heard.",
      "Someone you reconnect with today carries more significance than it first appears.",
    ],
    taurus: [
      "Slow, steady connection is your gift today. Deep conversations nourish you more than surface-level chatter.",
      "Venus asks you to invest in relationships that have stood the test of time. Quality over quantity.",
      "Your presence is grounding for others â€” lean into that, but guard your own stillness.",
      "Comfort and routine bring unexpected joy. A familiar face brings news worth hearing.",
      "Patience is your superpower right now. Don't rush someone who needs time to open up.",
      "Your loyalty is being noticed. The energy you've put into relationships begins to return.",
      "A shared meal or walk transforms small talk into real connection. Lean into sensory richness.",
      "Someone is asking for your trust. Your instincts about their sincerity are probably right.",
    ],
    gemini: [
      "Your mind is buzzing with ideas â€” conversations spark and branch in unexpected directions. Follow the threads.",
      "Mercury sharpens your wit today. Words flow easily, but choose them thoughtfully.",
      "You're the connector today â€” two people in your circle would benefit from knowing each other.",
      "Curiosity is your compass. Ask the question you've been holding back.",
      "Your adaptability lets you meet people exactly where they are. This is a rare gift.",
      "A flood of messages and plans arrives â€” prioritize what truly feeds your spirit.",
      "Duality works in your favor: listen as much as you speak and you'll learn something surprising.",
      "An idea you share casually today plants a seed that comes back in full bloom later.",
    ],
    cancer: [
      "Your intuition about people is especially sharp today â€” trust it. Not everyone deserves access to your inner world.",
      "Emotional tides are high; let yourself feel without explaining. The right people won't need reasons.",
      "Nurturing energy flows from you naturally. Someone close needs care more than advice.",
      "Home and heart are your anchors. Genuine warmth goes further than witty banter.",
      "The moon amplifies your empathy â€” a beautiful gift, but remember to shield your own energy.",
      "An old memory surfaces to teach you something about a current relationship.",
      "Your protective instincts are activated. Check in on someone who's been quiet lately.",
      "Vulnerability is a strength today. Letting your guard down slightly deepens a bond significantly.",
    ],
    leo: [
      "The sun energizes your social presence â€” you light up every room today. Use it generously.",
      "Your warmth draws people toward you. Lead with your heart and let others bask in your attention.",
      "A creative spark turns an ordinary exchange into something memorable. Don't hold back your flair.",
      "Generosity of spirit is your signature. Celebrating someone else's win costs you nothing and means everything.",
      "You're being seen, and rightly so. Let yourself receive appreciation gracefully.",
      "Drama finds its way to you â€” rise above it and you emerge looking like the leader you are.",
      "Playfulness and humor are your bridge into deeper connection today. Don't underestimate lightness.",
      "Someone quietly admires your confidence. A kind word from you could change their day.",
    ],
    virgo: [
      "Your attention to detail serves relationships today. You notice what others miss â€” and it matters.",
      "Mercury sharpens your analytical mind, but the heart resists spreadsheets. Let some things be imperfect.",
      "Service is love in your language. A small, practical gesture means more than grand declarations.",
      "Listen carefully today â€” the real message often hides beneath what's being said.",
      "Your high standards are a gift and a challenge. Extend a little more grace and connections deepen.",
      "An overlooked detail in a recent conversation deserves revisiting. You were right to notice.",
      "Your help is most powerful when it's asked for. Wait to be invited before offering solutions.",
      "Quiet consistency builds the trust that flashy gestures never could. Keep showing up.",
    ],
    libra: [
      "Venus blesses your social grace today â€” harmony comes naturally and others gravitate toward your calm.",
      "Balance is your pursuit, but sometimes choosing a side is an act of love. Don't over-equivocate.",
      "Beauty in connection is your theme. Seek conversations that feel like art, not obligation.",
      "A relationship reaches a crossroads. Fairness and honesty together are your best compass.",
      "Your peacemaking instincts are needed. You're the only one who can bridge a particular divide.",
      "Indecision clears when you ask: what would I want if no one were watching?",
      "Partnership energy is strong. A collaboration discussed today could become something lasting.",
      "Your charm is a tool â€” wield it with intention rather than habit today.",
    ],
    scorpio: [
      "Your perceptive depth cuts through pretense today. You see what others can't â€” trust that vision.",
      "Intensity is your birthright. Channel it into meaningful exchange rather than quiet brooding.",
      "A truth surfaces that needed to come to light. Your ability to hold it without flinching is your strength.",
      "Not everyone can handle your full depth â€” and that's okay. Reveal yourself in layers.",
      "Pluto stirs transformation. A conversation that feels small today reshapes something fundamental.",
      "Your loyalty runs deep; make sure it's reciprocated before you extend more of yourself.",
      "Silence communicates volumes coming from you today. Use it deliberately.",
      "A hidden connection between people or events becomes clear to you â€” follow that thread.",
    ],
    sagittarius: [
      "Your optimism is infectious â€” share it freely. Even a brief exchange can lift someone's entire week.",
      "Adventure calls even in conversation. Seek out minds that challenge your assumptions.",
      "Jupiter expands your social world. A new connection today opens doors you didn't know existed.",
      "Your honesty, while bracing, is exactly what someone in your circle needs to hear.",
      "Freedom and connection aren't opposites today â€” you find both in the right exchange.",
      "A philosophical question worth sitting with: who in your life truly expands your horizons?",
      "Let what genuinely excites you lead â€” your enthusiasm is a renewable resource, and it's contagious.",
      "Seek a perspective wildly different from your own. Mental travel refreshes your social spirit.",
    ],
    capricorn: [
      "Your reliability is a gift. The people who count on you feel it, even when it goes unspoken.",
      "Saturn rewards patience â€” a relationship you've been tending quietly begins to bear fruit.",
      "Practical care is your love language. Small, consistent acts build the trust words alone never could.",
      "Your ambition is admirable, but don't let it crowd out the softer moments today.",
      "A mentor or elder figure offers wisdom worth receiving â€” set aside your self-sufficiency for a moment.",
      "Structure brings you peace, but flexibility unlocks connection. Loosen the plan slightly today.",
      "Long-term thinking guides your relationships. The investment you make today pays dividends.",
      "Someone quietly depends on your steadiness. Simply showing up is more than enough.",
    ],
    aquarius: [
      "Your originality shines in connection today â€” the stranger the conversation, the better.",
      "Uranus sparks unexpected encounters. Someone outside your usual circle carries a key insight.",
      "Your idealism is a compass. Let it guide you toward the relationships that actually matter.",
      "You're ahead of the curve, as usual. Be patient with those still catching up to your vision.",
      "Collective energy feeds you today. Seek out groups, communities, or even a lively group chat.",
      "Detachment is different from indifference â€” you can observe clearly and still care deeply.",
      "An unconventional approach to a stuck situation opens a conversation you'd given up on.",
      "Your friendship is rare and valuable. Someone today is quietly hoping to earn more of it.",
    ],
    pisces: [
      "Your empathy flows like water today, finding every crack. Set intentional limits on what you absorb.",
      "Neptune deepens your intuition â€” you feel the undercurrent of every room you enter.",
      "Dreams and reality blur at the edges. A hunch about someone deserves gentle exploration.",
      "Your compassion is your superpower and your vulnerability. Choose carefully who receives it today.",
      "Share something you love with someone who'd appreciate it â€” art, music, beauty opens hearts.",
      "Forgiveness asks for your attention â€” not because it was deserved, but because you're ready.",
      "A spiritual or creative connection feels fated today. Don't brush it off as coincidence.",
      "Your sensitivity picks up on what others overlook. Trust the feeling that something important is left unsaid.",
    ],
  };

  function getZodiacSign(birthday) {
    const [, mo, dy] = birthday.split('-').map(Number);
    for (const z of ZODIAC) {
      const [[sm, sd], [em, ed]] = z.ranges;
      if (sm > em) { // wraps year (Capricorn)
        if ((mo === sm && dy >= sd) || (mo === em && dy <= ed)) return z;
      } else {
        if ((mo === sm && dy >= sd) || (mo > sm && mo < em) || (mo === em && dy <= ed)) return z;
      }
    }
    return ZODIAC[0];
  }

  function getDailyHoroscope(key, date) {
    const msgs = HOROSCOPES[key];
    if (!msgs) return '';
    const dayOfYear = Math.floor((date - new Date(date.getFullYear(), 0, 0)) / 86400000);
    return msgs[dayOfYear % msgs.length];
  }

  function updateHoroscope(data) {
    const card = document.getElementById('horoscope-card');
    if (!card) return;
    if (!data.birthday) { card.style.display = 'none'; return; }
    const z = getZodiacSign(data.birthday);
    document.getElementById('horoscope-sign').textContent = `${z.emoji} ${z.name}`;
    const textEl = document.getElementById('horoscope-text');
    if (!textEl.classList.contains('loading')) {
      textEl.textContent = getDailyHoroscope(z.key, new Date());
    }
    card.style.display = '';
  }

  function refreshHoroscope() {
    const data = loadData();
    if (!data.birthday) return;
    _horoscopeOffset++;
    const z = getZodiacSign(data.birthday);
    const msgs = HOROSCOPES[z.key];
    const dayOfYear = Math.floor((new Date() - new Date(new Date().getFullYear(), 0, 0)) / 86400000);
    const textEl = document.getElementById('horoscope-text');
    textEl.classList.remove('loading');
    textEl.textContent = msgs[(dayOfYear + _horoscopeOffset) % msgs.length];
    // Spin the button
    const btn = document.getElementById('horoscope-refresh-btn');
    if (btn) {
      btn.classList.remove('spinning');
      void btn.offsetWidth;
      btn.classList.add('spinning');
      btn.addEventListener('transitionend', () => btn.classList.remove('spinning'), { once: true });
    }
  }

  async function askHoroscope() {
    const data = loadData();
    if (!data.birthday) return;
    const questionEl = document.getElementById('horoscope-ask-input');
    const question = questionEl.value.trim();
    if (!question) { refreshHoroscope(); return; }

    const apiKey = localStorage.getItem('conv_horoscope_key');
    const textEl = document.getElementById('horoscope-text');
    const sendBtn = document.getElementById('horoscope-ask-btn');

    if (!apiKey) {
      textEl.classList.remove('loading');
      textEl.textContent = 'Add your Claude API key in âš™ settings to ask specific questions.';
      return;
    }

    const z = getZodiacSign(data.birthday);
    textEl.classList.add('loading');
    textEl.textContent = 'âœ¨ Reading the starsâ€¦';
    sendBtn.disabled = true;

    try {
      const res = await fetch('https://api.anthropic.com/v1/messages', {
        method: 'POST',
        headers: {
          'x-api-key': apiKey,
          'anthropic-version': '2023-06-01',
          'content-type': 'application/json',
          'anthropic-dangerous-direct-browser-access': 'true',
        },
        body: JSON.stringify({
          model: 'claude-haiku-4-5-20251001',
          max_tokens: 180,
          system: `You are a warm, intuitive astrologer. The person is a ${z.name}. Give a short personalized reading in 2-3 sentences. Be mystical but grounded, speak directly to them as a wise friend would.`,
          messages: [{ role: 'user', content: `Today I'm wondering about: ${question}` }]
        })
      });
      if (!res.ok) throw new Error(res.status);
      const json = await res.json();
      textEl.classList.remove('loading');
      textEl.textContent = json.content[0].text;
      questionEl.value = '';
    } catch (e) {
      textEl.classList.remove('loading');
      textEl.textContent = 'The stars are cloudy right now â€” try again in a moment.';
    } finally {
      sendBtn.disabled = false;
    }
  }

  // â”€â”€ Moon phase (pure JS, no API needed) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function getMoonPhaseInfo(date) {
    const JD    = date.getTime() / 86400000 + 2440587.5;
    const phase = ((JD - 2451550.1) % 29.530588853 + 29.530588853) % 29.530588853;
    if (phase < 1.85)  return { name: 'New Moon',        emoji: 'ğŸŒ‘', modifier: -15 };
    if (phase < 7.38)  return { name: 'Waxing Crescent', emoji: 'ğŸŒ’', modifier:  +5 };
    if (phase < 9.22)  return { name: 'First Quarter',   emoji: 'ğŸŒ“', modifier: +10 };
    if (phase < 14.77) return { name: 'Waxing Gibbous',  emoji: 'ğŸŒ”', modifier: +15 };
    if (phase < 16.61) return { name: 'Full Moon',       emoji: 'ğŸŒ•', modifier: +20 };
    if (phase < 22.15) return { name: 'Waning Gibbous',  emoji: 'ğŸŒ–', modifier:  +5 };
    if (phase < 24.0)  return { name: 'Last Quarter',    emoji: 'ğŸŒ—', modifier:  -5 };
    return                    { name: 'Waning Crescent', emoji: 'ğŸŒ˜', modifier: -10 };
  }

  // â”€â”€ Menstrual cycle phase â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function getCyclePhaseInfo(lastPeriodStart, cycleLength) {
    const today = new Date(); today.setHours(0,0,0,0);
    const last  = new Date(lastPeriodStart + 'T00:00:00');
    const cycleDay = (Math.floor((today - last) / 86400000) % cycleLength) + 1;
    if (cycleDay <= 5)  return { name: 'Menstrual phase',  modifier: -20, day: cycleDay };
    if (cycleDay <= 13) return { name: 'Follicular phase', modifier: +15, day: cycleDay };
    if (cycleDay <= 17) return { name: 'Ovulation phase',  modifier: +20, day: cycleDay };
    return                     { name: 'Luteal phase',     modifier: -10, day: cycleDay };
  }

  // â”€â”€ Token helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function getTodayTokens(data) {
    return (data.tokenDays && data.tokenDays[todayStr()]) || null;
  }

  function setTodayTokens(data, current, dailyMax) {
    if (!data.tokenDays) data.tokenDays = {};
    data.tokenDays[todayStr()] = { current, dailyMax };
  }

  function getGroupType(group) { return group.type || 'neutral'; }

  function getPersonCost(name, groupType, data) {
    if (data.personCosts && data.personCosts[name] !== undefined) return data.personCosts[name];
    return { work: 1, friend: -1, family: 0, neutral: 0 }[groupType] ?? 0;
  }

  // â”€â”€ Candle visual â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function updateCandleVisual(data) {
    const td       = getTodayTokens(data);
    const current  = td ? td.current  : null;
    const dailyMax = td ? td.dailyMax : null;
    const pct = (current !== null && dailyMax > 0) ? Math.max(0, Math.min(1, current / dailyMax)) : 0;

    const bodyY = 40, bodyH = 106;
    const fillH = Math.max(0, bodyH * pct);
    const fillY = bodyY + bodyH - fillH;

    const fillEl   = document.getElementById('candle-fill');
    const shineEl  = document.getElementById('candle-shine');
    const flameEl  = document.getElementById('candle-flame');
    const puddleEl = document.getElementById('candle-puddle');
    const wickEl   = document.getElementById('candle-wick');

    if (fillEl)  { fillEl.setAttribute('y', fillY);  fillEl.setAttribute('height', fillH); }
    if (shineEl) {
      shineEl.setAttribute('y', fillY + 3);
      shineEl.setAttribute('height', Math.max(0, Math.min(fillH - 6, 36)));
      shineEl.style.display = fillH > 9 ? '' : 'none';
    }

    const burned = current !== null && current <= 0;
    if (flameEl)  flameEl.style.display  = burned ? 'none' : '';
    if (puddleEl) puddleEl.style.display = burned ? ''     : 'none';
    if (wickEl)   wickEl.setAttribute('opacity', burned ? '0.3' : '1');

    const tokenEl = document.getElementById('candle-tokens');
    if (tokenEl) tokenEl.innerHTML = current !== null
      ? `${current} <span>/ ${dailyMax}</span>`
      : `â€” <span>tokens</span>`;

    const barEl = document.getElementById('token-bar-fill');
    if (barEl) barEl.style.width = current !== null ? (pct * 100) + '%' : '0%';

    const burnoutEl = document.getElementById('candle-burnout');
    if (burnoutEl) burnoutEl.style.display = burned ? 'block' : 'none';
  }

  function updateCandlePhase(data) {
    const phaseEl = document.getElementById('candle-phase');
    if (!phaseEl) return;
    const moon = getMoonPhaseInfo(new Date());
    if (!data.cycleData || !data.cycleData.lastPeriodStart) {
      phaseEl.textContent = `${moon.emoji} ${moon.name}`;
      return;
    }
    const cycle = getCyclePhaseInfo(data.cycleData.lastPeriodStart, data.cycleData.cycleLength || 28);
    phaseEl.textContent = `${moon.emoji} ${moon.name} Â· ${cycle.name}`;
  }

  function triggerFlameAnimation(type) {
    const flameEl = document.getElementById('candle-flame');
    const wrapEl  = document.getElementById('candle-svg-wrap');
    if (!flameEl) return;
    const cleanup = () => flameEl.classList.remove('pulse-burn', 'pulse-grow');
    if (type === 'work') {
      flameEl.classList.remove('pulse-burn', 'pulse-grow');
      void flameEl.offsetWidth;
      flameEl.classList.add('pulse-burn');
      flameEl.addEventListener('animationend', cleanup, { once: true });
    } else if (type === 'friend') {
      flameEl.classList.remove('pulse-burn', 'pulse-grow');
      void flameEl.offsetWidth;
      flameEl.classList.add('pulse-grow');
      flameEl.addEventListener('animationend', cleanup, { once: true });
      if (wrapEl) {
        wrapEl.classList.remove('glow');
        void wrapEl.offsetWidth;
        wrapEl.classList.add('glow');
        wrapEl.addEventListener('animationend', () => wrapEl.classList.remove('glow'), { once: true });
      }
    }
  }

  // â”€â”€ Daily suggestion â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function checkDailySuggestion(data) {
    if (getTodayTokens(data)) return; // already set today
    if (!data.cycleData || !data.cycleData.lastPeriodStart) {
      document.getElementById('setup-modal').classList.remove('hidden');
      return;
    }
    openSuggestModal(data);
  }

  function openSuggestModal(data) {
    const moon   = getMoonPhaseInfo(new Date());
    const base   = 80;
    let tokens   = base + moon.modifier;
    let cyclePart = '';
    if (data.cycleData && data.cycleData.lastPeriodStart) {
      const cycle = getCyclePhaseInfo(data.cycleData.lastPeriodStart, data.cycleData.cycleLength || 28);
      tokens += cycle.modifier;
      cyclePart = ` + ${cycle.name.toLowerCase()}`;
    }
    tokens = Math.max(40, Math.min(120, tokens));
    _pendingSuggestedTokens = tokens;

    const power = tokens >= 100 ? 'full power' : tokens >= 80 ? 'good energy' : tokens >= 60 ? 'moderate energy' : 'low energy';
    document.getElementById('suggest-moon').textContent  = moon.emoji;
    document.getElementById('suggest-label').textContent = `${moon.name}${cyclePart} â€” you're probably at ${power} today. Suggested: ${tokens}`;
    document.getElementById('nudge-value').textContent   = tokens;
    document.getElementById('suggest-modal').classList.remove('hidden');
  }

  function nudgeTokens(delta) {
    _pendingSuggestedTokens = Math.max(40, Math.min(120, _pendingSuggestedTokens + delta));
    document.getElementById('nudge-value').textContent = _pendingSuggestedTokens;
  }

  function confirmTokens() {
    const data = loadData();
    setTodayTokens(data, _pendingSuggestedTokens, _pendingSuggestedTokens);
    saveData(data);
    document.getElementById('suggest-modal').classList.add('hidden');
    updateCandleVisual(data);
    updateCandlePhase(data);
  }

  function dismissSuggest() {
    const data = loadData();
    if (!getTodayTokens(data)) { setTodayTokens(data, 80, 80); saveData(data); }
    document.getElementById('suggest-modal').classList.add('hidden');
    updateCandleVisual(data);
    updateCandlePhase(data);
  }

  function saveSetupAndSuggest() {
    const dateInput   = document.getElementById('setup-period-date');
    const lengthInput = document.getElementById('setup-cycle-length');
    if (!dateInput.value) {
      dateInput.style.borderColor = '#A85C7A';
      setTimeout(() => dateInput.style.borderColor = '', 1000);
      return;
    }
    const data = loadData();
    data.cycleData = { lastPeriodStart: dateInput.value, cycleLength: parseInt(lengthInput.value) || 28 };
    saveData(data);
    document.getElementById('setup-modal').classList.add('hidden');
    openSuggestModal(data);
  }

  function skipSetup() {
    document.getElementById('setup-modal').classList.add('hidden');
    const data = loadData();
    if (!getTodayTokens(data)) {
      const moon   = getMoonPhaseInfo(new Date());
      const tokens = Math.max(40, Math.min(120, 80 + moon.modifier));
      setTodayTokens(data, tokens, tokens);
      saveData(data);
    }
    updateCandleVisual(data);
    updateCandlePhase(data);
  }

  // â”€â”€ Settings panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function openSettings() {
    const data = loadData();
    const moon = getMoonPhaseInfo(new Date());

    document.getElementById('settings-moon-emoji').textContent = moon.emoji;
    document.getElementById('settings-moon-name').textContent  = moon.name;
    const moonModEl = document.getElementById('settings-moon-mod');
    moonModEl.textContent = (moon.modifier >= 0 ? '+' : '') + moon.modifier;
    moonModEl.className = 'forecast-mod' + (moon.modifier < 0 ? ' negative' : '');

    const cycleNameEl = document.getElementById('settings-cycle-name');
    const cycleModEl  = document.getElementById('settings-cycle-mod');

    let suggested;
    if (data.cycleData && data.cycleData.lastPeriodStart) {
      const cycle = getCyclePhaseInfo(data.cycleData.lastPeriodStart, data.cycleData.cycleLength || 28);
      cycleNameEl.textContent = cycle.name;
      cycleModEl.textContent  = (cycle.modifier >= 0 ? '+' : '') + cycle.modifier;
      cycleModEl.className    = 'forecast-mod' + (cycle.modifier < 0 ? ' negative' : '');
      suggested = Math.max(40, Math.min(120, 80 + moon.modifier + cycle.modifier));
      document.getElementById('settings-period-date').value   = data.cycleData.lastPeriodStart;
      document.getElementById('settings-cycle-length').value  = data.cycleData.cycleLength || 28;
    } else {
      cycleNameEl.textContent = 'Not set yet';
      cycleModEl.textContent  = 'â€”';
      cycleModEl.className    = 'forecast-mod';
      suggested = Math.max(40, Math.min(120, 80 + moon.modifier));
    }

    document.getElementById('settings-suggested').textContent = suggested;

    // API key
    const savedKey = localStorage.getItem('conv_horoscope_key');
    if (savedKey) document.getElementById('settings-api-key').value = savedKey;

    // Horoscope
    const birthdayInput = document.getElementById('settings-birthday');
    if (data.birthday) birthdayInput.value = data.birthday;
    const hDivider = document.getElementById('settings-horoscope-divider');
    const hZodiac  = document.getElementById('settings-zodiac-row');
    const hText    = document.getElementById('settings-horoscope-text');
    if (data.birthday) {
      const z = getZodiacSign(data.birthday);
      document.getElementById('settings-zodiac-emoji').textContent = z.emoji;
      document.getElementById('settings-zodiac-name').textContent  = z.name;
      hText.textContent = getDailyHoroscope(z.key, new Date());
      hDivider.style.display = hZodiac.style.display = hText.style.display = '';
    } else {
      hDivider.style.display = hZodiac.style.display = hText.style.display = 'none';
    }

    document.getElementById('settings-modal').classList.remove('hidden');
  }

  function closeSettings() {
    document.getElementById('settings-modal').classList.add('hidden');
  }

  function saveSettings() {
    const dateEl     = document.getElementById('settings-period-date');
    const lengthEl   = document.getElementById('settings-cycle-length');
    const birthdayEl = document.getElementById('settings-birthday');
    if (!dateEl.value) {
      dateEl.style.borderColor = '#A85C7A';
      setTimeout(() => dateEl.style.borderColor = '', 1000);
      return;
    }
    const apiKeyEl = document.getElementById('settings-api-key');
    if (apiKeyEl.value.trim()) localStorage.setItem('conv_horoscope_key', apiKeyEl.value.trim());
    const data = loadData();
    data.cycleData = { lastPeriodStart: dateEl.value, cycleLength: parseInt(lengthEl.value) || 28 };
    if (birthdayEl.value) data.birthday = birthdayEl.value;
    saveData(data);
    updateCandlePhase(data);
    updateHoroscope(data);
    closeSettings();
  }

  // â”€â”€ Manual token adjust â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function adjustTokens(delta) {
    const data = loadData();
    const td   = getTodayTokens(data);
    if (!td) return;
    td.current = Math.max(0, Math.min(td.dailyMax, td.current + delta));
    saveData(data);
    updateCandleVisual(data);
  }

  // â”€â”€ Group type cycling â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function cycleGroupType(groupId) {
    const data  = loadData();
    const group = data.groups.find(g => g.id === groupId);
    if (!group) return;
    const idx   = GROUP_TYPE_ORDER.indexOf(group.type || 'neutral');
    group.type  = GROUP_TYPE_ORDER[(idx + 1) % GROUP_TYPE_ORDER.length];
    saveData(data);
    render();
  }

  // â”€â”€ Color utils â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function hexToHsl(hex) {
    let r = parseInt(hex.slice(1,3),16)/255;
    let g = parseInt(hex.slice(3,5),16)/255;
    let b = parseInt(hex.slice(5,7),16)/255;
    const max = Math.max(r,g,b), min = Math.min(r,g,b), d = max-min;
    let h=0, s=0, l=(max+min)/2;
    if (d) {
      s = d / (1 - Math.abs(2*l-1));
      switch(max) {
        case r: h=((g-b)/d+6)%6; break;
        case g: h=(b-r)/d+2;     break;
        case b: h=(r-g)/d+4;     break;
      }
      h /= 6;
    }
    return [h*360, s*100, l*100];
  }

  function hslToHex(h, s, l) {
    h/=360; s/=100; l/=100;
    const a = s*Math.min(l,1-l);
    const f = n => {
      const k=(n+h*12)%12;
      return l - a*Math.max(-1,Math.min(k-3,9-k,1));
    };
    return '#'+[f(0),f(8),f(4)].map(x=>Math.round(x*255).toString(16).padStart(2,'0')).join('');
  }

  function lighten(hex, amt=30) {
    if (!/^#[0-9a-f]{6}$/i.test(hex)) return hex;
    const [h,s,l] = hexToHsl(hex);
    return hslToHex(h, Math.max(0,s-10), Math.min(94,l+amt));
  }

  function darken(hex, amt=22) {
    if (!/^#[0-9a-f]{6}$/i.test(hex)) return hex;
    const [h,s,l] = hexToHsl(hex);
    return hslToHex(h, Math.min(100,s+5), Math.max(5,l-amt));
  }

  // â”€â”€ Utils â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function todayStr() { return new Date().toLocaleDateString('en-CA'); }

  function uid() { return 'g' + Date.now() + Math.random().toString(36).slice(2,5); }

  function escapeHtml(s) {
    return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
  }

  function getPriorDays(n, beforeDate) {
    const result = [];
    const d = new Date(beforeDate + 'T00:00:00');
    for (let i=1; i<=n; i++) {
      const p = new Date(d);
      p.setDate(d.getDate()-i);
      result.push(p.toLocaleDateString('en-CA'));
    }
    return result;
  }

  function getAllPeople(data) { return data.groups.flatMap(g => g.people); }

  // â”€â”€ Avatar utils â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function nameHash(name) {
    return name.split('').reduce((h,c) => Math.imul(h,31) + c.charCodeAt(0) | 0, 0);
  }

  // Draw one standing person's SVG elements at center-x=cx, feet at baseY=52
  function _p(cx, type) {
    const P = {
      adult:   { cy:18, r:5.5, n:23.5, hip:36.5, ay:28.4, ax:7,   ae:33.4, lx:3.5, sw:4.5, sw2:4   },
      elderly: { cy:18, r:5.5, n:23.5, hip:36.5, ay:28.4, ax:7,   ae:33.4, lx:3.5, sw:4.5, sw2:4   },
      child:   { cy:27, r:4,   n:31,   hip:40,   ay:34.5, ax:5,   ae:38.5, lx:2.5, sw:3.5, sw2:3   },
      toddler: { cy:33, r:3,   n:36,   hip:43,   ay:39,   ax:3.5, ae:41.5, lx:2,   sw:3,   sw2:2.5 },
    };
    const q = P[type] || P.adult;
    let s = `<circle cx="${cx}" cy="${q.cy}" r="${q.r}" stroke="none"/>
      <line x1="${cx}" y1="${q.n}"  x2="${cx}" y2="${q.hip}" stroke-width="${q.sw}"/>
      <line x1="${cx}" y1="${q.ay}" x2="${cx-q.ax}" y2="${q.ae}" stroke-width="${q.sw2}"/>
      <line x1="${cx}" y1="${q.ay}" x2="${cx+q.ax}" y2="${q.ae}" stroke-width="${q.sw2}"/>
      <line x1="${cx}" y1="${q.hip}" x2="${cx-q.lx}" y2="52" stroke-width="${q.sw2}"/>
      <line x1="${cx}" y1="${q.hip}" x2="${cx+q.lx}" y2="52" stroke-width="${q.sw2}"/>`;
    if (type === 'elderly')
      s += `<line x1="${cx+q.ax}" y1="${q.ae}" x2="${cx+q.ax+5}" y2="52" stroke-width="2.5"/>`;
    return s;
  }

  // Hand positions (right/left) for a person type
  function _hr(cx, t) { return { x: cx + ({adult:7,elderly:7,child:5,toddler:3.5}[t]||7), y: ({adult:33.4,elderly:33.4,child:38.5,toddler:41.5}[t]||33.4) }; }
  function _hl(cx, t) { return { x: cx - ({adult:7,elderly:7,child:5,toddler:3.5}[t]||7), y: ({adult:33.4,elderly:33.4,child:38.5,toddler:41.5}[t]||33.4) }; }

  // Build a family-group SVG
  function _familySVG(figures, vw, color, size, holding) {
    const vh = 56, w = Math.round(size * vw / vh);
    let inner = '';
    if (holding) {
      for (let i = 0; i < figures.length - 1; i++) {
        const a = figures[i], b = figures[i+1];
        const ra = _hr(a.cx, a.t), lb = _hl(b.cx, b.t);
        inner += `<line x1="${ra.x}" y1="${ra.y}" x2="${lb.x}" y2="${lb.y}" stroke-width="3"/>`;
      }
    }
    figures.forEach(f => inner += _p(f.cx, f.t));
    return `<svg viewBox="0 0 ${vw} ${vh}" width="${w}" height="${size}" xmlns="http://www.w3.org/2000/svg">
      <g stroke="${color}" stroke-linecap="round" stroke-linejoin="round" fill="${color}">${inner}</g></svg>`;
  }

  // 6 family configurations (matching reference image)
  const FAMILY_DEFS = [
    { f:[{cx:14,t:'adult'},{cx:36,t:'adult'},{cx:56,t:'child'}],                              vw:70, h:false }, // adult+adult+child
    { f:[{cx:13,t:'adult'},{cx:37,t:'elderly'}],                                              vw:56, h:false }, // adult+elderly w/ cane
    { f:[{cx:11,t:'child'},{cx:28,t:'adult'},{cx:51,t:'adult'},{cx:68,t:'child'}],            vw:80, h:false }, // 2+2 family
    { f:[{cx:14,t:'adult'},{cx:31,t:'toddler'},{cx:49,t:'adult'}],                            vw:63, h:false }, // adult+toddler+adult
    { f:[{cx:14,t:'adult'},{cx:38,t:'adult'}],                                                vw:52, h:false }, // couple
    { f:[{cx:11,t:'child'},{cx:28,t:'adult'},{cx:51,t:'adult'},{cx:68,t:'child'}],            vw:80, h:true  }, // 4 holding hands
  ];

  // Jumping figure (Friends)
  function svgJumping(color, size) {
    const vw=40, vh=52, w=Math.round(size*vw/vh);
    return `<svg viewBox="0 0 ${vw} ${vh}" width="${w}" height="${size}" xmlns="http://www.w3.org/2000/svg">
      <g stroke="${color}" stroke-linecap="round" stroke-linejoin="round" fill="${color}">
        <circle cx="21" cy="8" r="6" stroke="none"/>
        <line x1="21" y1="14" x2="20" y2="30" stroke-width="5"/>
        <line x1="21" y1="19" x2="33" y2="7"  stroke-width="4"/>
        <line x1="21" y1="19" x2="9"  y2="23" stroke-width="4"/>
        <line x1="20" y1="30" x2="16" y2="44" stroke-width="4"/>
        <line x1="20" y1="30" x2="29" y2="40" stroke-width="4"/>
        <line x1="29" y1="40" x2="22" y2="49" stroke-width="4"/>
      </g></svg>`;
  }

  // Briefcase standing (Work)
  function svgBriefcaseStand(color, size) {
    const vw=42, vh=56, w=Math.round(size*vw/vh);
    return `<svg viewBox="0 0 ${vw} ${vh}" width="${w}" height="${size}" xmlns="http://www.w3.org/2000/svg">
      <g stroke="${color}" stroke-linecap="round" stroke-linejoin="round" fill="${color}">
        <circle cx="19" cy="8" r="6" stroke="none"/>
        <line x1="19" y1="14" x2="19" y2="31" stroke-width="5"/>
        <line x1="19" y1="20" x2="10" y2="27" stroke-width="4"/>
        <line x1="19" y1="20" x2="28" y2="26" stroke-width="4"/>
        <rect x="25" y="27" width="12" height="8" rx="2" stroke="none"/>
        <path d="M28 27 L28 25 Q29.5 23 31 25 L31 27" fill="none" stroke-width="2"/>
        <line x1="19" y1="31" x2="15" y2="52" stroke-width="4"/>
        <line x1="19" y1="31" x2="23" y2="52" stroke-width="4"/>
      </g></svg>`;
  }

  // Briefcase running (Work)
  function svgBriefcaseRun(color, size) {
    const vw=52, vh=54, w=Math.round(size*vw/vh);
    return `<svg viewBox="0 0 ${vw} ${vh}" width="${w}" height="${size}" xmlns="http://www.w3.org/2000/svg">
      <g stroke="${color}" stroke-linecap="round" stroke-linejoin="round" fill="${color}">
        <circle cx="33" cy="8" r="6" stroke="none"/>
        <line x1="31" y1="14" x2="24" y2="30" stroke-width="5"/>
        <line x1="29" y1="20" x2="42" y2="15" stroke-width="4"/>
        <rect x="39" y="8"  width="12" height="9" rx="2" stroke="none"/>
        <line x1="27" y1="22" x2="14" y2="26" stroke-width="4"/>
        <rect x="7"  y="21" width="9"  height="7" rx="2" stroke="none"/>
        <line x1="24" y1="30" x2="18" y2="46" stroke-width="4"/>
        <line x1="18" y1="46" x2="10" y2="52" stroke-width="4"/>
        <line x1="24" y1="30" x2="33" y2="42" stroke-width="4"/>
        <line x1="33" y1="42" x2="41" y2="36" stroke-width="4"/>
      </g></svg>`;
  }

  function buildAvatarSVG(name, color, size, groupType) {
    const h = Math.abs(nameHash(name));
    if (groupType === 'friend')  return svgJumping(color, size);
    if (groupType === 'work')    return h % 2 === 0 ? svgBriefcaseStand(color, size) : svgBriefcaseRun(color, size);
    if (groupType === 'family') {
      const d = FAMILY_DEFS[h % FAMILY_DEFS.length];
      return _familySVG(d.f, d.vw, color, size, d.h);
    }
    // neutral: cycle through all poses
    const all = [
      (c,s) => svgJumping(c, s),
      (c,s) => svgBriefcaseStand(c, s),
      (c,s) => svgBriefcaseRun(c, s),
      (c,s) => _familySVG(FAMILY_DEFS[0].f, FAMILY_DEFS[0].vw, c, s, false),
      (c,s) => _familySVG(FAMILY_DEFS[4].f, FAMILY_DEFS[4].vw, c, s, false),
      (c,s) => _familySVG(FAMILY_DEFS[3].f, FAMILY_DEFS[3].vw, c, s, false),
    ];
    return all[h % all.length](color, size);
  }

  function buildCentralSVG(size=52) {
    const vw=40, vh=52, w=Math.round(size*vw/vh);
    return `<svg viewBox="0 0 ${vw} ${vh}" width="${w}" height="${size}" xmlns="http://www.w3.org/2000/svg">
      <g stroke="#4A5228" stroke-linecap="round" stroke-linejoin="round" fill="#4A5228">
        <circle cx="20" cy="8" r="6.5" stroke="none"/>
        <line x1="20" y1="15" x2="20" y2="31" stroke-width="5"/>
        <line x1="20" y1="20" x2="11" y2="27" stroke-width="4"/>
        <line x1="20" y1="20" x2="29" y2="27" stroke-width="4"/>
        <line x1="20" y1="31" x2="16" y2="49" stroke-width="4"/>
        <line x1="20" y1="31" x2="24" y2="49" stroke-width="4"/>
      </g>
      <path d="M20 3 L21.3 7 L25 7 L22.1 9.1 L23.2 13 L20 10.8 L16.8 13 L17.9 9.1 L15 7 L18.7 7 Z" fill="#D4882A" stroke="none"/>
    </svg>`;
  }

  function crowdPosition(index) {
    const goldenAngle = Math.PI * (3 - Math.sqrt(5));
    const r = 55 + 22 * Math.sqrt(index);
    const a = index * goldenAngle;
    return { dx: r * Math.cos(a), dy: r * Math.sin(a) };
  }

  function avatarSize(count) {
    return Math.round(28 + Math.min(count - 1, 6) * 7);
  }

  // â”€â”€ Day transition â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function handleDayTransition(data, today) {
    const last3 = getPriorDays(3, today);
    if (!data.regulars) data.regulars = [];

    const hasHistory = Object.keys(data.days).some(k => k <= last3[2]);
    if (!hasHistory) return data;

    data.groups.forEach(group => {
      group.people = group.people.filter(name => {
        const counts = last3.map(d => (data.days[d] && data.days[d][name]) || 0);
        if (counts.every(c => c === 0)) {
          data.regulars = data.regulars.filter(r => r !== name);
          return false;
        }
        return true;
      });
    });

    getAllPeople(data).forEach(name => {
      const counts = last3.map(d => (data.days[d] && data.days[d][name]) || 0);
      const allActive = counts.every(c => c > 0);
      if (allActive && !data.regulars.includes(name)) {
        data.regulars.push(name);
      } else if (!allActive) {
        data.regulars = data.regulars.filter(r => r !== name);
      }
    });

    return data;
  }

  // â”€â”€ Data â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function loadData() {
    const raw = localStorage.getItem(STORAGE_KEY);
    let data;

    if (!raw) {
      data = {
        groups: [
          { id: uid(), name: 'Work',     people: [], color: GROUP_COLORS[0] },
          { id: uid(), name: 'Personal', people: [], color: GROUP_COLORS[1] }
        ],
        days: {}, regulars: [], lastDate: todayStr()
      };
      saveData(data);
      return data;
    }

    data = JSON.parse(raw);

    // Migrate v1 (people as objects with .count)
    if (data.date !== undefined && !data.days) {
      const old = data.people || [];
      const hist = {};
      if (old.some(p => p.count > 0)) {
        hist[data.date] = {};
        old.forEach(p => { hist[data.date][p.name] = p.count; });
      }
      data = { people: old.map(p => p.name), days: hist, regulars: [], lastDate: data.date };
    }

    // Migrate v2 (flat data.people â†’ groups)
    if (!data.groups && Array.isArray(data.people)) {
      data.groups = [{ id: uid(), name: 'General', people: data.people, color: GROUP_COLORS[0] }];
      delete data.people;
    }

    if (!data.regulars) data.regulars = [];
    if (!data.groups)   data.groups   = [];

    // Ensure every group has a color and a type
    data.groups.forEach((g, i) => {
      if (!g.color) g.color = GROUP_COLORS[i % GROUP_COLORS.length];
      if (!g.type) {
        const n = (g.name || '').toLowerCase();
        if (n.includes('work') || n.includes('office') || n.includes('professional') || n.includes('colleague')) g.type = 'work';
        else if (n.includes('family') || n.includes('fam') || n.includes('parent') || n.includes('sibling'))     g.type = 'family';
        else g.type = 'friend';
      }
    });

    if (!data.tokenDays) data.tokenDays = {};
    if (!data.personCosts) data.personCosts = {};
    if (data.birthday === undefined) data.birthday = null;
    if (data.cycleData === undefined) data.cycleData = null;

    const today = todayStr();
    if (data.lastDate && data.lastDate !== today) {
      data = handleDayTransition(data, today);
    }
    data.lastDate = today;
    saveData(data);
    return data;
  }

  function saveData(data) { localStorage.setItem(STORAGE_KEY, JSON.stringify(data)); }

  // â”€â”€ Crowd rendering â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function renderCrowd(data) {
    const canvas = document.getElementById('crowd-canvas');

    // Build / refresh central figure
    if (!canvas.querySelector('.central-figure')) {
      const fig = document.createElement('div');
      fig.className = 'central-figure';
      fig.innerHTML = buildCentralSVG(52);
      canvas.appendChild(fig);
      const lbl = document.createElement('div');
      lbl.className = 'central-label';
      lbl.textContent = 'you';
      canvas.appendChild(lbl);
    }

    // Remove all existing crowd avatars
    canvas.querySelectorAll('.crowd-avatar').forEach(el => el.remove());

    const today = todayStr();
    const todayCounts = data.days[today] || {};
    const W = canvas.offsetWidth  || 480;
    const H = canvas.offsetHeight || 260;

    let idx = 0;
    data.groups.forEach(group => {
      group.people.forEach(name => {
        const count = todayCounts[name] || 0;
        if (count > 0) {
          addAvatarToCanvas(name, idx, count, group.color, false, W, H, getGroupType(group));
          idx++;
        }
      });
    });

    const total = Object.values(todayCounts).reduce((s,v) => s+v, 0);
    updateCrowdLabel(total);
  }

  function addAvatarToCanvas(name, index, count, color, animate, W, H, groupType) {
    const canvas = document.getElementById('crowd-canvas');
    const cx = W / 2;
    const cy = H / 2;
    const pos  = crowdPosition(index);
    const size = avatarSize(count);

    const div = document.createElement('div');
    div.className = 'crowd-avatar';
    div.dataset.name = name;
    div.dataset.groupType = groupType || 'neutral';
    div.innerHTML = buildAvatarSVG(name, color, size, groupType || 'neutral') +
      `<div class="avatar-tip">${escapeHtml(name)} Â· ${count}</div>`;

    const finalLeft = cx + pos.dx;
    const finalTop  = cy + pos.dy;

    if (animate) {
      const scale = Math.max(3, 180 / Math.max(1, Math.hypot(pos.dx, pos.dy)));
      div.style.left      = (cx + pos.dx * scale) + 'px';
      div.style.top       = (cy + pos.dy * scale) + 'px';
      div.style.transform = 'translate(-50%, -50%) scale(0.1)';
      div.style.opacity   = '0';
      canvas.appendChild(div);

      requestAnimationFrame(() => requestAnimationFrame(() => {
        div.style.transition = [
          'left 0.7s cubic-bezier(0.34,1.56,0.64,1)',
          'top 0.7s cubic-bezier(0.34,1.56,0.64,1)',
          'transform 0.7s cubic-bezier(0.34,1.56,0.64,1)',
          'opacity 0.4s ease'
        ].join(', ');
        div.style.left      = finalLeft + 'px';
        div.style.top       = finalTop  + 'px';
        div.style.transform = 'translate(-50%, -50%) scale(1)';
        div.style.opacity   = '1';
      }));
    } else {
      div.style.left      = finalLeft + 'px';
      div.style.top       = finalTop  + 'px';
      div.style.transform = 'translate(-50%, -50%)';
      div.style.opacity   = '1';
      canvas.appendChild(div);
    }
  }

  function pulseAvatar(name, count) {
    const canvas = document.getElementById('crowd-canvas');
    const div = Array.from(canvas.querySelectorAll('.crowd-avatar'))
      .find(el => el.dataset.name === name);
    if (!div) return;

    const size = avatarSize(count);
    const svg  = div.querySelector('svg');
    if (svg) {
      const vb = (svg.getAttribute('viewBox') || '0 0 40 52').split(' ');
      const vw = parseFloat(vb[2]) || 40, vh = parseFloat(vb[3]) || 52;
      svg.setAttribute('height', size);
      svg.setAttribute('width', Math.round(size * vw / vh));
    }
    const tip = div.querySelector('.avatar-tip');
    if (tip) tip.textContent = `${name} Â· ${count}`;

    div.classList.remove('pulse');
    void div.offsetWidth;
    div.classList.add('pulse');
  }

  function updateCrowdLabel(total) {
    const el = document.getElementById('crowd-stats');
    if (!el) return;
    el.textContent = total === 0
      ? 'No conversations yet today'
      : `${total} conversation${total === 1 ? '' : 's'} today`;
  }

  // â”€â”€ Main render â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function render() {
    const data = loadData();
    const todayCounts = data.days[todayStr()] || {};
    const container = document.getElementById('groups-container');
    container.innerHTML = '';

    let grandTotal = 0;

    data.groups.forEach(group => {
      const groupTotal = group.people.reduce((s,n) => s + (todayCounts[n] || 0), 0);
      grandTotal += groupTotal;

      const section = document.createElement('div');
      section.className = 'group-section';
      section.dataset.groupId = group.id;

      // Header
      const header = document.createElement('div');
      header.className = 'group-header';

      // Left side: color swatch + editable name
      const left = document.createElement('div');
      left.className = 'group-header-left';

      const swatch = document.createElement('label');
      swatch.className = 'color-swatch';
      swatch.style.background = group.color;
      swatch.title = 'Change group color';
      const colorInput = document.createElement('input');
      colorInput.type = 'color';
      colorInput.className = 'color-input';
      colorInput.value = group.color;
      colorInput.addEventListener('input', e => {
        const newColor = e.target.value;
        swatch.style.background = newColor;
        const d = loadData();
        const g = d.groups.find(x => x.id === group.id);
        if (g) { g.color = newColor; saveData(d); renderCrowd(d); }
      });
      swatch.appendChild(colorInput);
      left.appendChild(swatch);

      const nameEl = document.createElement('span');
      nameEl.className = 'group-name';
      nameEl.contentEditable = 'true';
      nameEl.spellcheck = false;
      nameEl.textContent = group.name;
      nameEl.addEventListener('keydown', e => {
        if (e.key === 'Enter' || e.key === 'Escape') { e.preventDefault(); nameEl.blur(); }
      });
      nameEl.addEventListener('blur', () => {
        const newName = nameEl.textContent.trim() || 'Group';
        const d = loadData();
        const g = d.groups.find(x => x.id === group.id);
        if (g) { g.name = newName; saveData(d); }
        nameEl.textContent = newName;
      });
      left.appendChild(nameEl);
      header.appendChild(left);

      // Right side: group total + type + delete
      const right = document.createElement('div');
      right.className = 'group-header-right';
      right.innerHTML = `<span class="group-total"><b>${groupTotal}</b> today</span>`;
      const typeBtn = document.createElement('button');
      typeBtn.className = 'group-type-btn';
      const gType = getGroupType(group);
      typeBtn.title = `Type: ${gType} â€” click to change`;
      typeBtn.textContent = GROUP_TYPES[gType];
      typeBtn.addEventListener('click', () => cycleGroupType(group.id));
      right.appendChild(typeBtn);
      const delBtn = document.createElement('button');
      delBtn.className = 'group-delete-btn';
      delBtn.title = 'Delete group';
      delBtn.textContent = 'Ã—';
      delBtn.addEventListener('click', () => deleteGroup(group.id));
      right.appendChild(delBtn);
      header.appendChild(right);

      section.appendChild(header);

      // Body (drop zone)
      const body = document.createElement('div');
      body.className = 'group-body';
      body.addEventListener('dragover',  e => { e.preventDefault(); e.dataTransfer.dropEffect = 'move'; });
      body.addEventListener('dragenter', e => { if (!body.contains(e.relatedTarget)) body.classList.add('drag-over'); });
      body.addEventListener('dragleave', e => { if (!body.contains(e.relatedTarget)) body.classList.remove('drag-over'); });
      body.addEventListener('drop',      e => onDrop(e, group.id));

      const COST_DEFAULTS = { work: 1, friend: -1, family: 0, neutral: 0 };
      group.people.forEach(name => {
        const count = todayCounts[name] || 0;
        const isRegular = data.regulars.includes(name);
        const personCost = (data.personCosts && data.personCosts[name] !== undefined)
          ? data.personCosts[name]
          : (COST_DEFAULTS[gType] ?? 0);
        const costColor = personCost > 0 ? '#A85C7A' : personCost < 0 ? '#7A8C3C' : '#b0a090';
        const card = document.createElement('div');
        card.className = 'person-card';
        card.draggable = true;
        card.dataset.name = name;
        card.innerHTML = `
          <span class="drag-handle" title="Drag to move">â ¿</span>
          <div class="person-name">
            ${escapeHtml(name)}
            ${isRegular ? '<span class="streak-badge">ğŸ”¥ regular</span>' : ''}
          </div>
          <input type="number" class="cost-input" title="Token cost per convo (+drains / âˆ’restores)"
            value="${personCost}" min="-10" max="10" step="1" style="color:${costColor}"/>
          <div class="person-count" id="cnt-${CSS.escape(name)}">${count}</div>
          <button class="tap-btn" title="Log conversation">+1</button>
          <button class="delete-btn" title="Remove">âœ•</button>
        `;
        card.querySelector('.tap-btn').addEventListener('click',    () => increment(name));
        card.querySelector('.delete-btn').addEventListener('click', () => removePerson(name, group.id));
        card.querySelector('.cost-input').addEventListener('change', e => {
          const val = Math.max(-10, Math.min(10, parseInt(e.target.value) || 0));
          e.target.value = val;
          e.target.style.color = val > 0 ? '#A85C7A' : val < 0 ? '#7A8C3C' : '#b0a090';
          const d = loadData();
          if (!d.personCosts) d.personCosts = {};
          d.personCosts[name] = val;
          saveData(d);
        });
        card.addEventListener('dragstart', e => {
          dragState = { name, fromGroupId: group.id };
          e.dataTransfer.effectAllowed = 'move';
          requestAnimationFrame(() => card.classList.add('dragging'));
        });
        card.addEventListener('dragend', () => card.classList.remove('dragging'));
        body.appendChild(card);
      });

      const addRow = document.createElement('div');
      addRow.className = 'add-person-row';
      const input = document.createElement('input');
      input.className = 'add-person-input';
      input.type = 'text';
      input.maxLength = 40;
      input.placeholder = '+ Add person...';
      input.addEventListener('keydown', e => { if (e.key === 'Enter') { addPerson(group.id, input); e.preventDefault(); } });
      input.addEventListener('blur',    () => { if (input.value.trim()) addPerson(group.id, input); });
      addRow.appendChild(input);
      body.appendChild(addRow);

      section.appendChild(body);
      container.appendChild(section);
    });

    document.getElementById('total-count').textContent = grandTotal;
    renderCrowd(data);
    renderHistory(data);
    updateCandleVisual(data);
    updateCandlePhase(data);
    updateHoroscope(data);
  }

  // â”€â”€ Drag & Drop â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function onDrop(e, toGroupId) {
    e.preventDefault();
    document.querySelectorAll('.group-body').forEach(b => b.classList.remove('drag-over'));
    if (!dragState || dragState.fromGroupId === toGroupId) { dragState = null; return; }

    const data = loadData();
    const from = data.groups.find(g => g.id === dragState.fromGroupId);
    const to   = data.groups.find(g => g.id === toGroupId);
    if (from && to) {
      from.people = from.people.filter(p => p !== dragState.name);
      to.people.push(dragState.name);
      saveData(data);
    }
    dragState = null;
    render();
  }

  // â”€â”€ Actions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function addPerson(groupId, inputEl) {
    const name = inputEl.value.trim();
    if (!name) return;
    const data = loadData();
    if (getAllPeople(data).some(p => p.toLowerCase() === name.toLowerCase())) {
      inputEl.style.color = '#e55';
      inputEl.value = '';
      setTimeout(() => inputEl.style.color = '', 800);
      return;
    }
    const group = data.groups.find(g => g.id === groupId);
    if (group) { group.people.push(name); saveData(data); inputEl.value = ''; render(); }
  }

  function increment(name) {
    const data = loadData();
    const today = todayStr();
    if (!data.days[today]) data.days[today] = {};
    const wasZero = (data.days[today][name] || 0) === 0;
    data.days[today][name] = (data.days[today][name] || 0) + 1;
    saveData(data);

    const count = data.days[today][name];

    // Update count display in list
    const countEl = document.getElementById('cnt-' + CSS.escape(name));
    if (countEl) {
      countEl.textContent = count;
      countEl.classList.remove('bump');
      void countEl.offsetWidth;
      countEl.classList.add('bump');
    }

    // Update group total label
    const group = data.groups.find(g => g.people.includes(name));
    if (group) {
      const gTotal = group.people.reduce((s,n) => s + (data.days[today][n] || 0), 0);
      const sec = document.querySelector(`.group-section[data-group-id="${group.id}"]`);
      if (sec) { const b = sec.querySelector('.group-total b'); if (b) b.textContent = gTotal; }
    }

    // Update grand total
    const grandTotal = getAllPeople(data).reduce((s,n) => s + (data.days[today][n] || 0), 0);
    document.getElementById('total-count').textContent = grandTotal;

    // Update crowd
    if (wasZero) {
      // New person walks in
      const canvas = document.getElementById('crowd-canvas');
      const W = canvas.offsetWidth  || 480;
      const H = canvas.offsetHeight || 260;
      const idx = canvas.querySelectorAll('.crowd-avatar').length;
      const color = (group && group.color) || GROUP_COLORS[0];
      addAvatarToCanvas(name, idx, 1, color, true, W, H, group ? getGroupType(group) : 'neutral');
    } else {
      // Existing person pulses and grows
      pulseAvatar(name, count);
    }

    updateCrowdLabel(grandTotal);

    // Token update based on per-person cost
    const groupType = group ? getGroupType(group) : 'neutral';
    const todayTd = data.tokenDays && data.tokenDays[today];
    if (todayTd) {
      const cost = getPersonCost(name, groupType, data);
      if (cost !== 0) {
        todayTd.current = Math.max(0, Math.min(todayTd.dailyMax, todayTd.current - cost));
        saveData(data);
        updateCandleVisual(data);
        triggerFlameAnimation(cost > 0 ? 'work' : 'friend');
      }
    }
  }

  function removePerson(name, groupId) {
    const data = loadData();
    const group = data.groups.find(g => g.id === groupId);
    if (group) {
      group.people = group.people.filter(p => p !== name);
      data.regulars = data.regulars.filter(r => r !== name);
      saveData(data);
      render();
    }
  }

  function addGroup() {
    const data = loadData();
    const color = GROUP_COLORS[data.groups.length % GROUP_COLORS.length];
    data.groups.push({ id: uid(), name: 'New Group', people: [], color, type: 'neutral' });
    saveData(data);
    render();
    const nameEls = document.querySelectorAll('.group-name[contenteditable]');
    const last = nameEls[nameEls.length - 1];
    if (last) {
      last.focus();
      const range = document.createRange();
      range.selectNodeContents(last);
      const sel = window.getSelection();
      sel.removeAllRanges();
      sel.addRange(range);
    }
  }

  function deleteGroup(groupId) {
    const data = loadData();
    const group = data.groups.find(g => g.id === groupId);
    if (!group) return;
    if (group.people.length > 0 &&
        !confirm(`Delete "${group.name}" and remove its ${group.people.length} ${group.people.length===1?'person':'people'}?`)) return;
    data.groups = data.groups.filter(g => g.id !== groupId);
    saveData(data);
    render();
  }

  function resetCounts() {
    if (!confirm("Reset today's conversation counts and candle to 0?")) return;
    const data = loadData();
    const today = todayStr();
    if (data.days[today]) Object.keys(data.days[today]).forEach(k => data.days[today][k] = 0);
    if (data.tokenDays && data.tokenDays[today]) {
      const td = data.tokenDays[today];
      td.current = td.dailyMax;
    }
    saveData(data);
    render();
  }

  // â”€â”€ History â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function renderHistory(data) {
    const el = document.getElementById('history-list');
    const today = todayStr();
    const pastDays = Object.keys(data.days).filter(d => d !== today).sort((a,b) => b.localeCompare(a));

    if (pastDays.length === 0) {
      el.innerHTML = '<div class="history-empty">No history yet.</div>';
      return;
    }

    el.innerHTML = '';
    pastDays.forEach(dateStr => {
      const counts = data.days[dateStr];
      const total = Object.values(counts).reduce((s,v) => s+v, 0);
      const rows = Object.entries(counts)
        .filter(([,c]) => c > 0)
        .sort((a,b) => b[1]-a[1])
        .map(([name,count]) =>
          `<div class="history-row"><span class="h-name">${escapeHtml(name)}</span><span class="h-count">${count}</span></div>`
        ).join('');

      const dayEl = document.createElement('div');
      dayEl.className = 'history-day';
      dayEl.innerHTML = `
        <div class="history-day-header" onclick="toggleDay(this)">
          <div class="history-day-date">${formatDate(dateStr)}</div>
          <div class="history-day-right">
            <div class="history-day-total"><span>${total}</span> conversations</div>
            <span class="history-chevron">â–¼</span>
          </div>
        </div>
        <div class="history-day-detail">
          ${rows || '<div style="color:#ccc;font-size:13px;padding:4px 0">No conversations logged.</div>'}
        </div>
      `;
      el.appendChild(dayEl);
    });
  }

  function toggleDay(header) {
    header.nextElementSibling.classList.toggle('open');
    header.querySelector('.history-chevron').classList.toggle('open');
  }

  function toggleHistory() {
    const list   = document.getElementById('history-list');
    const toggle = document.getElementById('history-toggle');
    const isOpen = list.style.display !== 'none';
    list.style.display = isOpen ? 'none' : 'flex';
    toggle.classList.toggle('open', !isOpen);
  }

  function formatDate(dateStr) {
    const d = new Date(dateStr + 'T00:00:00');
    const yesterday = new Date();
    yesterday.setDate(yesterday.getDate() - 1);
    if (dateStr === yesterday.toLocaleDateString('en-CA')) return 'Yesterday';
    return d.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
  }

  // â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  document.getElementById('today-date').textContent = new Date().toLocaleDateString('en-US', {
    weekday: 'short', month: 'short', day: 'numeric'
  });

  render();

  // Daily token suggestion on first open
  const _initData = loadData();
  checkDailySuggestion(_initData);
</script>
</body>
</html>
